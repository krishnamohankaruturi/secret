<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.StudentTrackerBandMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.StudentTrackerBand">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 19 12:00:48 CST 2015.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="studenttrackerid" jdbcType="BIGINT" property="studentTrackerId" />
    <result column="complexitybandid" jdbcType="BIGINT" property="complexityBandId" />
    <result column="testsessionid" jdbcType="BIGINT" property="testSessionId" />
    <result column="source" jdbcType="VARCHAR" property="source" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="createduser" jdbcType="BIGINT" property="createdUser" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="modifieduser" jdbcType="BIGINT" property="modifiedUser" />
    <result column="essentialelementid" jdbcType="BIGINT" property="essentialElementId" />
    <result column="operationalwindowid" jdbcType="BIGINT" property="operationalWindowId" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 19 12:00:48 CST 2015.
    -->
    id, studenttrackerid, complexitybandid, testsessionid, source, activeflag, createddate, 
    createduser, modifieddate, modifieduser, essentialelementid, operationalwindowid
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 19 12:00:48 CST 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from studenttrackerband
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.StudentTrackerBand">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 19 12:00:48 CST 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('studenttrackerband_id_seq')
    </selectKey>
    insert into studenttrackerband (id, studenttrackerid, complexitybandid, 
      testsessionid, source, activeflag, 
      createddate, createduser, modifieddate, 
      modifieduser, essentialelementid, operationalwindowid
      )
    values (#{id,jdbcType=BIGINT}, #{studentTrackerId,jdbcType=BIGINT}, #{complexityBandId,jdbcType=BIGINT}, 
      #{testSessionId,jdbcType=BIGINT}, #{source,jdbcType=VARCHAR}, #{activeFlag,jdbcType=BIT}, 
      #{createdDate,jdbcType=TIMESTAMP}, #{createdUser,jdbcType=BIGINT}, #{modifiedDate,jdbcType=TIMESTAMP}, 
      #{modifiedUser,jdbcType=BIGINT}, #{essentialElementId,jdbcType=BIGINT}, #{operationalWindowId,jdbcType=BIGINT}
      )
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.StudentTrackerBand">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 19 12:00:48 CST 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('studenttrackerband_id_seq')
    </selectKey>
    insert into studenttrackerband
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="studentTrackerId != null">
        studenttrackerid,
      </if>
      <if test="complexityBandId != null">
        complexitybandid,
      </if>
      <if test="testSessionId != null">
        testsessionid,
      </if>
      <if test="source != null">
        source,
      </if>
      <if test="activeFlag != null">
        activeflag,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="createdUser != null">
        createduser,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
      <if test="modifiedUser != null">
        modifieduser,
      </if>
      <if test="essentialElementId != null">
        essentialelementid,
      </if>
      <if test="operationalWindowId != null">
        operationalwindowid,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="studentTrackerId != null">
        #{studentTrackerId,jdbcType=BIGINT},
      </if>
      <if test="complexityBandId != null">
        #{complexityBandId,jdbcType=BIGINT},
      </if>
      <if test="testSessionId != null">
        #{testSessionId,jdbcType=BIGINT},
      </if>
      <if test="source != null">
        #{source,jdbcType=VARCHAR},
      </if>
      <if test="activeFlag != null">
        #{activeFlag,jdbcType=BIT},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createdUser != null">
        #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedUser != null">
        #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="essentialElementId != null">
        #{essentialElementId,jdbcType=BIGINT},
      </if>
      <if test="operationalWindowId != null">
        #{operationalWindowId,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.StudentTrackerBand">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 19 12:00:48 CST 2015.
    -->
    update studenttrackerband
    <set>
      <if test="studentTrackerId != null">
        studenttrackerid = #{studentTrackerId,jdbcType=BIGINT},
      </if>
      <if test="complexityBandId != null">
        complexitybandid = #{complexityBandId,jdbcType=BIGINT},
      </if>
      <if test="testSessionId != null">
        testsessionid = #{testSessionId,jdbcType=BIGINT},
      </if>
      <if test="source != null">
        source = #{source,jdbcType=VARCHAR},
      </if>
      <if test="activeFlag != null">
        activeflag = #{activeFlag,jdbcType=BIT},
      </if>
      <if test="createdDate != null">
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createdUser != null">
        createduser = #{createdUser,jdbcType=BIGINT},
      </if>

        modifieddate = now(),

      <if test="modifiedUser != null">
        modifieduser = #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="essentialElementId != null">
        essentialelementid = #{essentialElementId,jdbcType=BIGINT},
      </if>
      <if test="operationalWindowId != null">
        operationalwindowid = #{operationalWindowId,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.StudentTrackerBand">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 19 12:00:48 CST 2015.
    -->
    update studenttrackerband
    set studenttrackerid = #{studentTrackerId,jdbcType=BIGINT},
      complexitybandid = #{complexityBandId,jdbcType=BIGINT},
      testsessionid = #{testSessionId,jdbcType=BIGINT},
      source = #{source,jdbcType=VARCHAR},
      activeflag = #{activeFlag,jdbcType=BIT},
      createddate = #{createdDate,jdbcType=TIMESTAMP},
      createduser = #{createdUser,jdbcType=BIGINT},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      modifieduser = #{modifiedUser,jdbcType=BIGINT},
      essentialelementid = #{essentialElementId,jdbcType=BIGINT},
      operationalwindowid = #{operationalWindowId,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>

	<resultMap extends="BaseResultMap" id="ExBaseResultMap" type="edu.ku.cete.domain.StudentTrackerBand">
    	<result column="essentialelementcode" jdbcType="VARCHAR" property="essentialElementCode" />	
		<result column="teststatus" jdbcType="VARCHAR" property="testStatus" />
		<result column="contentareacode" jdbcType="VARCHAR" property="contentAreaCode" />
		<result column="studentstestsid" jdbcType="BIGINT" property="studentTestId" />
		<result column="criterianumber" jdbcType="BIGINT" property="criteriaNumber"/>
	</resultMap>
	  
  <select id="selectLatestWithTestSessionByStudentTracker" resultMap="ExBaseResultMap">
    select 
    stb.id, stb.studenttrackerid, stb.complexitybandid, stb.testsessionid, stb.source, stb.activeflag, stb.createddate, 
    stb.createduser, stb.modifieddate, stb.modifieduser, stb.essentialelementid, bpee.essentialelement as essentialelementcode, bp.criteria as criterianumber
    from studenttrackerband stb
    inner join studentstests sts on sts.testsessionid=stb.testsessionid and sts.activeflag=true
    inner join testsession ts on ts.id=sts.testsessionid and ts.activeflag=true
    left join blueprintessentialelements bpee on bpee.essentialelementid = stb.essentialelementid
    left join blueprint bp on bp.id = bpee.blueprintid and bp.activeflag is true
    where studenttrackerid = #{studentTrackerId,jdbcType=BIGINT} and stb.activeflag=true
    and stb.operationalwindowid  = #{operationalWindowId,jdbcType=BIGINT}
    order by stb.id desc limit 1
  </select>
  
  <select id="selectLatestByStudentTracker" resultMap="BaseResultMap">
    select <include refid="Base_Column_List" />
    from studenttrackerband 
    where studenttrackerid = #{studentTrackerId,jdbcType=BIGINT} and activeflag=true
    order by id desc limit 1
  </select>  
  
  <select id="selectByStudentId" resultMap="ExBaseResultMap">
  	select stb.*,ct.categorycode as teststatus,sts.id as studentstestsid,ca.abbreviatedname as contentareacode 
  	from studenttrackerband stb
	inner join studenttracker st on st.id=stb.studenttrackerid and st.activeflag=true
	inner join contentarea ca on ca.id=st.contentareaid and ca.activeflag=true
	left join studentstests sts on sts.testsessionid=stb.testsessionid and sts.activeflag=true
	left join category ct on ct.id=sts.status and ct.activeflag=true
	where stb.activeflag=true and st.studentid = #{studentId,jdbcType=BIGINT}
  </select>  
  
  <select id="selectByStudentIdWithActiveOTW" resultMap="ExBaseResultMap">
  	select stb.*,null as teststatus,null as studentstestsid,ca.abbreviatedname as contentareacode 
  	from studenttrackerband stb
	inner join studenttracker st on st.id=stb.studenttrackerid and st.activeflag=true
	inner join contentarea ca on ca.id=st.contentareaid and ca.activeflag=true
	where stb.testsessionid is null and 
		stb.activeflag=true and st.studentid = #{studentId,jdbcType=BIGINT}		
	union 	
  	select stb.*,ct.categorycode as teststatus,sts.id as studentstestsid,ca.abbreviatedname as contentareacode 
  	from studenttrackerband stb
	inner join studenttracker st on st.id=stb.studenttrackerid and st.activeflag=true
	inner join contentarea ca on ca.id=st.contentareaid and ca.activeflag=true
	inner join studentstests sts on sts.testsessionid=stb.testsessionid and sts.activeflag=true
	    inner join testsession ts on sts.testsessionid = ts.id
	    inner join operationaltestwindow otw 
		on (otw.id = ts.operationaltestwindowid and (otw.effectivedate &lt;= now() and now() &lt;= otw.expirydate))	
	inner join category ct on ct.id=sts.status and ct.activeflag=true
	where stb.activeflag=true and st.studentid = #{studentId,jdbcType=BIGINT}
  </select>  
  
  <select id="countBandsByStudentTracker" resultType="java.lang.Integer">
	select count(stb.id) from studenttrackerband stb
	inner join studentstests st on stb.testsessionid=st.testsessionid
    inner join testsession ts on ts.id=st.testsessionid and ts.activeflag=true
	where stb.activeflag is true and st.activeflag is true
		and stb.studenttrackerid=#{studentTrackerId,jdbcType=BIGINT}
		and stb.operationalwindowid = #{operationalWindowId,jdbcType=BIGINT}
  </select>
  
  <select id="selectEEsByStudentTracker" resultType="java.lang.String">
	select distinct cfd.contentcode from studenttrackerband stb
	inner join studentstests st on stb.testsessionid=st.testsessionid
	inner join contentframeworkdetail cfd on cfd.id=stb.essentialelementid and cfd.activeflag=true
	 inner join testsession ts on ts.id=st.testsessionid and ts.activeflag=true
	where stb.activeflag is true and st.activeflag is true
		and stb.studenttrackerid=#{studentTrackerId,jdbcType=BIGINT}
		and stb.operationalwindowid = #{operationalWindowId,jdbcType=BIGINT}
  </select>
  
  <update id="inactiveByIds" parameterType="java.util.Map">
	update studenttrackerband set activeflag=false,modifieddate=CURRENT_TIMESTAMP,modifieduser=#{userId,jdbcType=BIGINT} where id in 
	<foreach close=")" collection="studentTrackerBandIds" item="studentTrackerBandId" open="(" separator=",">
		#{studentTrackerBandId}
	</foreach> 
  </update>  
  
  <update id="reactivateByIds" parameterType="java.util.Map">
	update studenttrackerband set activeflag=true,modifieddate=CURRENT_TIMESTAMP,modifieduser=#{userId,jdbcType=BIGINT} where id in 
	<foreach close=")" collection="studentTrackerBandIds" item="studentTrackerBandId" open="(" separator=",">
		#{studentTrackerBandId}
	</foreach> 
  </update>  
  
  <update id="clearTestSessionByStudentIdAndTestSessionId">
  	update studenttrackerband stb set testsessionid=null,modifieddate=CURRENT_TIMESTAMP
  	<if test="userId != null">
  		,modifieduser=#{userId,jdbcType=BIGINT}
  	</if> 
  	from studenttracker st where st.id=stb.studenttrackerid 
  	and st.studentid=#{studentId,jdbcType=BIGINT} and stb.testsessionid=#{testSessionId,jdbcType=BIGINT};
  </update>    
  
  <select id="findStudentTrackerBandsByStudentAndTestSession" resultType="Long">
  	select stb.id
  	from studenttrackerband stb 
  	join studenttracker st on stb.studenttrackerid = st.id
	where stb.activeflag = #{activeFlag} and st.studentid = #{studentId} 
	and	testsessionid in 
		<foreach collection="testSessionIds" item="testSessionId" open="(" close=")" separator="," >
			#{testSessionId}
		</foreach>
  </select>  
  <select id="getBandsForStudentAndContentArea" resultType="Long">
  		select distinct stb.id
		from studenttracker st 
		join studenttrackerband stb on stb.studenttrackerid=st.id 
		where st.studentid=#{studentId} and st.contentareaid=#{contentAreaId} and stb.activeflag is true
		order by stb.id
  </select>
  <select id="selectByPrimaryKeys" parameterType="java.util.List" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from studenttrackerband
    where id in
    	<foreach collection="studentTrackerIds" item="studentTrackerId" open="(" close=")" separator="," >
			#{studentTrackerId}
		</foreach>
  </select>
  
  <select id="getStudentTrackerBandByFieldTestEEs" resultMap="ExBaseResultMap">
  select distinct str.id as studentstestsid, stb.complexitybandid 
  from studenttracker str
  join studenttrackerband stb on stb.studenttrackerid = str.id
  join studenttrackerblueprintstatus stbs on stbs.studenttrackerid = str.id
  join studentstests st on st.testsessionid = stb.testsessionid
  join testsession ts on ts.id = stb.testsessionid
  join studentstestsections sts on sts.studentstestid = st.id
  join testsectionstaskvariants tstv on tstv.testsectionid = sts.testsectionid
  join taskvariantcontentframeworkdetail tvcf on tvcf.taskvariantid = tstv.taskvariantid
  join contentframeworkdetail cfd on tvcf.contentframeworkdetailid = cfd.id
  WHERE stb.activeflag is true and st.activeflag is true and sts.activeflag is true and ts.activeflag is true
      and st.status = (select id from category where categorycode = 'complete' and categorytypeid  = (select id from categorytype where typecode = 'STUDENT_TEST_STATUS'))
	  and str.id = #{studentTrackerId}
      and cfd.id in
      	<foreach collection="listOfContentCodesInFieldTests" item="essentialElement" open="(" close=")" separator=",">
      		#{essentialElement.id}
      	</foreach>
  </select> 
</mapper>