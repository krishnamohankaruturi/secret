<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.TestSpecificationMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.TestSpecification">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 05 18:16:51 CST 2015.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="externalid" jdbcType="BIGINT" property="externalId" />
    <result column="createdate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="specificationname" jdbcType="VARCHAR" property="specificationName" />
    <result column="phase" jdbcType="VARCHAR" property="phase" />
    <result column="contentpool" jdbcType="VARCHAR" property="contentPool" />
    <result column="minimumnumberofees" jdbcType="INTEGER" property="minimumNumberOfEEs" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 05 18:16:51 CST 2015.
    -->
    id, externalid, createdate, modifieddate, specificationname, phase, contentpool, 
    minimumnumberofees, activeflag
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 05 18:16:51 CST 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from testspecification
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.TestSpecification">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 05 18:16:51 CST 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('testspecification_id_seq')
    </selectKey>
    insert into testspecification (id, externalid, createdate, 
      modifieddate, specificationname, phase, 
      contentpool, minimumnumberofees, activeflag
      )
    values (#{id,jdbcType=BIGINT}, #{externalId,jdbcType=BIGINT}, #{createdDate,jdbcType=TIMESTAMP}, 
      #{modifiedDate,jdbcType=TIMESTAMP}, #{specificationName,jdbcType=VARCHAR}, #{phase,jdbcType=VARCHAR}, 
      #{contentPool,jdbcType=VARCHAR}, #{minimumNumberOfEEs,jdbcType=INTEGER}, #{activeFlag,jdbcType=BIT}
      )
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.TestSpecification">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 05 18:16:51 CST 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('testspecification_id_seq')
    </selectKey>
    insert into testspecification
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="externalId != null">
        externalid,
      </if>
      <if test="createdDate != null">
        createdate,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
      <if test="specificationName != null">
        specificationname,
      </if>
      <if test="phase != null">
        phase,
      </if>
      <if test="contentPool != null">
        contentpool,
      </if>
      <if test="minimumNumberOfEEs != null">
        minimumnumberofees,
      </if>
      <if test="activeFlag != null">
        activeflag,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="externalId != null">
        #{externalId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="specificationName != null">
        #{specificationName,jdbcType=VARCHAR},
      </if>
      <if test="phase != null">
        #{phase,jdbcType=VARCHAR},
      </if>
      <if test="contentPool != null">
        #{contentPool,jdbcType=VARCHAR},
      </if>
      <if test="minimumNumberOfEEs != null">
        #{minimumNumberOfEEs,jdbcType=INTEGER},
      </if>
      <if test="activeFlag != null">
        #{activeFlag,jdbcType=BIT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.TestSpecification">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 05 18:16:51 CST 2015.
    -->
    update testspecification
    <set>
      <if test="externalId != null">
        externalid = #{externalId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        createdate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null">
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="specificationName != null">
        specificationname = #{specificationName,jdbcType=VARCHAR},
      </if>
      <if test="phase != null">
        phase = #{phase,jdbcType=VARCHAR},
      </if>
      <if test="contentPool != null">
        contentpool = #{contentPool,jdbcType=VARCHAR},
      </if>
      <if test="minimumNumberOfEEs != null">
        minimumnumberofees = #{minimumNumberOfEEs,jdbcType=INTEGER},
      </if>
      <if test="activeFlag != null">
        activeflag = #{activeFlag,jdbcType=BIT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.TestSpecification">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 05 18:16:51 CST 2015.
    -->
    update testspecification
    set externalid = #{externalId,jdbcType=BIGINT},
      createdate = #{createdDate,jdbcType=TIMESTAMP},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      specificationname = #{specificationName,jdbcType=VARCHAR},
      phase = #{phase,jdbcType=VARCHAR},
      contentpool = #{contentPool,jdbcType=VARCHAR},
      minimumnumberofees = #{minimumNumberOfEEs,jdbcType=INTEGER},
      activeflag = #{activeFlag,jdbcType=BIT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="findByStudentTracker" parameterType="java.lang.Long" resultMap="BaseResultMap">
	select distinct ts.id, ts.externalid, ts.createdate, ts.modifieddate, ts.specificationname, 
		ts.phase, ts.contentpool, ts.minimumnumberofees, ts.activeflag
	  from studenttrackerband stb
		inner join studentstests sts on stb.testsessionid=sts.testsessionid
		inner join testsession tss on tss.id=sts.testsessionid and tss.activeflag=true
		inner join test t on sts.testid=t.id
		inner join testspecification ts on t.testspecificationid=ts.id
	where stb.activeflag is true 
		and stb.operationalwindowid = #{operationalWindowId}
		and stb.studenttrackerid=#{studentTrackerId,jdbcType=BIGINT} 		
  </select>
  
  <resultMap id="ExBaseResultMap" type="edu.ku.cete.domain.TestSpecification" extends="BaseResultMap">
  	<result column="gradecourseid" jdbcType="BIGINT" property="gradeCourseId" />
    <result column="gradebandid" jdbcType="BIGINT" property="gradeBandId" />
    <result column="courseid" jdbcType="BIGINT" property="courseId" />
    <result column="contentareaid" jdbcType="BIGINT" property="contentAreaId" />
  </resultMap>
  
  <select id="findByPoolGradBandContentArea" resultMap="ExBaseResultMap">
	select distinct ts.id, ts.externalid, ts.createdate, ts.modifieddate, ts.specificationname, 
		ts.phase, ts.contentpool, ts.minimumnumberofees, ts.activeflag,
		tc.gradebandid,tc.gradecourseid,tc.courseid,tc.contentareaid
	from test t 
		inner join testcollectionstests tct on t.id=tct.testid 
		inner join testcollection tc on tc.id=tct.testcollectionid
		inner join testspecification ts on t.testspecificationid = ts.id and ts.activeflag is true
		inner join gradeband gb on tc.gradebandid = gb.id
		inner join gradebandgradecourse gbgc on gbgc.gradebandid = tc.gradebandid
		inner join gradecourse gc on gbgc.gradecourseid = gc.id
		inner join category tstatus on t.status = tstatus.id
		inner join assessmentstestcollections atc on atc.testcollectionid=tc.id
		inner join assessment a on atc.assessmentid = a.id
		inner join testingprogram tp on a.testingprogramid = tp.id
		inner join assessmentprogram ap on tp.assessmentprogramid=ap.id
		inner join operationaltestwindowstestcollections otwtc on otwtc.testcollectionid = tc.id and otwtc.activeflag is true
	    inner join operationaltestwindowsessionrule otwsr ON otwsr.operationaltestwindowid = otwtc.operationaltestwindowid and otwsr.activeflag is true
		inner join operationaltestwindow otw on otw.id = otwsr.operationaltestwindowid
		inner join category srule on otwsr.sessionruleid = srule.id
	where tc.courseid is null and tstatus.categorycode='DEPLOYED' and t.qccomplete is true
		and tc.randomizationtype = 'enrollment' and tp.programabbr ='S' and ap.abbreviatedname='DLM'
		and srule.categorycode='SYSTEM_DEFINED_ENROLLMENT_TO_TEST'
		and tc.phasetype = 'EOY' and tc.pooltype=#{poolType} 
		and gc.abbreviatedName=#{gradeOrCourseCode} and tc.contentareaid=#{contentAreaId}
		and otw.id = #{operationalWindowId} 
		order by ts.id limit 1
  </select>
  <select id="findByPoolGradeOrCourseContentArea" resultMap="ExBaseResultMap">
	select distinct ts.id, ts.externalid, ts.createdate, ts.modifieddate, ts.specificationname, 
		ts.phase, ts.contentpool, ts.minimumnumberofees, ts.activeflag,
		tc.gradebandid,tc.gradecourseid,tc.courseid,tc.contentareaid
	from test t 
		inner join testcollectionstests tct on t.id=tct.testid 
		inner join testcollection tc on tc.id=tct.testcollectionid
		inner join testspecification ts on t.testspecificationid = ts.id and ts.activeflag is true
		<if test="poolType != 'MULTIEEOFC'">
		inner join gradecourse gc on tc.gradecourseid = gc.id
		</if>
		<if test="poolType == 'MULTIEEOFC'">
		inner join gradecourse gc on tc.courseid = gc.id
		</if>
		inner join category tstatus on t.status = tstatus.id
		inner join assessmentstestcollections atc on atc.testcollectionid=tc.id
		inner join assessment a on atc.assessmentid = a.id
		inner join testingprogram tp on a.testingprogramid = tp.id
		inner join assessmentprogram ap on tp.assessmentprogramid=ap.id
		inner join operationaltestwindowstestcollections otwtc on otwtc.testcollectionid = tc.id and otwtc.activeflag is true
	    inner join operationaltestwindowsessionrule otwsr ON otwsr.operationaltestwindowid = otwtc.operationaltestwindowid and otwsr.activeflag is true
		inner join operationaltestwindow otw on otw.id = otwsr.operationaltestwindowid
		inner join category srule on otwsr.sessionruleid = srule.id
	where tstatus.categorycode='DEPLOYED' and t.qccomplete is true
		and tc.randomizationtype = 'enrollment' and tp.programabbr ='S' and ap.abbreviatedname='DLM'
		and srule.categorycode='SYSTEM_DEFINED_ENROLLMENT_TO_TEST'
		and tc.phasetype = 'EOY' and tc.pooltype=#{poolType} 
		and gc.abbreviatedName=#{gradeOrCourseCode} and tc.contentareaid=#{contentAreaId} 
		and otw.id = #{operationalWindowId} 
		order by ts.id limit 1
  </select>
   <select id="findByTestSpecAndRanking" resultType="java.lang.String">
	select cfd.contentcode from lmassessmentmodelrule lar 
		inner join contentframeworkdetail cfd on lar.contentframeworkdetailid=cfd.id
		where lar.testspecificationid=#{testSpecificationId,jdbcType=BIGINT} 
		and lar.ranking=#{ranking,jdbcType=BIGINT} 
	order by cfd.contentcode,lar.contentcodecorder
  </select>
  
  <select id="checkIfYearEndEEisWritingType" resultType="java.lang.Integer">
	SELECT *
	FROM testspecification ts
		INNER JOIN test t ON t.testspecificationid = ts.id AND t.activeflag is true 
		INNER JOIN lmassessmentmodelrule lmr ON lmr.testspecificationid = ts.id
		INNER JOIN contentframeworkdetail cfd ON cfd.id = lmr.contentframeworkdetailid AND cfd.activeflag is true
	WHERE ts.activeflag
		AND t.id = #{testId,jdbcType=BIGINT} 
		and cfd.contentcode = #{eeCode,jdbcType=VARCHAR}
		and lmr.ranking = ts.minimumnumberofees
  </select>
  
  <select id="isWritingContentAvailableInTestSpecRank" parameterType="map" resultType="java.lang.Boolean" >
  	select lar.writingassessment from lmassessmentmodelrule lar 
		inner join contentframeworkdetail cfd on lar.contentframeworkdetailid=cfd.id
		where lar.testspecificationid=#{testSpecificationId,jdbcType=BIGINT} 
		and lar.ranking=#{ranking,jdbcType=BIGINT} 
	order by cfd.contentcode,lar.contentcodecorder limit 1
  </select>
  
</mapper>