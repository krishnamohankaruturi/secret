<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.student.survey.SurveyMapper">

  <resultMap id="AutoRegistrationResultMap" type="edu.ku.cete.domain.student.survey.DLMAutoRegistrationDTO">
    <id column="surveyid" jdbcType="BIGINT" property="surveyId" />
    <result column="studentid" jdbcType="BIGINT" property="studentId" />
    <result column="legalfirstname" jdbcType="VARCHAR" property="firstName" />
    <result column="legallastname" jdbcType="VARCHAR" property="lastName" />
    <result column="rosterid" jdbcType="BIGINT" property="rosterId" />
    <result column="finalelabandid" jdbcType="BIGINT" property="finalELABandId" />
    <result column="finalmathbandid" jdbcType="BIGINT" property="finalMathBandId" />
    <result column="abbreviatedname" jdbcType="VARCHAR" property="currentGradeLevelCode" />
  </resultMap>
  
  <sql id="Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    <where>
      <foreach collection="example.oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    id, studentid, surveyname, createddate, createduser, activeflag, modifieddate, modifieduser, 
    status
  </sql>
  <select id="selectByExample" parameterType="edu.ku.cete.domain.student.survey.SurveyExample" resultType="edu.ku.cete.domain.student.survey.Survey">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    from survey
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultType="edu.ku.cete.domain.student.survey.Survey">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    select 
    <include refid="Base_Column_List" />
    from survey
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    delete from survey
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <delete id="deleteByExample" parameterType="edu.ku.cete.domain.student.survey.SurveyExample">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    delete from survey
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="edu.ku.cete.domain.student.survey.Survey">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    insert into survey (id, studentid, surveyname, 
      createddate, createduser, activeflag, 
      modifieddate, modifieduser, status
      )
    values (#{id,jdbcType=BIGINT}, #{studentId,jdbcType=BIGINT}, #{surveyName,jdbcType=VARCHAR}, 
      #{createdDate,jdbcType=TIMESTAMP}, #{createduser,jdbcType=INTEGER}, #{activeFlag,jdbcType=BIT}, 
      #{modifiedDate,jdbcType=TIMESTAMP}, #{modifieduser,jdbcType=INTEGER}, #{statusId,jdbcType=BIGINT}
      )
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.student.survey.Survey">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    insert into survey
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="studentId != null">
        studentid,
      </if>
      <if test="surveyName != null">
        surveyname,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="createduser != null">
        createduser,
      </if>
      <if test="activeFlag != null">
        activeflag,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
      <if test="modifieduser != null">
        modifieduser,
      </if>
      <if test="statusId != null">
        status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="studentId != null">
        #{studentId,jdbcType=BIGINT},
      </if>
      <if test="surveyName != null">
        #{surveyName,jdbcType=VARCHAR},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createduser != null">
        #{createduser,jdbcType=INTEGER},
      </if>
      <if test="activeFlag != null">
        #{activeFlag,jdbcType=BIT},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifieduser != null">
        #{modifieduser,jdbcType=INTEGER},
      </if>
      <if test="statusId != null">
        #{statusId,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="edu.ku.cete.domain.student.survey.SurveyExample" resultType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    select count(*) from survey
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    update survey
    <set>
      <if test="record.id != null">
        id = #{record.id,jdbcType=BIGINT},
      </if>
      <if test="record.studentId != null">
        studentid = #{record.studentId,jdbcType=BIGINT},
      </if>
      <if test="record.surveyName != null">
        surveyname = #{record.surveyName,jdbcType=VARCHAR},
      </if>
      <if test="record.createdDate != null">
        createddate = #{record.createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.createduser != null">
        createduser = #{record.createduser,jdbcType=INTEGER},
      </if>
      <if test="record.activeFlag != null">
        activeflag = #{record.activeFlag,jdbcType=BIT},
      </if>
      <if test="record.modifiedDate != null">
        modifieddate = #{record.modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.modifieduser != null">
        modifieduser = #{record.modifieduser,jdbcType=INTEGER},
      </if>
      <if test="record.statusId != null">
        status = #{record.statusId,jdbcType=BIGINT},
      </if>
    </set>
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    update survey
    set id = #{record.id,jdbcType=BIGINT},
      studentid = #{record.studentId,jdbcType=BIGINT},
      surveyname = #{record.surveyName,jdbcType=VARCHAR},
      createddate = #{record.createdDate,jdbcType=TIMESTAMP},
      createduser = #{record.createduser,jdbcType=INTEGER},
      activeflag = #{record.activeFlag,jdbcType=BIT},
      modifieddate = #{record.modifiedDate,jdbcType=TIMESTAMP},
      modifieduser = #{record.modifieduser,jdbcType=INTEGER},
      status = #{record.statusId,jdbcType=BIGINT}
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.student.survey.Survey">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    update survey
    <set>
      <if test="studentId != null">
        studentid = #{studentId,jdbcType=BIGINT},
      </if>
      <if test="surveyName != null">
        surveyname = #{surveyName,jdbcType=VARCHAR},
      </if>
      <if test="createdDate != null">
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createduser != null">
        createduser = #{createduser,jdbcType=INTEGER},
      </if>
      <if test="activeFlag != null">
        activeflag = #{activeFlag,jdbcType=BIT},
      </if>
      <if test="modifiedDate != null">
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifieduser != null">
        modifieduser = #{modifieduser,jdbcType=INTEGER},
      </if>
      <if test="statusId != null">
        status = #{statusId,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.student.survey.Survey">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jan 25 22:21:48 CST 2014.
    -->
    update survey
    set studentid = #{studentId,jdbcType=BIGINT},
      surveyname = #{surveyName,jdbcType=VARCHAR},
      createddate = #{createdDate,jdbcType=TIMESTAMP},
      createduser = #{createduser,jdbcType=INTEGER},
      activeflag = #{activeFlag,jdbcType=BIT},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      modifieduser = #{modifieduser,jdbcType=INTEGER},
      status = #{statusId,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="findSurveysForBatchAutoRegistration" resultMap="AutoRegistrationResultMap">
	select distinct s.id as surveyid, s.studentid, st.legalfirstname, st.legallastname, st.finalelabandid, st.finalmathbandid, gc.abbreviatedname
	from survey s 
	join student st on s.studentid = st.id 
	join enrollment e on st.id = e.studentid
	join enrollmentsrosters er on er.enrollmentid = e.id
	join roster r on er.rosterid = r.id
	join gradecourse gc on e.currentgradelevel = gc.id
	join studentassessmentprogram sap on st.id = sap.studentid
	where e.currentschoolyear=#{currentSchoolYear, jdbcType=INTEGER} 	 
	and status = (select id from category where categorycode='COMPLETE' and categorytypeid = (select id from categorytype where typecode='SURVEY_STATUS'))
	and r.statesubjectareaid in (select id from contentarea where abbreviatedname in ('M', 'ELA'))
	--and (st.finalelabandid is not null and st.finalmathbandid is not null)
	and sap.assessmentprogramid = #{assessmentProgramId}
	and sap.activeflag = true
	and s.activeflag = true
	order by s.studentid
  </select>
  
  <select id="findStatusCodeByStudent" resultType="java.lang.String">
  	select categorycode from survey s inner join category sstatus on s.status=sstatus.id
	where s.studentid=#{studentId,jdbcType=BIGINT}  and s.activeflag is true
  </select>
  
  <resultMap id="studentSurveyJsonResponseMap" type="edu.ku.cete.domain.student.SurveyJson">
  	<result column="studentid" property="studentId" />
  	<result column="statestudentidentifier" property="stateStudentidentifier"/>
  	<result column="studentfirstname" property="studentFirstName"/>
  	<result column="studentlastname" property="studentLastName"/>
  	<result column="mathbandid" property="mathBandId"/>
  	<result column="finalmathbandid" property="finalMathBandId"/>
  	<result column="scibandid" property="sciBandId"/>
  	<result column="finalscibandid" property="finalSciBandId"/>
  	<result column="elabandid" property="elaBandId"/>
  	<result column="finalelabandid" property="finalElaBandId"/>
  	<result column="commbandid" property="commBandId"/>  	
  	<result column="surveyid" property="surveyId"/>
  	<result column="surveycreateddate" property="createdDate"/>
  	<result column="surveycreateduserid" property="createdUserId"/>
  	<result column="surveymodifieddate" property="modifiedDate"/>
  	<result column="surveymodifieduserid" property="modifiedUserId"/>
  	<result column="lasteditedoption" property="lastEditedOption"/>
  	<result column="includescienceflag" property="includeScienceFlag"/>
  	<result column="allquestionsflag" property="allQuestionsFlag"/>
  	<result column="surveystatus" property="surveyStatus"/>
  	<result column="surveyactiveflag" property="surveyActive"/>  	  	
  	<collection property="studentSurveySectionsJson" ofType="edu.ku.cete.domain.student.StudentSurveySectionsJson">
  		<result column="surveyid" property="surveyId"/>  		
  		<result column="surveysectionid" property="surveySectionId"/>
  		<result column="surveysectioncode" property="surveySectionCode"/> 
  		<result column="surveyparentsectioncode" property="parentSurveySectionCode"/>
  		<result column="parentsurveysectionid" property="parentSurvetSectionId"/>  		
  		<collection property="surevyPageJsons" ofType="edu.ku.cete.domain.student.SurveyPageJson">  			
  			<result column="surveysectionid" property="surveySectionId"/>
  			<result column="globalpagenum" property="globalPageNumber"/>
  			<result column="surveypageactiveflag" property="activeFlag"/>
  			<result column="issurveypagecompleted" property="isCompleted"/>
  			<result column="surveypagecreateddate" property="createdDate"/>
  			<result column="surveypagecreateduser" property="createdUser"/>
  			<result column="surveypagemodifieddate" property="modifiedDate"/>
  			<result column="surveypagemodifieduser" property="modifiedUser"/>  			
  			<collection property="studentSurveyResponsesJsons" ofType="edu.ku.cete.domain.student.StudentSurveyResponseJson">
  				<result column="globalpagenum" property="globalPageNumber"/>
  				<result column="labelnumber" property="labelNumber"/>
  				<result column="label" property="label"/>
  				<result column="surveylabeltype" property="labelType"/>
  				<result column="responseorder" property="responseOrder"/>
  				<result column="responsevalue" property="responseValue"/>
  				<result column="responselabel" property="responseLabel"/>
  				<result column="responsetext" property="responseText"/>
  				<result column="ssurveycreateddate" property="createdDate"/>
  				<result column="ssurveymodifieddate" property="modifiedDate"/>
  				<result column="ssurveymodifieduser" property="modifiedUserId"/>
  				<result column="ssurveycreateduser" property="createdUserId"/>
  				<result column="ssurveyresponseactiveflag" property="responseActiveFlag"/>  							
  			</collection>  			  			  		
  		</collection>  		
  	</collection>  	
 </resultMap>
 
  <select id = "getStudentAndSurveyValuesForJson" resultMap="studentSurveyJsonResponseMap">
  	select stu.id as studentid, stu.statestudentidentifier, stu.legalfirstname as studentfirstname, stu.legallastname as studentlastname,
     stu.mathbandid, stu.finalmathbandid, stu.scibandid, stu.finalscibandid, stu.elabandid, stu.finalelabandid, stu.commbandid,
     sur.id as surveyid, sur.createddate as surveycreateddate, sur.createduser as surveycreateduserid, sur.modifieddate as surveymodifieddate,
     sur.modifieduser as surveymodifieduserid, cateditoption.categorycode as lasteditedoption, sur.includescienceflag, sur.allquestionsflag, cat.categorycode as surveystatus, sur.activeflag as surveyactiveflag,
     ssec.id as surveysectionid, ssec.surveysectioncode, ssecp.surveysectioncode as surveyparentsectioncode,ssecp.id as parentsurveysectionid,  
     spgs.globalpagenum, spgs.activeflag as surveypageactiveflag, spgs.iscompleted as issurveypagecompleted,
     spgs.createddate as surveypagecreateddate, spgs.createduser as surveypagecreateduser, spgs.modifieddate as surveypagemodifieddate,
     spgs.modifieduser as surveypagemodifieduser,
     sl.labelnumber, sl.label, slcat.categorycode as surveylabeltype,
     sr.responseorder, sr.responsevalue,sr.responselabel, 
     ssr.responsetext,ssr.createddate as ssurveycreateddate, ssr.modifieddate as ssurveymodifieddate,
     ssr.modifieduser as ssurveymodifieduser, ssr.createduser as ssurveycreateduser, ssr.activeflag as ssurveyresponseactiveflag,
     sur.includeelaflag, sur.includemathflag
     from student stu join survey sur on stu.id = sur.studentid
     join studentsurveyresponse ssr on ssr.surveyid = sur.id     
     join surveyresponse sr on sr.id = ssr.surveyresponseid
     join surveylabel sl on sl.id = sr.labelid     
     join surveysection ssec on ssec.id = sl.surveysectionid
     join category cat on cat.id = sur.status
     join category slcat on slcat.id = sl.labeltype
     join surveysection ssecp on ssecp.id = ssec.parentsurveysectionid
     join surveypagestatus spgs on spgs.surveyid = sur.id and spgs.globalpagenum = sl.globalpagenum
     join category cateditoption on cateditoption.id = sur.lasteditedoption
     where sur.id = #{surveyId}     
          
  </select>
  
  <select id = "getSurveyStatusJson" resultMap="studentSurveyJsonResponseMap">
  	select stu.id as studentid, stu.statestudentidentifier, stu.legalfirstname as studentfirstname, stu.legallastname as studentlastname,
     stu.mathbandid, stu.finalmathbandid, stu.scibandid, stu.finalscibandid, stu.elabandid, stu.finalelabandid, stu.commbandid,
     sur.id as surveyid, sur.createddate as surveycreateddate, sur.createduser as surveycreateduserid, sur.modifieddate as surveymodifieddate,
     sur.modifieduser as surveymodifieduserid, cateditoption.categorycode as lasteditedoption, sur.includescienceflag, sur.allquestionsflag, cat.categorycode as surveystatus, sur.activeflag as surveyactiveflag,
     sur.includeelaflag, sur.includemathflag    
     from student stu join survey sur on stu.id = sur.studentid     
     join category cat on cat.id = sur.status         
     join category cateditoption on cateditoption.id = sur.lasteditedoption
     where sur.id = #{surveyId}          
  </select>
  
  <select id = "getSurveyStatusJsonByPage" resultMap="studentSurveyJsonResponseMap">
  	select stu.id as studentid, stu.statestudentidentifier, stu.legalfirstname as studentfirstname, stu.legallastname as studentlastname,
     stu.mathbandid, stu.finalmathbandid, stu.scibandid, stu.finalscibandid, stu.elabandid, stu.finalelabandid, stu.commbandid,
     sur.id as surveyid, sur.createddate as surveycreateddate, sur.createduser as surveycreateduserid, sur.modifieddate as surveymodifieddate,
     sur.modifieduser as surveymodifieduserid, cateditoption.categorycode as lasteditedoption, sur.includescienceflag, 
     sur.allquestionsflag, cat.categorycode as surveystatus, sur.activeflag as surveyactiveflag,
     sur.includeelaflag, sur.includemathflag, ssec.id as surveysectionid, ssec.surveysectioncode
     from student stu 
     join survey sur on stu.id = sur.studentid and stu.activeflag is true and sur.activeflag is true
     join category cat on cat.id = sur.status and cat.activeflag is true
     join category cateditoption on cateditoption.id = sur.lasteditedoption and cateditoption.activeflag is true
     left outer join surveypagestatus sps on sps.surveyid = sur.id and sps.activeflag is true
     inner join surveylabel sl on sl.globalpagenum = sps.globalpagenum and sl.activeflag is true and sps.globalpagenum = #{globalPageNum}
     inner join surveysection ssec on ssec.id = sl.surveysectionid and ssec.activeflag is true
     where sur.id = #{surveyId}          
  </select>
  
</mapper>