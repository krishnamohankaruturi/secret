<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.ku.cete.model.TestSectionDao" >
<resultMap id="BaseResultMap" type="edu.ku.cete.domain.content.TestSection" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="externalid" property="externalId" jdbcType="BIGINT" />
    <result column="testid" property="testId" jdbcType="BIGINT" />
    <result column="testsectionname" property="testSectionName" jdbcType="VARCHAR" />
    <result column="numberoftestitems" property="numberOfTestItems" jdbcType="INTEGER" />
    <result column="helpnotes" property="helpNotes" jdbcType="VARCHAR" />
    <result column="toolsusageid" property="toolsUsageId" jdbcType="BIGINT" />
    <result column="taskdeliveryruleid" property="taskDeliveryRuleId" jdbcType="BIGINT" />
    <result column="createdate" property="createDate" jdbcType="TIMESTAMP" />
    <result column="modifieddate" property="modifiedDate" jdbcType="TIMESTAMP" />
    <result column="originationcode" property="originationCode" jdbcType="VARCHAR" />
    <result column="begininstructions" property="beginInstructions" jdbcType="VARCHAR" />
    <result column="endinstructions" property="endInstructions" jdbcType="VARCHAR" />
    <result column="contextstimulusid" property="contextStimulusId" jdbcType="BIGINT" />
    <result column="ticketed" property="ticketed" jdbcType="BIT" />
    <result column="hardbreak" property="hardBreak" jdbcType="BIT" />
    <result column="sectionorder" property="sectionOrder" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    id, externalid, testid, testsectionname, numberoftestitems, helpnotes, toolsusageid, 
    taskdeliveryruleid, createdate, modifieddate, originationcode, begininstructions, 
    endinstructions, contextstimulusid, ticketed, hardbreak, sectionorder
  </sql>
  <select id="selectByExample" resultMap="BaseResultMap" parameterType="edu.ku.cete.domain.content.TestSectionExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from public.testsection
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    select 
    <include refid="Base_Column_List" />
    from public.testsection
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="getTestSectionsByTestsInterim" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from public.testsection
    where testid= ANY(ARRAY 
		        <foreach collection="testIds" item="testId" open="[" close="]" separator="," >
		    	    	#{testId}
		        </foreach>)
	ORDER BY sectionorder
		  
  </select>
   <select id="getTestSectionsByTestInterim" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from public.testsection
    where testid= #{testId,jdbcType=BIGINT}
	ORDER BY sectionorder
		  
  </select>
   
   
    <select id="selectByTestId" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    
    select 
    <include refid="Base_Column_List" />
    from public.testsection
    where testid = #{id,jdbcType=BIGINT}
    order by externalid
  </select>
   
   
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    delete from public.testsection
    where id = #{id,jdbcType=BIGINT}
  </delete>
    <delete id="deleteByPrimaryKeyInterim" parameterType="java.lang.Long" >
	<!--
    @Author: Vamshi Krishna
    DE15127: Adding a delete to avoid FK Constaint for Studentstestssections table
    -->
    update public.studentstests set testid=null
    where id in (select studentstestid from studentstestsections   where testsectionid=#{id,jdbcType=BIGINT} );
    
    delete from public.studentstestsections
    where testsectionid=#{id,jdbcType=BIGINT};
    
    delete from public.testsectionresource
    where testsectionid=#{id,jdbcType=BIGINT};
    
    delete from public.testsectionstools
    where testsectionid=#{id,jdbcType=BIGINT};
    
    delete from public.testsectionsrules
    where testsectionid=#{id,jdbcType=BIGINT};
    
    delete from public.readaloudaccommodation
	where contentgroupid in 
	(select id from contentgroup where testsectionid = #{id,jdbcType=BIGINT});

	delete from public.signedaccommodation
	where contentgroupid in 
	(select id from contentgroup where testsectionid = #{id,jdbcType=BIGINT});

	delete from public.brailleaccommodation
	where contentgroupid in 
	(select id from contentgroup where testsectionid = #{id,jdbcType=BIGINT});

	delete from public.textaccommodation
	where contentgroupid in 
	(select id from contentgroup where testsectionid = #{id,jdbcType=BIGINT});
    
    delete from public.contentgroup 
    where testsectionid = #{id,jdbcType=BIGINT};
    
    delete from public.testsection
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <delete id="deleteByExample" parameterType="edu.ku.cete.domain.content.TestSectionExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    delete from public.testsection
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="edu.ku.cete.domain.content.TestSection"
  useGeneratedKeys="true" keyColumn="id" keyProperty="id"> 
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    insert into public.testsection (externalid, testid, 
      testsectionname, numberoftestitems, helpnotes, 
      toolsusageid, taskdeliveryruleid, createdate, 
      modifieddate, originationcode, begininstructions, 
      endinstructions, contextstimulusid, ticketed, hardbreak,sectionorder
      )
    values (#{externalId,jdbcType=BIGINT}, #{testId,jdbcType=BIGINT}, 
      #{testSectionName,jdbcType=VARCHAR}, #{numberOfTestItems,jdbcType=INTEGER}, #{helpNotes,jdbcType=VARCHAR}, 
      #{toolsUsageId,jdbcType=BIGINT}, #{taskDeliveryRuleId,jdbcType=BIGINT}, #{createDate,jdbcType=TIMESTAMP}, 
      #{modifiedDate,jdbcType=TIMESTAMP}, #{originationCode,jdbcType=VARCHAR}, #{beginInstructions,jdbcType=VARCHAR}, 
      #{endInstructions,jdbcType=VARCHAR}, #{contextStimulusId,jdbcType=BIGINT}, #{ticketed,jdbcType=BIT}, 
      #{hardBreak,jdbcType=BIT},#{sectionOrder,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertAuxillaryTestRoles" useGeneratedKeys="true">
	insert into testsectionresource
	(externalid,testsectionid,stimulusvariantid,sortorder)
	select
	t.externalid, #{newId,jdbcType=BIGINT},t.stimulusvariantid,t.sortorder
	from
	testsectionresource t where
	t.testsectionid=#{oldId,jdbcType=BIGINT};

	insert into testsectionstools
	(testsectionid,toolid)
	select
	#{newId,jdbcType=BIGINT},t.toolid from
	testsectionstools t where
	t.testsectionid=#{oldId,jdbcType=BIGINT}
	and NOT EXISTS (select
	testsectionid from
	testsectionstools where testsectionid=#{newId,jdbcType=BIGINT} and toolid=t.toolid);

	insert into testsectionsrules
	(testsectionid,ruleid,navigation)
	select
	#{newId,jdbcType=BIGINT},t.ruleid,t.navigation from
	testsectionsrules t
	where t.testsectionid=#{oldId,jdbcType=BIGINT}
	and NOT EXISTS (select
	testsectionid from
	testsectionstools where testsectionid=#{newId,jdbcType=BIGINT} and ruleid=t.ruleid)
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.content.TestSection" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    insert into public.testsection
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="externalId != null" >
        externalid,
      </if>
      <if test="testId != null" >
        testid,
      </if>
      <if test="testSectionName != null" >
        testsectionname,
      </if>
      <if test="numberOfTestItems != null" >
        numberoftestitems,
      </if>
      <if test="helpNotes != null" >
        helpnotes,
      </if>
      <if test="toolsUsageId != null" >
        toolsusageid,
      </if>
      <if test="taskDeliveryRuleId != null" >
        taskdeliveryruleid,
      </if>
      <if test="createDate != null" >
        createdate,
      </if>
      <if test="modifiedDate != null" >
        modifieddate,
      </if>
      <if test="originationCode != null" >
        originationcode,
      </if>
      <if test="beginInstructions != null" >
        begininstructions,
      </if>
      <if test="endInstructions != null" >
        endinstructions,
      </if>
      <if test="contextStimulusId != null" >
        contextstimulusid,
      </if>
      <if test="ticketed != null" >
        ticketed,
      </if>
      <if test="hardBreak != null" >
        hardbreak,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="externalId != null" >
        #{externalId,jdbcType=BIGINT},
      </if>
      <if test="testId != null" >
        #{testId,jdbcType=BIGINT},
      </if>
      <if test="testSectionName != null" >
        #{testSectionName,jdbcType=VARCHAR},
      </if>
      <if test="numberOfTestItems != null" >
        #{numberOfTestItems,jdbcType=INTEGER},
      </if>
      <if test="helpNotes != null" >
        #{helpNotes,jdbcType=VARCHAR},
      </if>
      <if test="toolsUsageId != null" >
        #{toolsUsageId,jdbcType=BIGINT},
      </if>
      <if test="taskDeliveryRuleId != null" >
        #{taskDeliveryRuleId,jdbcType=BIGINT},
      </if>
      <if test="createDate != null" >
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null" >
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="originationCode != null" >
        #{originationCode,jdbcType=VARCHAR},
      </if>
      <if test="beginInstructions != null" >
        #{beginInstructions,jdbcType=VARCHAR},
      </if>
      <if test="endInstructions != null" >
        #{endInstructions,jdbcType=VARCHAR},
      </if>
      <if test="contextStimulusId != null" >
        #{contextStimulusId,jdbcType=BIGINT},
      </if>
      <if test="ticketed != null" >
        #{ticketed,jdbcType=BIT},
      </if>
      <if test="hardBreak != null" >
        #{hardBreak,jdbcType=BIT},
      </if>      
    </trim>
  </insert>
  <select id="countByExample" parameterType="edu.ku.cete.domain.content.TestSectionExample" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    select count(*) from public.testsection
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    update public.testsection
    <set >
      <if test="record.id != null" >
        id = #{record.id,jdbcType=BIGINT},
      </if>
      <if test="record.externalId != null" >
        externalid = #{record.externalId,jdbcType=BIGINT},
      </if>
      <if test="record.testId != null" >
        testid = #{record.testId,jdbcType=BIGINT},
      </if>
      <if test="record.testSectionName != null" >
        testsectionname = #{record.testSectionName,jdbcType=VARCHAR},
      </if>
      <if test="record.numberOfTestItems != null" >
        numberoftestitems = #{record.numberOfTestItems,jdbcType=INTEGER},
      </if>
      <if test="record.helpNotes != null" >
        helpnotes = #{record.helpNotes,jdbcType=VARCHAR},
      </if>
      <if test="record.toolsUsageId != null" >
        toolsusageid = #{record.toolsUsageId,jdbcType=BIGINT},
      </if>
      <if test="record.taskDeliveryRuleId != null" >
        taskdeliveryruleid = #{record.taskDeliveryRuleId,jdbcType=BIGINT},
      </if>
      <if test="record.createDate != null" >
        createdate = #{record.createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.modifiedDate != null" >
        modifieddate = #{record.modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.originationCode != null" >
        originationcode = #{record.originationCode,jdbcType=VARCHAR},
      </if>
      <if test="record.beginInstructions != null" >
        begininstructions = #{record.beginInstructions,jdbcType=VARCHAR},
      </if>
      <if test="record.endInstructions != null" >
        endinstructions = #{record.endInstructions,jdbcType=VARCHAR},
      </if>
      <if test="record.contextStimulusId != null" >
        contextstimulusid = #{record.contextStimulusId,jdbcType=BIGINT},
      </if>
      <if test="record.ticketed != null" >
        ticketed = #{record.ticketed,jdbcType=BIT},
      </if>
      <if test="record.hardBreak != null" >
        hardbreak = #{record.hardBreak,jdbcType=BIT},
      </if>      
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    update public.testsection
    set id = #{record.id,jdbcType=BIGINT},
      externalid = #{record.externalId,jdbcType=BIGINT},
      testid = #{record.testId,jdbcType=BIGINT},
      testsectionname = #{record.testSectionName,jdbcType=VARCHAR},
      numberoftestitems = #{record.numberOfTestItems,jdbcType=INTEGER},
      helpnotes = #{record.helpNotes,jdbcType=VARCHAR},
      toolsusageid = #{record.toolsUsageId,jdbcType=BIGINT},
      taskdeliveryruleid = #{record.taskDeliveryRuleId,jdbcType=BIGINT},
      createdate = #{record.createDate,jdbcType=TIMESTAMP},
      modifieddate = #{record.modifiedDate,jdbcType=TIMESTAMP},
      originationcode = #{record.originationCode,jdbcType=VARCHAR},
      begininstructions = #{record.beginInstructions,jdbcType=VARCHAR},
      endinstructions = #{record.endInstructions,jdbcType=VARCHAR},
      contextstimulusid = #{record.contextStimulusId,jdbcType=BIGINT},
      ticketed = #{record.ticketed,jdbcType=BIT},
      hardbreak = #{record.hardBreak,jdbcType=BIT}
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.content.TestSection" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    update public.testsection
    <set >
      <if test="externalId != null" >
        externalid = #{externalId,jdbcType=BIGINT},
      </if>
      <if test="testId != null" >
        testid = #{testId,jdbcType=BIGINT},
      </if>
      <if test="testSectionName != null" >
        testsectionname = #{testSectionName,jdbcType=VARCHAR},
      </if>
      <if test="numberOfTestItems != null" >
        numberoftestitems = #{numberOfTestItems,jdbcType=INTEGER},
      </if>
      <if test="helpNotes != null" >
        helpnotes = #{helpNotes,jdbcType=VARCHAR},
      </if>
      <if test="toolsUsageId != null" >
        toolsusageid = #{toolsUsageId,jdbcType=BIGINT},
      </if>
      <if test="taskDeliveryRuleId != null" >
        taskdeliveryruleid = #{taskDeliveryRuleId,jdbcType=BIGINT},
      </if>
      <if test="createDate != null" >
        createdate = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null" >
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="originationCode != null" >
        originationcode = #{originationCode,jdbcType=VARCHAR},
      </if>
      <if test="beginInstructions != null" >
        begininstructions = #{beginInstructions,jdbcType=VARCHAR},
      </if>
      <if test="endInstructions != null" >
        endinstructions = #{endInstructions,jdbcType=VARCHAR},
      </if>
      <if test="contextStimulusId != null" >
        contextstimulusid = #{contextStimulusId,jdbcType=BIGINT},
      </if>
      <if test="ticketed != null" >
        ticketed = #{ticketed,jdbcType=BIT},
      </if>
      <if test="hardBreak != null" >
        hardbreak = #{hardBreak,jdbcType=BIT},
      </if>      
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.content.TestSection" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 12 21:51:26 CST 2012.
    -->
    update public.testsection
    set externalid = #{externalId,jdbcType=BIGINT},
      testid = #{testId,jdbcType=BIGINT},
      testsectionname = #{testSectionName,jdbcType=VARCHAR},
      numberoftestitems = #{numberOfTestItems,jdbcType=INTEGER},
      helpnotes = #{helpNotes,jdbcType=VARCHAR},
      toolsusageid = #{toolsUsageId,jdbcType=BIGINT},
      taskdeliveryruleid = #{taskDeliveryRuleId,jdbcType=BIGINT},
      createdate = #{createDate,jdbcType=TIMESTAMP},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      originationcode = #{originationCode,jdbcType=VARCHAR},
      begininstructions = #{beginInstructions,jdbcType=VARCHAR},
      endinstructions = #{endInstructions,jdbcType=VARCHAR},
      contextstimulusid = #{contextStimulusId,jdbcType=BIGINT},
      ticketed = #{ticketed,jdbcType=BIT},
      hardbreak = #{hardBreak,jdbcType=BIT}
    where id = #{id,jdbcType=BIGINT}
  </update>

  <select id="getTestSectionsWithMaxNumberOfItemsByTestSessionId" resultType="TestSection" >  
      SELECT ts.sectionorder, max(ts.numberoftestitems) as numberoftestitems, ts.testsectionname, ts.sectionorder as id
    FROM testsection ts 
    WHERE ts.testid in (select distinct testid from studentstests where testsessionid=#{testSessionId,jdbcType=BIGINT})
    group by ts.sectionorder,ts.testsectionname order by ts.sectionorder
  </select>  
  
  <select id="getContextStimulsIdByTestSectionId" resultType="java.lang.Long">
  	SELECT distinct contextstimulusid FROM testsectionstaskvariants  tstv join 
  	taskvariant tv on tstv.taskvariantid = tv.id   WHERE testsectionid =  #{testSessionId,jdbcType=BIGINT}
  </select>
</mapper>