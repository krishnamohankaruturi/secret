<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.OrganizationReportDetailsMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.report.OrganizationReportDetails">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu May 18 10:10:21 CDT 2017.
    -->
    <result column="id" jdbcType="BIGINT" property="id" />
    <result column="assessmentprogramid" jdbcType="BIGINT" property="assessmentProgramId" />
    <result column="contentareaid" jdbcType="BIGINT" property="contentAreaId" />
    <result column="gradeid" jdbcType="BIGINT" property="gradeId" />
    <result column="organizationid" jdbcType="BIGINT" property="organizationId" />
    <result column="schoolyear" jdbcType="BIGINT" property="schoolYear" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="detailedreportpath" jdbcType="VARCHAR" property="detailedReportPath" />
    <result column="schoolreportpdfpath" jdbcType="VARCHAR" property="schoolReportPdfPath" />
    <result column="schoolreportpdfsize" jdbcType="BIGINT" property="schoolReportPdfSize" />
    <result column="schoolreportzipsize" jdbcType="BIGINT" property="schoolReportZipSize" />
    <result column="batchreportprocessid" jdbcType="BIGINT" property="batchReportProcessId" />
    <result column="gradecourseabbrname" jdbcType="VARCHAR" property="gradeCourseAbbrName" />
    <result column="summaryreportpath" jdbcType="VARCHAR" property="summaryReportPath" />
    <result column="reporttype" jdbcType="VARCHAR" property="reportType" />
    <result column="teacherid" jdbcType="BIGINT" property="teacherId" />
    <result column="schoolname" jdbcType="VARCHAR" property="schoolName" />
    <result column="detailedreportpath_csv" jdbcType="VARCHAR" property="csvDetailedReportPath" />
    <result column="summaryreportcsvpath" jdbcType="VARCHAR" property="summaryReportCsvPath" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="createduser" jdbcType="BIGINT" property="createdUser" />
    <result column="modifieduser" jdbcType="BIGINT" property="modifiedUser" />
    <result column="teachername" jdbcType="VARCHAR" property="teacherName" />
    <result column="districtname" jdbcType="VARCHAR" property="districtName" />
  </resultMap>
  <insert id="insert" parameterType="edu.ku.cete.domain.report.OrganizationReportDetails">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu May 18 10:10:21 CDT 2017.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('organizationreportdetails_id_seq')
    </selectKey>
    insert into organizationreportdetails (id, assessmentprogramid, contentareaid, 
      gradeid, organizationid, schoolyear, 
      createddate, detailedreportpath, schoolreportpdfpath, 
      schoolreportpdfsize, schoolreportzipsize, 
      batchreportprocessid, gradecourseabbrname, 
      summaryreportpath, reporttype, teacherid, 
      schoolname, districtname, detailedreportpath_csv, summaryreportcsvpath, 
      modifieddate, createduser, modifieduser, assessmentcode, reportcycle, testingprogramid, assessmentname
      )
    values (#{id,jdbcType=BIGINT}, #{assessmentProgramId,jdbcType=BIGINT}, #{contentAreaId,jdbcType=BIGINT}, 
      #{gradeId,jdbcType=BIGINT}, #{organizationId,jdbcType=BIGINT}, #{schoolYear,jdbcType=BIGINT}, 
      now(), #{detailedReportPath,jdbcType=VARCHAR}, #{schoolReportPdfPath,jdbcType=VARCHAR}, 
      #{schoolReportPdfSize,jdbcType=BIGINT}, #{schoolReportZipSize,jdbcType=BIGINT}, 
      #{batchReportProcessId,jdbcType=BIGINT}, #{gradeCourseAbbrName,jdbcType=VARCHAR}, 
      #{summaryReportPath,jdbcType=VARCHAR}, #{reportType,jdbcType=VARCHAR}, #{teacherId,jdbcType=BIGINT}, 
      #{schoolName,jdbcType=VARCHAR}, #{districtName,jdbcType=VARCHAR}, #{csvDetailedReportPath,jdbcType=VARCHAR}, #{summaryReportCsvPath,jdbcType=VARCHAR}, 
      now(), #{createdUser,jdbcType=BIGINT}, #{modifiedUser,jdbcType=BIGINT},#{assessmentCode,jdbcType=VARCHAR},
      #{reportCycle,jdbcType=VARCHAR},#{testingProgramId,jdbcType=BIGINT}, #{assessmentName,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.report.OrganizationReportDetails">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu May 18 10:10:21 CDT 2017.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('organizationreportdetails_id_seq')
    </selectKey>
    insert into organizationreportdetails
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="assessmentProgramId != null">
        assessmentprogramid,
      </if>
      <if test="contentAreaId != null">
        contentareaid,
      </if>
      <if test="gradeId != null">
        gradeid,
      </if>
      <if test="organizationId != null">
        organizationid,
      </if>
      <if test="schoolYear != null">
        schoolyear,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="detailedReportPath != null">
        detailedreportpath,
      </if>
      <if test="schoolReportPdfPath != null">
        schoolreportpdfpath,
      </if>
      <if test="schoolReportPdfSize != null">
        schoolreportpdfsize,
      </if>
      <if test="schoolReportZipSize != null">
        schoolreportzipsize,
      </if>
      <if test="batchReportProcessId != null">
        batchreportprocessid,
      </if>
      <if test="gradeCourseAbbrName != null">
        gradecourseabbrname,
      </if>
      <if test="summaryReportPath != null">
        summaryreportpath,
      </if>
      <if test="reportType != null">
      	reporttype,
      </if>
       <if test="summaryReportCsvPath != null">
        summaryreportcsvpath,
      </if>
      <if test="teacherId != null">
        teacherid,
      </if>
      <if test="schoolName != null">
        schoolname,
      </if>
      <if test="districtName != null">
        districtname,
      </if>
      <if test="csvDetailedReportPath != null">
        detailedreportpath_csv,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
      <if test="createdUser != null">
        createduser,
      </if>
      <if test="modifiedUser != null">
        modifieduser,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="assessmentProgramId != null">
        #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="contentAreaId != null">
        #{contentAreaId,jdbcType=BIGINT},
      </if>
      <if test="gradeId != null">
        #{gradeId,jdbcType=BIGINT},
      </if>
      <if test="organizationId != null">
        #{organizationId,jdbcType=BIGINT},
      </if>
      <if test="schoolYear != null">
        #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="detailedReportPath != null">
        #{detailedReportPath,jdbcType=VARCHAR},
      </if>
      <if test="schoolReportPdfPath != null">
        #{schoolReportPdfPath,jdbcType=VARCHAR},
      </if>
      <if test="schoolReportPdfSize != null">
        #{schoolReportPdfSize,jdbcType=BIGINT},
      </if>
      <if test="schoolReportZipSize != null">
        #{schoolReportZipSize,jdbcType=BIGINT},
      </if>
      <if test="batchReportProcessId != null">
        #{batchReportProcessId,jdbcType=BIGINT},
      </if>
      <if test="gradeCourseAbbrName != null">
        #{gradeCourseAbbrName,jdbcType=VARCHAR},
      </if>
      <if test="summaryReportPath != null">
        #{summaryReportPath,jdbcType=VARCHAR},
      </if>
      <if test="reportType != null">
      	#{reportType,jdbcType=VARCHAR},
      </if>
      <if test="summaryReportCsvPath != null">
        #{summaryReportCsvPath,jdbcType=VARCHAR},
      </if>
      <if test="teacherId != null">
        #{teacherId,jdbcType=BIGINT},
      </if>
      <if test="schoolName != null">
        #{schoolName,jdbcType=VARCHAR},
      </if>
      <if test="districtName != null">
        #{districtName,jdbcType=VARCHAR},
      </if>      
      <if test="csvDetailedReportPath != null">
        #{csvDetailedReportPath,jdbcType=VARCHAR},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createdUser != null">
        #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedUser != null">
        #{modifiedUser,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  
    <update id="updateForCsv" parameterType="edu.ku.cete.domain.report.OrganizationReportDetails">
    update organizationreportdetails  
    	set
        batchreportprocessid=#{batchProcessId},
        detailedreportpath_csv=#{csvPath},
        modifieduser=#{modifiedUser},
        modifiedDate=#{modifiedDate,jdbcType=TIMESTAMP}
	where id= #{id,jdbcType=BIGINT}
  </update>
  
  
  <resultMap extends="BaseResultMap" id="SchoolAndDistrictReportDTOMap" type="edu.ku.cete.web.SchoolAndDistrictReportDTO">
    <result column="gradename" jdbcType="VARCHAR" property="gradeName" />
    <result column="subjectname" jdbcType="VARCHAR" property="subjectName" />
    <result column="assessmentprogramCode" jdbcType="VARCHAR" property="assessmentProgramCode" />
    <result column="attschdisplayidentifier" jdbcType="VARCHAR" property="attSchDisplayIdentifier" />
    <result column="organizationname" jdbcType="VARCHAR" property="organizationname" />
    <result column="action" jdbcType="VARCHAR" property="action" />
  </resultMap>
  
  <delete id="deleteOrganizationReportDetails">
  delete from organizationreportdetails
	where 
	assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}  
	and contentAreaId = #{contentAreaId,jdbcType=BIGINT}
	and gradeid = #{gradeId,jdbcType=BIGINT}
	and schoolyear = #{schoolYear,jdbcType=BIGINT}
	and organizationid = #{organizationId,jdbcType=BIGINT}
	<if test="reportType != null">
		and reporttype = #{reportType,jdbcType=VARCHAR}
	</if>
	<if test="reportCycle != null">
	   and reportcycle = #{reportCycle,jdbcType=VARCHAR}
	</if>
	<if test="assessmentCode != null">
	  and assessmentcode = #{assessmentCode,jdbcType=VARCHAR}
	</if>
  </delete>
  
  <delete id="deleteAllOrgsInOrganizationReportDetails">
    delete from organizationreportdetails 
    where assessmentprogramid =  #{assessmentProgramId,jdbcType=BIGINT}
     	<if test="contentAreaId != null">
        	and contentareaid = #{contentAreaId,jdbcType=BIGINT}
      	</if>
     	<if test="gradeId != null">
       	  and gradeid = #{gradeId,jdbcType=BIGINT}
     	</if>
     	<if test="schoolYear != null">
       	  and schoolyear = #{schoolYear,jdbcType=BIGINT}
     	</if>
     	<if test="reportTypeSummary.size &gt; 1">
      		AND reporttype = ANY(ARRAY 
	        <foreach close="]" collection="reportTypeSummary" item="reportType" open="[" separator=",">
	    	    	#{reportType,jdbcType=VARCHAR}
	        </foreach>
	        )	
		</if> 
     	and contentareaid is not null
   </delete>
  
  <select id="countByCriteria" parameterType="map" resultType="java.lang.Long">
     SELECT count(ord.id)
     FROM organizationreportdetails ord
     INNER JOIN gradecourse gc on gc.id = ord.gradeid
     INNER JOIN contentarea ca on ca.id = ord.contentareaid
     INNER JOIN assessmentprogram ap on ap.id = ord.assessmentprogramid INNER JOIN reportassessmentprogram rap on rap.subjectid = ca.id 
     AND rap.assessmentprogramid = ap.id AND rap.reporttypeid in (select id from category where categorycode = #{reportCode}) 
     AND rap.stateid=#{stateId} AND rap.readytoview = TRUE INNER JOIN reportassessmentprogramgroup raq on raq.reportassessmentprogramid = rap.id
     AND raq.activeflag = true AND raq.groupid=#{currentroleId} AND ord.reporttype=#{reportCode}   
     WHERE
     <if test="schoolId!=null">
       ord.schoolYear=#{reportYear}
   	   AND ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{schoolId,jdbcType=BIGINT}
       AND ord.assessmentprogramid = #{assessmentProgram,jdbcType=BIGINT}
     </if>
     <if test="districtId!=null and schoolId==null">
       ord.schoolYear=#{reportYear}
   	   AND ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{districtId,jdbcType=BIGINT}
     </if>
   </select>
   
   <select id="selectByCriteria" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
     SELECT distinct ord.*, gc.name as gradename, ca.name as subjectname,ap.abbreviatedname as assessmentprogramCode,'' as organizationname
     FROM organizationreportdetails ord
     INNER JOIN gradecourse gc on gc.id = ord.gradeid
     INNER JOIN contentarea ca on ca.id = ord.contentareaid
     INNER JOIN assessmentprogram ap on ap.id = ord.assessmentprogramid   
     INNER JOIN reportassessmentprogram rap on rap.subjectid = ca.id AND rap.assessmentprogramid = ap.id AND rap.reporttypeid in (select id from category where 
     categorycode = #{reportCode}) AND rap.stateid=#{stateId} AND rap.readytoview = TRUE
     INNER JOIN reportassessmentprogramgroup raq on raq.reportassessmentprogramid = rap.id AND raq.activeflag = true AND raq.groupid=#{currentroleId}  
     WHERE
     ord.reporttype=#{reportCode} AND 
     <if test="schoolId!=null">
       ord.schoolYear = #{reportYear}
       AND ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{schoolId,jdbcType=BIGINT}
       AND ord.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
     </if>
     <if test="districtId!=null and schoolId==null">
       ord.schoolYear = #{reportYear}
       AND ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{districtId,jdbcType=BIGINT}
     </if>    
      UNION ALL      
     SELECT distinct ord.*, gc.name as gradename, ca.name as subjectname,ap.abbreviatedname as assessmentprogramCode,
     ood.sourceorgname as organizationname
     FROM organizationreportdetails ord
     INNER JOIN gradecourse gc on gc.id = ord.gradeid
     INNER JOIN contentarea ca on ca.id = ord.contentareaid
     INNER JOIN assessmentprogram ap on ap.id = ord.assessmentprogramid     
     INNER JOIN organizationoperationaldetail ood ON ood.targetorgid = #{schoolId,jdbcType=BIGINT} 
   	 INNER JOIN reportassessmentprogram rap on rap.subjectid = ca.id AND rap.assessmentprogramid = ap.id AND rap.reporttypeid in (select id from category where 
     categorycode = #{reportCode}) AND rap.stateid=#{stateId} AND rap.readytoview = TRUE
     INNER JOIN reportassessmentprogramgroup raq on raq.reportassessmentprogramid = rap.id AND raq.activeflag = true AND raq.groupid=#{currentroleId}  
     WHERE
     ord.reporttype=#{reportCode} AND 
     <if test="schoolId!=null">
     ord.schoolYear= #{reportYear}
     AND
       ord.detailedreportpath IS NOT NULL
       <!-- AND ord.organizationid = #{schoolId,jdbcType=BIGINT} -->
       AND ord.organizationid = ood.sourceorgid
       AND ord.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
       AND ood.activeflag = true
     </if>
     <if test="districtId!=null and schoolId==null">
     ord.schoolYear= #{reportYear}
     AND
       ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{districtId,jdbcType=BIGINT}
     </if>        
     <if test="assessmentProgramCode !=null and assessmentProgramCode !='CPASS'">
       ORDER BY subjectname, assessmentprogramCode,assessmentname
     </if>
     <if test="assessmentProgramCode !=null and assessmentProgramCode =='CPASS'">
       ORDER BY subjectname, assessmentprogramCode,assessmentname
     </if>
   </select>
   
   <select id="getDistrictSummaryReport" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
     SELECT ord.*, ca.name as subjectname 
     FROM organizationreportdetails ord
     INNER JOIN contentarea ca on ca.id = ord.contentareaid
     
     WHERE
     ord.schoolYear = #{reportYear} AND
       ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{districtId,jdbcType=BIGINT}
       AND ord.gradeid IS NULL 
       AND ord.contentareaid IS NOT NULL
       <if test="reportTypeCode != null">
       	  AND ord.reporttype = #{reportTypeCode,jdbcType=VARCHAR}
       </if>        
       <if test="contentAreaIds.size &gt; 0">       
      		AND ca.id = ANY(ARRAY 
         	<foreach collection="contentAreaIds" item="contentAreaId" open="[" separator="," close="]">
     	 		#{contentAreaId,jdbcType=BIGINT}
        	</foreach>
        	)
       	</if> 
       	AND ord.assessmentprogramid=#{assessmentProgramid}
     	ORDER BY ca.name
   </select>
   
    <select id="getDlmDistrictSummaryReport" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
		SELECT ord.*,organization.displayidentifier as attschdisplayidentifier 
		FROM organizationreportdetails ord 
	<!-- 	INNER JOIN (
			select org.reportyear from organization_parent(#{districtId,jdbcType=BIGINT}) orgParent 
			INNER JOIN organization org ON org.id=orgParent.id 
			where orgParent.contractingorganization is true
		) as org ON ord.schoolyear = org.reportyear  -->
		INNER JOIN organization organization ON organization.id=ord.organizationid 
		WHERE ord.detailedreportpath IS NOT NULL 
		AND ord.organizationid =  #{districtId,jdbcType=BIGINT}
		AND ord.gradeid IS NULL 
		AND ord.contentareaid IS NULL
		AND ord.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} 
		AND ord.reporttype = #{reportTypeCode,jdbcType=VARCHAR} 
		AND ord.schoolyear= #{reportYear}
		limit 1	
   </select>
   
   <select id="getDlmStateSummaryReport" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
		SELECT ord.*,organization.displayidentifier as attschdisplayidentifier 
		FROM organizationreportdetails ord 		
		INNER JOIN organization organization ON organization.id=ord.organizationid 
		WHERE 
		ord.schoolYear = #{reportYear}
		ANd ord.detailedreportpath IS NOT NULL 
		AND ord.organizationid = #{stateId,jdbcType=BIGINT}
		AND ord.gradeid IS NULL 
		AND ord.contentareaid IS NULL
		AND ord.assessmentprogramid =  #{assessmentProgramId,jdbcType=BIGINT} 
		AND ord.reporttype = #{reportTypeCode,jdbcType=VARCHAR} 
		limit 1	  
   </select>
   
   <select id="getSchoolAndDistrictReport" resultMap="BaseResultMap">
     SELECT * 
     FROM organizationreportdetails
     WHERE
     <if test="id != null">
       id= #{id,jdbcType=BIGINT}
     </if>
   </select>
   
   <select id="getSchoolAndDistrictReportByPrimaryKeyAndUserOrgId" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
     SELECT ord.*, gc.name as gradename, ca.name as subjectname 
     FROM organizationreportdetails ord
     INNER JOIN gradecourse gc on gc.id = ord.gradeid
     INNER JOIN contentarea ca on ca.id = ord.contentareaid
     INNER JOIN (SELECT id FROM organization_children_active_or_inactive(#{userOrgId,jdbcType=BIGINT}) UNION (SELECT #{userOrgId,jdbcType=BIGINT})
      UNION    
     select sourceorgid from organizationoperationaldetail as ood where ood.targetorgid in (SELECT id FROM organization_children_active_or_inactive(#{userOrgId,jdbcType=BIGINT}) UNION (SELECT #{userOrgId,jdbcType=BIGINT}))
     and ood.activeflag = true) orgids ON ord.organizationid = orgids.id
     WHERE
     <if test="id!=null">
       ord.id= #{id,jdbcType=BIGINT}
     </if>
   </select>
   
   <select id="getSchoolSummaryReports" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
     SELECT distinct ord.*, ca.name as subjectname,
     orgnization.organizationname as organizationname,
     '' as action
     FROM organizationreportdetails ord
     INNER JOIN contentarea ca on ca.id = ord.contentareaid
      INNER JOIN organization orgnization ON orgnization.id = ord.organizationid
     WHERE
	   ord.schoolYear =#{reportYear} AND
       ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{schoolId,jdbcType=BIGINT}
       AND ord.gradeid is NULL AND ord.contentareaid IS NOT NULL
             
       <if test="contentAreaIds.size &gt; 0">       
      		AND ca.id = ANY(ARRAY 
         	<foreach collection="contentAreaIds" item="contentAreaId" open="[" separator="," close="]">
     	 		#{contentAreaId,jdbcType=BIGINT}
        	</foreach>
        	)
       	</if> 
       
       <if test="reportTypeCode != null">
       	  AND ord.reporttype = #{reportTypeCode,jdbcType=VARCHAR}
       </if> 
       AND ord.assessmentprogramid=#{assessmentProgramid}
       UNION ALL
       
     SELECT distinct ord.*, ca.name as subjectname,
     ood.sourceorgname as organizationname,
     ood.action as action
     FROM organizationreportdetails ord
     INNER JOIN contentarea ca on ca.id = ord.contentareaid     
     INNER JOIN organizationoperationaldetail ood ON ood.targetorgid = #{schoolId,jdbcType=BIGINT}
     WHERE
     ord.schoolYear =#{reportYear} AND 
       ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = ood.sourceorgid
       AND ord.gradeid is NULL AND ord.contentareaid IS NOT NULL
       AND ood.activeflag = true 
       <if test="reportTypeCode != null">
       	  AND ord.reporttype = #{reportTypeCode,jdbcType=VARCHAR}
       </if>              
       <if test="contentAreaIds.size &gt; 0">       
      		AND ca.id = ANY(ARRAY 
         	<foreach collection="contentAreaIds" item="contentAreaId" open="[" separator="," close="]">
     	 		#{contentAreaId,jdbcType=BIGINT}
        	</foreach>
        	)
       	</if> 
       AND ord.assessmentprogramid=#{assessmentProgramid}
     ORDER BY subjectname
   </select>
   
   <select id="getSchoolSummaryReportFile" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
     SELECT ord.*,ca.name as subjectname,orgn.displayidentifier as attschdisplayidentifier 
     FROM organizationreportdetails ord
     INNER JOIN contentarea ca on ca.id = ord.contentareaid
     INNER join organization orgn on orgn.id = ord.organizationid
     INNER JOIN (SELECT id FROM organization_children_active_or_inactive(#{userOrgId,jdbcType=BIGINT}) UNION (SELECT #{userOrgId,jdbcType=BIGINT})
     UNION    
     select sourceorgid from organizationoperationaldetail as ood where ood.targetorgid in (SELECT id FROM organization_children_active_or_inactive(#{userOrgId,jdbcType=BIGINT}) UNION (SELECT #{userOrgId,jdbcType=BIGINT}))
     and ood.activeflag = true) orgids ON ord.organizationid = orgids.id
     WHERE
     <if test="id!=null">
       ord.id= #{id,jdbcType=BIGINT}
     </if>
   </select>
   
   <select id="getDistrictSummaryReportByPrimaryKeyAndUserOrgId" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
     SELECT ord.*, ca.name as subjectname,orgn.displayidentifier as attschdisplayidentifier 
     FROM organizationreportdetails ord    
     INNER JOIN contentarea ca on ca.id = ord.contentareaid
     Inner join organization orgn on orgn.id = ord.organizationid
     INNER JOIN (SELECT id FROM organization_children(#{userOrgId,jdbcType=BIGINT}) UNION (SELECT #{userOrgId,jdbcType=BIGINT})) orgids ON ord.organizationid = orgids.id
     WHERE
     <if test="id!=null">
       ord.id= #{id,jdbcType=BIGINT}
     </if>
   </select>
   
   <select id="getDlmSummaryReportByPrimaryKeyAndUserOrgId" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
	 SELECT ord.*,orgn.displayidentifier as attschdisplayidentifier,orgn.organizationname 
	 FROM organizationreportdetails ord 
	 Inner join organization orgn on orgn.id = ord.organizationid 
	 INNER JOIN (SELECT id FROM organization_children(#{userOrgId,jdbcType=BIGINT}) 
	 UNION (SELECT #{userOrgId,jdbcType=BIGINT})) orgids ON ord.organizationid = orgids.id 
	 WHERE 
     <if test="id!=null">
       ord.id= #{id,jdbcType=BIGINT} 
     </if>
     <if test="reportType != null">
      and ord.reporttype = #{reportType,jdbcType=VARCHAR}
     </if>    
   </select>
   
   
   <select id="getAllStudentsReports" parameterType="map" resultMap="BaseResultMap">
   	 SELECT *
     FROM organizationreportdetails ord     
    <!--  <if test="assessmentProgCode != 'CPASS'">
      INNER JOIN (select org.reportyear from organization_parent(#{schoolId,jdbcType=BIGINT}) orgParent 
      INNER JOIN organization org ON org.id=orgParent.id where orgParent.contractingorganization is true) as org ON ord.schoolyear = org.reportyear
     </if> 	
     <if test="assessmentProgCode == 'CPASS'">
      INNER JOIN (select orgap.reportyear from organization_parent(#{schoolId,jdbcType=BIGINT}) orgParent 
      INNER JOIN orgassessmentprogram orgap ON orgap.organizationid=orgParent.id and orgap.assessmentprogramid =#{assessmentId,jdbcType=BIGINT}
      where orgParent.contractingorganization is true) as orgap ON ord.schoolyear = orgap.reportyear
     </if> 
	 -->
     WHERE
     ord.schoolYear = #{reportYear} AND 
     	ord.detailedreportpath IS NOT NULL 
   	  	<if test="schoolIds != null">
      		AND ord.organizationid = ANY(ARRAY 
	        <foreach close="]" collection="schoolIds" item="schoolId" open="[" separator=",">
	    	    	#{schoolId,jdbcType=BIGINT}
	        </foreach>)	
	    </if>
	    AND ord.contentareaid IS NULL
	    AND ord.assessmentprogramid = #{assessmentId,jdbcType=BIGINT}
	 <if test="reportTypeCode != null">
     	 AND reporttype = #{reportTypeCode,jdbcType=VARCHAR}
     </if>
     ORDER BY (select filename[array_length(regexp_split_to_array(ord.detailedreportpath, '/'), 1)]
		from (select regexp_split_to_array(ord.detailedreportpath, '/')) as filepath(filename)) ASC
   </select>
  
  <select id="getSchoolIdsForDistrict" resultType="java.lang.Long">
     SELECT distinct attendanceschoolid 
     FROM studentreport
     <if test="districtId != null">
     <!-- INNER JOIN (select org.reportyear from organization_parent(#{districtId,jdbcType=BIGINT}) orgParent 
     	INNER JOIN organization org ON org.id=orgParent.id where orgParent.contractingorganization is true) as org ON schoolyear = org.reportyear
 -->     WHERE schoolyear = #{reportYear} and districtid = #{districtId,jdbcType=BIGINT}
     </if>
   </select>
   
   
   <select id="getSchoolIdsForDistrictDLMandCpass" resultType="java.lang.Long">
     SELECT distinct schoolid 
     FROM externalstudentreports
     <if test="districtId != null">
   <!--   INNER JOIN (select org.reportyear from organization_parent(#{districtId,jdbcType=BIGINT}) orgParent 
     	INNER JOIN organization org ON org.id=orgParent.id where orgParent.contractingorganization is true) as org ON schoolyear = org.reportyear
    --> 
    WHERE
    schoolyear=#{reportYear} and districtid = #{districtId,jdbcType=BIGINT}
     <if test="reportTypeCode != null">
     	 AND reporttype = #{reportTypeCode,jdbcType=VARCHAR}
     </if>
     </if>
   </select>
   
   
     
  <select id="getSchoolIdsFromOrgDetailReportByStateIdAssmntProgIdAndSchoolYear" resultType="java.lang.Long">
  select distinct ord.organizationid
   from organizationreportdetails ord
   join studentreport str on str.attendanceschoolid = ord.organizationid   
   where ord.assessmentprogramid= #{assessmentProgramId}   
   and ord.schoolyear = #{schoolYear}
   and str.stateid = #{contractingOrganizationId}
   and ord.gradecourseabbrname is not null
   <if test="reportType != null">
          and reporttype = #{reportType, jdbcType=VARCHAR}
   </if>
   order by ord.organizationid
   LIMIT #{pageSize} OFFSET #{offset}
  </select>
  
  <resultMap id="schoolZipMap" type="edu.ku.cete.domain.report.OrganizationReportDetails">
   <result column="organizationid" property="organizationId" />
   <result column="detailedreportpath" property="detailedReportPath" />     
   <result column="organizationname" property="organizationName" />
   <result column="stateid" property="stateId" />
   <result column="districtid" property="districtId" />
   <result column="displayidentifier" property="attSchDisplayIdentifier" />   
   <result column="districtdisplayidentifier" property="districtDisplayIdentifier" />   
  </resultMap>
  
  <select id="getOrganizationReportDetailsForZip" resultMap="schoolZipMap">
  select distinct ord.organizationid, ord.detailedreportpath, org.organizationname, org.displayidentifier, sr.stateid, sr.districtid, ord.gradecourseabbrname
  , (select org.displayidentifier as districtdisplayidentifier from organization where id = sr.districtid)
   from organizationreportdetails ord 
   join organization org on org.id = ord.organizationid
   join (
     select distinct attendanceschoolid, districtid, stateid
     from studentreport
     where assessmentprogramid = #{assessmentProgramId}
     and schoolyear = #{schoolYear}
   ) as sr on sr.attendanceschoolid = ord.organizationid
   where ord.gradecourseabbrname is not null
   and ord.assessmentprogramid=#{assessmentProgramId}  
   and ord.schoolyear = #{schoolYear}
   and ord.organizationid = #{organizationId}
   <if test="reportType != null">
          and reporttype = #{reportType, jdbcType=VARCHAR}
   </if>   
   order by ord.gradecourseabbrname
  </select>
  
  <select id="selectAllOrgReportDetailsByAssessmentProgramIdContentAreaIdGradeId" resultMap="BaseResultMap">
	 select * from organizationreportdetails 
   	 where assessmentprogramid = #{assessmentProgramId}
 	<if test="gradeId != null">
             and gradeid = #{gradeId, jdbcType=BIGINT}
    </if>  
    <if test="contentAreaId != null">
          and contentareaid = #{contentAreaId, jdbcType=BIGINT}
    </if>  
     <if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if> 
	 and contentareaid is not null 
	<if test="reportTypeSummary.size &gt; 1">
      		AND reporttype = ANY(ARRAY 
	        <foreach close="]" collection="reportTypeSummary" item="reportType" open="[" separator=",">
	    	    	#{reportType,jdbcType=VARCHAR}
	        </foreach>
	        )	
	</if>  	
   </select>
   
  <delete id="deleteAllSchoolBundleReports">
  	delete from organizationreportdetails
	where assessmentprogramid = #{assessmentProgramId}	
	and gradeid is null
	and contentareaid is null
	 <if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    <if test="reportType != null">
          and reporttype = #{reportType, jdbcType=VARCHAR}
    </if>  
  </delete>
  
  <delete id="deleteAllSchoolBundleReportsForUserState">
  	delete from organizationreportdetails
	where assessmentprogramid = #{assessmentProgramId}	
	and gradeid is null
	and contentareaid is null
	 <if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    <if test="reportType != null">
          and reporttype = #{reportType, jdbcType=VARCHAR}
    </if>
     and organizationid in (select id from organization_children_oftype(#{organizationId, jdbcType=BIGINT},'SCH')) 
  </delete>
  
    <delete id="deleteAllDistrictBundleReportsForUserState">
  	delete from organizationreportdetails
	where assessmentprogramid = #{assessmentProgramId}	
	and gradeid is null
	and contentareaid is null
	 <if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    <if test="reportType != null">
          and reporttype = #{reportType, jdbcType=VARCHAR}
    </if>
     and organizationid in (select id from organization_children(#{organizationId, jdbcType=BIGINT}) where organizationtypeid in(select id from organizationtype where typecode = 'DT')) 
  </delete>
  
  <select id="getAllSchoolReportBundleReportsByAssessmentProgramId" resultMap="BaseResultMap">
  	select * from organizationreportdetails
  	where assessmentprogramid = #{assessmentProgramId}
  	and gradeid is null
  	and contentareaid is null
  	<if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if> 
    <if test="reportType != null">
          and reporttype = #{reportType, jdbcType=VARCHAR}
    </if>  
  </select>
  
  <select id="getAllSchoolReportBundleReportsByAssessmentProgramIdForUserState" resultMap="BaseResultMap">
  	select * from organizationreportdetails
  	where assessmentprogramid = #{assessmentProgramId}
  	and gradeid is null
  	and contentareaid is null
  	<if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    and organizationid in (select id from organization_children_oftype(#{organizationId, jdbcType=BIGINT},'SCH'))  
    <if test="reportType != null">
          and reporttype = #{reportType, jdbcType=VARCHAR}
    </if>
  </select>
  
    <select id="getAllDistrictReportBundleReportsByAssessmentProgramIdForUserState" resultMap="BaseResultMap">
  	select * from organizationreportdetails
  	where assessmentprogramid = #{assessmentProgramId}
  	and gradeid is null
  	and contentareaid is null
  	<if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    and organizationid in (select id from organization_children(#{organizationId, jdbcType=BIGINT}) where organizationtypeid in(select id from organizationtype where typecode = 'DT'))
    <if test="reportType != null">
          and reporttype = #{reportType, jdbcType=VARCHAR}
    </if>  
  </select>
  
  <select id="getELPAStudentsScoreFileReport" parameterType="map" resultMap="SchoolAndDistrictReportDTOMap">
     SELECT ord.*, ca.name as subjectname 
     FROM organizationreportdetails ord
     INNER JOIN contentarea ca on ca.id = ord.contentareaid
          
     WHERE
       ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{districtId,jdbcType=BIGINT}
       AND ord.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
       AND ord.gradeid IS NULL 
       AND ord.contentareaid IS NOT NULL
     ORDER BY ord.id desc limit 1
   </select>
   
    <delete id="deleteOrganizationBundleReportsByOrganization">
  	delete from organizationreportdetails
	where assessmentprogramid = #{assessmentProgramId}	
	and gradeid is null
	and contentareaid is null
	 <if test="reportType != null">
          and reporttype = #{reportType, jdbcType=VARCHAR}
     </if>
	 <if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
     and organizationid = #{organizationId, jdbcType=BIGINT}
     <if test="reportType != null">
     	and reporttype = #{reportType,jdbcType=VARCHAR}
     </if> 
  </delete>
  
    <select id="OrganizationBundleReportFilesByOrganization" resultMap="BaseResultMap">
  	select * from organizationreportdetails
  	where assessmentprogramid = #{assessmentProgramId}
  	and gradeid is null
  	and contentareaid is null
  	<if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    and organizationid = #{organizationId, jdbcType=BIGINT} 
    <if test="reportType != null">
    	and reporttype = #{reportType,jdbcType=VARCHAR}
    </if> 
  </select>
  
  <select id="getAllStudentSummaryBundledReportsByAssessmentProgramIdForUserState" resultMap="BaseResultMap">
  	select * from organizationreportdetails
  	where assessmentprogramid = #{assessmentProgramId}
  	and gradeid is null
  	and contentareaid is null
  	<if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    and organizationid in (select id from organization_children_oftype(#{organizationId, jdbcType=BIGINT},'SCH'))
    <if test="reportType != null">
    	and reporttype = #{reportType}
    </if>  
  </select>
  
  <delete id="deleteAllStudentSummaryBundleReportsForUserState">
  	delete from organizationreportdetails
	where assessmentprogramid = #{assessmentProgramId}	
	and gradeid is null
	and contentareaid is null
	 <if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
     and organizationid in (select id from organization_children_oftype(#{organizationId, jdbcType=BIGINT},'SCH')) 
     <if test="reportType != null">
    	and reporttype = #{reportType}
    </if>
  </delete>
  
  <select id="getAllDistrictLevelStudentSummaryBundleReports" resultMap="BaseResultMap">
  	SELECT * FROM organizationreportdetails
	  	WHERE assessmentprogramid = #{assessmentProgramId}
	  	AND gradeid is null
	  	AND contentareaid is null
	  	<if test="schoolYear != null">
	          and schoolyear = #{schoolYear, jdbcType=BIGINT}
	    </if>
	    <if test="reportType != null">
	    	AND reporttype = #{reportType,jdbcType=VARCHAR}
	    </if>
	    AND organizationid IN (SELECT id FROM organization_children(#{organizationId, jdbcType=BIGINT}) WHERE organizationtypeid IN(SELECT id FROM organizationtype WHERE typecode = 'DT'))  
  </select>
  
  <delete id="deleteAllDistrictBundleStudentSummaryReports">
  	delete from organizationreportdetails
	where assessmentprogramid = #{assessmentProgramId}	
	and gradeid is null
	and contentareaid is null
	 <if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    <if test="reportType != null">
	    	AND reporttype = #{reportType,jdbcType=VARCHAR}
	    </if>
     and organizationid in (SELECT id FROM organization_children(#{organizationId, jdbcType=BIGINT}) where organizationtypeid in(select id from organizationtype where typecode = 'DT')) 
  </delete>
  
  <select id="getAllDistrictLevelSchoolSummaryBundleReports" resultMap="BaseResultMap">
  	SELECT * FROM organizationreportdetails
	  	WHERE assessmentprogramid = #{assessmentProgramId}
	  	AND gradeid is null
	  	AND contentareaid is null
	  	<if test="schoolYear != null">
	          and schoolyear = #{schoolYear, jdbcType=BIGINT}
	    </if>
	    <if test="reportType != null">
	    	AND reporttype = #{reportType,jdbcType=VARCHAR}
	    </if>
	    AND organizationid IN (SELECT id FROM organization_children(#{organizationId, jdbcType=BIGINT}) WHERE organizationtypeid IN(SELECT id FROM organizationtype WHERE typecode = 'DT'))  
  </select>
  
  <delete id="deleteAllDistrictBundleSchoolSummaryReports">
  	delete from organizationreportdetails
	where assessmentprogramid = #{assessmentProgramId}	
	and gradeid is null
	and contentareaid is null
	 <if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    <if test="reportType != null">
	    	AND reporttype = #{reportType,jdbcType=VARCHAR}
	    </if>
     and organizationid in (select id from organization_children(#{organizationId, jdbcType=BIGINT}) where organizationtypeid in(select id from organizationtype where typecode = 'DT')) 
  </delete>
  
  <select id="getDistrictIdsForSchoolSummaryBundledReports" resultType="Long">  
	   SELECT DISTINCT otd.districtid 
		   FROM organizationreportdetails ord
		   JOIN organizationtreedetail otd ON otd.schoolid = ord.organizationid
		   WHERE ord.assessmentprogramid = #{assessmentProgramId}
		   AND ord.schoolyear = #{currentSchoolYear}
		   <if test="reportType != null">
			   AND ord.reporttype = #{reportType}
		   </if>
		   AND otd.stateid = #{stateId}
		   AND ord.gradeid is null
		   AND ord.contentareaid is null
		   ORDER BY otd.districtid
		   <if test="pageSize != null">
		   LIMIT #{pageSize} 
		   </if>
		   <if test="offset != null">
		   OFFSET #{offset}
		   </if>
  </select>
  
  <select id="getSchoolReportsForSchoolSummaryDistrictBundledReport" resultMap="schoolZipMap">
	   SELECT * FROM(SELECT DISTINCT ON(ord.organizationid, trim(ord.detailedreportpath))
			ord.detailedreportpath, otd.schoolid as organizationid, otd.districtid, otd.stateid, otd.districtdisplayidentifier,
			otd.districtname as organizationname, otd.schoolname
			FROM organizationreportdetails ord
				   JOIN organizationtreedetail otd ON otd.schoolid = ord.organizationid
				   WHERE ord.assessmentprogramid = #{assessmentProgramId}
				   AND ord.schoolyear = #{schoolYear}
				   AND otd.districtid = #{districtId}
				   <if test="reportType != null">
				   	AND ord.reporttype = #{reportType}
				   </if>
				   AND ord.gradeid is null
				   AND ord.contentareaid is null
		) ordetails ORDER BY schoolname
	                 
  </select>
  
   <delete id="deleteOrganizationReportsByOrganizationIdReportType">  	
  	delete from organizationreportdetails  
	where organizationid = 
	ANY (
		select distinct(districtid) 
		from organizationtreedetail
		where stateid =  #{stateId, jdbcType=VARCHAR} 		  
		union 
		select #{stateId, jdbcType=VARCHAR} 
	)	
	and assessmentprogramid = #{assessmentProgramId, jdbcType=BIGINT}	
	<if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
  	     	  
    <if test="reportTypes.size &gt; 1">
      		AND reporttype = ANY(ARRAY 
	        <foreach close="]" collection="reportTypes" item="reportType" open="[" separator=",">
	    	    	#{reportType,jdbcType=VARCHAR}
	        </foreach>
	        )	
	</if>  	  
  </delete>
  
   <select id="getAllDistrictReportsPdfFileByStateId" resultMap="BaseResultMap">
  	select * from organizationreportdetails  
	where organizationid = 
	ANY (
		select distinct(districtid) 
		from organizationtreedetail
		where stateid =  #{stateId, jdbcType=VARCHAR} 		  
		union 
		select #{stateId, jdbcType=VARCHAR} 
	)	
	and assessmentprogramid = #{assessmentProgramId, jdbcType=BIGINT}	
	<if test="schoolYear != null">
          and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
  	     	  
  	 <if test="reportTypes.size &gt; 1">
      		AND reporttype = ANY(ARRAY 
	        <foreach close="]" collection="reportTypes" item="reportType" open="[" separator=",">
	    	    	#{reportType,jdbcType=VARCHAR}
	        </foreach>
	        )	
	</if>
  </select>
  
  <delete id="deleteByStateSchoolYearAssessmentProgramReportType">
  delete from organizationreportdetails ord 
  	using organizationtreedetail otd 
  	where ord.organizationid=otd.schoolid 
  		and otd.stateid=#{stateId} 
  		and ord.schoolyear=#{schoolYear} 
  		and ord.assessmentprogramid=#{assessmentProgramId} 
  		and ord.reporttype=#{reportType} 
  </delete>
  <select id="getAllStudentSummaryBundledReports" parameterType="map" resultMap="BaseResultMap">
   	 SELECT *
     FROM organizationreportdetails ord
     
     WHERE
     ord.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} AND
     ord.schoolYear= #{reportYear} AND
     	ord.detailedreportpath IS NOT NULL 
   	  	<if test="schoolIds != null">
      		AND ord.organizationid = ANY(ARRAY 
	        <foreach close="]" collection="schoolIds" item="schoolId" open="[" separator=",">
	    	    	#{schoolId,jdbcType=BIGINT}
	        </foreach>)	
	    </if>
	    <if test="reportType != null">
	    	AND ord.reporttype = #{reportType}
	    </if>
	    AND ord.contentareaid IS NULL
     ORDER BY (select filename[array_length(regexp_split_to_array(ord.detailedreportpath, '/'), 1)]
		from (select regexp_split_to_array(ord.detailedreportpath, '/')) as filepath(filename)) ASC
   </select>
   
   <select id="getSchoolIdsInDistrictOfSummaryBundledReports" parameterType="map" resultType="java.lang.Long">
     SELECT distinct organizationid
		FROM organizationreportdetails ord
		JOIN organizationtreedetail otd 
	                ON otd.schoolid = ord.organizationid
	        <!-- INNER JOIN (select org.reportyear from organization_parent(#{districtId,jdbcType=BIGINT}) orgParent 
	     	INNER JOIN organization org ON org.id=orgParent.id where orgParent.contractingorganization is true) as org ON schoolyear = org.reportyear -->
	     	WHERE ord.schoolYear = #{reportYear} AND otd.districtid = #{districtId,jdbcType=BIGINT}
	    <if test="reportType != null"> 	 
			AND ord.reporttype = #{reportType}
		</if>	
		AND ord.detailedreportpath is not null
		AND ord.assessmentprogramid = {assessmentProgramId}
   </select>
   
   <select id="getAllSchoolSummaryBundledReportByDistrictId" parameterType="map" resultMap="BaseResultMap">
   	 SELECT *
     FROM organizationreportdetails ord
     <!-- INNER JOIN (select org.reportyear from 
      organization_parent(#{districtId,jdbcType=BIGINT}
     ) orgParent
     INNER JOIN organization org ON org.id=orgParent.id where orgParent.contractingorganization is true) as org ON ord.schoolyear = org.reportyear 
	 ord.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}-->
     WHERE
     	ord.detailedreportpath IS NOT NULL 
      		AND ord.organizationid = #{districtId,jdbcType=BIGINT}
	       <if test="reportType != null">
	    	AND ord.reporttype = #{reportType}
	    </if>	    
	    <if test="reportYear != null">
	    	AND ord.schoolyear = #{reportYear}
	    </if>    
	    AND ord.contentareaid IS NULL
     ORDER BY (select filename[array_length(regexp_split_to_array(ord.detailedreportpath, '/'), 1)]
		from (select regexp_split_to_array(ord.detailedreportpath, '/')) as filepath(filename)) ASC
   </select>
   
   <select id="getAllSchoolSummaryReports" parameterType="map" resultMap="BaseResultMap">
     SELECT distinct ord.*
     FROM organizationreportdetails ord
     <!-- INNER JOIN (select org.reportyear from 
       organization_parent(#{organizationId,jdbcType=BIGINT}
     ) orgParent
     INNER JOIN organization org ON org.id=orgParent.id where orgParent.contractingorganization is true) as org ON ord.schoolyear = org.reportyear -->
     WHERE
     ord.schoolYear = #{reportYear}
     AND 
       ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{organizationId,jdbcType=BIGINT}
       AND ord.gradeid IS NULL
       AND ord.assessmentprogramid = #{assessmentProgramId} 
       AND ord.contentareaid IS NULL
       <if test="reportType != null">
	    	AND ord.reporttype = #{reportType}
	   </if>
	   <if test="teacherId != null">
	   		AND ord.teacherid = #{teacherId,jdbcType=BIGINT}
	   </if>
	   
	   UNION ALL
	   
	 SELECT distinct ord.*
	 FROM organizationreportdetails ord
    <!--  INNER JOIN (select org.reportyear from 
       organization_parent(#{organizationId,jdbcType=BIGINT}
     ) orgParent
     INNER JOIN organization org ON org.id=orgParent.id where orgParent.contractingorganization is true) as org ON ord.schoolyear = org.reportyear -->
    INNER JOIN organizationoperationaldetail ood ON ood.targetorgid = #{organizationId,jdbcType=BIGINT}
     WHERE
     ord.schoolYear = #{reportYear} AND 
       ord.detailedreportpath IS NOT NULL AND ood.activeflag = true
       AND ord.organizationid = ood.sourceorgid
       AND ord.gradeid IS NULL 
       AND ord.assessmentprogramid = #{assessmentProgramId} 
       AND ord.contentareaid IS NULL
       <if test="reportType != null">
	    	AND ord.reporttype = #{reportType}
	   </if>
	   <if test="teacherId != null">
	   		AND ord.teacherid = #{teacherId,jdbcType=BIGINT}
	   </if>
   </select>
   
   <select id="getAllTeacherNamesForClassroomReports" parameterType="map" resultMap="BaseResultMap">
     SELECT distinct ord.teacherid, (au.surname || ' ' || au.firstname) as teachername
     FROM organizationreportdetails ord
     <!-- INNER JOIN (select org.reportyear from 
       organization_parent(#{organizationId,jdbcType=BIGINT}
     ) orgParent
     INNER JOIN organization org ON org.id=orgParent.id where orgParent.contractingorganization is true) as org ON ord.schoolyear = org.reportyear -->
     INNER JOIN aartuser au ON ord.teacherid = au.id
     WHERE
       ord.detailedreportpath IS NOT NULL
       AND ord.organizationid = #{organizationId,jdbcType=BIGINT}
       AND ord.gradeid IS NULL
       AND ord.assessmentprogramid = #{assessmentProgramId} 
       AND ord.contentareaid IS NULL
       <if test="reportType != null">
	    	AND ord.reporttype = #{reportType}
	   </if>
	   <if test="selectreportType =='alternate_classroom'">
	   AND ord.schoolyear = #{reportYear}
	   </if>
	   order by teachername
   </select>
   
   <select id="selectClassroomReport"  resultMap="BaseResultMap">
  	select * from organizationreportdetails ord 
  	join organizationtreedetail otd on ord.organizationid=otd.schoolid 
  	where otd.stateid=#{stateId} 
  	and ord.teacherid=#{teacherId} 
  	and ord.organizationid=#{schoolId} 
  	and ord.schoolyear=#{schoolYear} 
  	and ord.assessmentprogramid=#{assessmentProgramId} 
  	and ord.reporttype='Classroom'
  	<if test="contentAreaId != null">
  	and ord.contentareaid=#{contentAreaId}
  	</if>
  	<if test="gradeId != null">
  	and ord.gradeid=#{gradeId}
  	</if>
  </select>
  
  <select id="selectSchoolReport"  resultMap="BaseResultMap">
  	select * from organizationreportdetails ord 
  	join organizationtreedetail otd on ord.organizationid=otd.schoolid 
  	where otd.stateid=#{stateId}  
  	and ord.organizationid=#{schoolId} 
  	and ord.schoolyear=#{schoolYear} 
  	and ord.assessmentprogramid=#{assessmentProgramId} 
  	and ord.reporttype='School'
  </select>
  
    <insert id="inserResults" >   
    insert into organizationreportdetails (assessmentprogramid, contentareaid, 
      gradeid, organizationid, schoolyear, 
      createddate, detailedreportpath, schoolreportpdfpath, 
      schoolreportpdfsize, schoolreportzipsize, 
      batchreportprocessid, gradecourseabbrname, 
      summaryreportpath, reporttype, teacherid, 
      schoolname, districtname, detailedreportpath_csv, summaryreportcsvpath, 
      modifieddate, createduser, modifieduser,scalescore,standarderror,
      testingprogramid,assessmentcode,reportcycle
      )
    values (#{assessmentProgramId,jdbcType=BIGINT}, #{subjectId,jdbcType=BIGINT}, 
      #{gradeId,jdbcType=BIGINT}, #{organizationId,jdbcType=BIGINT}, #{schoolYear,jdbcType=BIGINT}, 
      now(), null, null, 
      null, null, 
      #{batchUploadedId,jdbcType=BIGINT}, null, 
      null, #{reportType,jdbcType=VARCHAR}, null, 
      #{schoolName,jdbcType=VARCHAR}, #{districtName,jdbcType=VARCHAR}, null, null, 
      now(), #{createdUser,jdbcType=BIGINT}, #{modifiedUser,jdbcType=BIGINT},
      #{scaleScore, jdbcType=BIGINT}, #{standardError,jdbcType=BIGINT}, #{testingProgramInternalId,jdbcType=BIGINT},#{testType,jdbcType=VARCHAR},
      #{reportCycle, jdbcType=VARCHAR}
      )
  </insert>
   <delete id="deleteOrganizationReportDetailForCpassReport">
  delete from organizationreportdetails
	where 
	assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
	<if test="schoolYear != null">	
	     and schoolyear = #{schoolYear,jdbcType=BIGINT}
	</if>
	<if test="reportCycle != null">
  	     and reportcycle=#{reportCycle,jdbcType=VARCHAR}
  	</if>
  	<if test="reportType != null">
  	    and reporttype = #{reportType,jdbcType=VARCHAR}
  	</if>
  	<if test="testingProgramId != null">
  	    and testingprogramid = #{testingProgramId,jdbcType=VARCHAR}
  	</if>
	<if test="subjectId != null">
		and contentAreaId = #{subjectId,jdbcType=BIGINT}
	</if>
	<if test="gradeId != null">
			and gradeid =#{gradeId,jdbcType=BIGINT} 
	</if>
	<if test="stateId != null">
		and organizationid in (select id from organization_children_Active_or_Inactive(#{stateId,jdbcType=BIGINT}) union SELECT #{stateId,jdbcType=BIGINT})
	</if>
  </delete>
  <select id = "getOrganizationReportDetailByReportCycle" resultMap="BaseResultMap">
	  select * from organizationreportdetails
	  where assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}	
		and schoolyear = #{schoolYear,jdbcType=BIGINT}
		and testingprogramid=#{testingProgramId,jdbcType=BIGINT}
	  	and reportcycle=#{reportCycle,jdbcType=VARCHAR}
	  	and reporttype = #{reportType,jdbcType=VARCHAR}
		<if test="subjectId != null">
			and contentAreaId = #{subjectId,jdbcType=BIGINT}
		</if>
		<if test="gradeId != null">
			and gradeid =#{gradeId,jdbcType=BIGINT} 
		</if>
		<if test="stateId != null">
			and organizationid in (select id from organization_children_Active_or_Inactive(#{stateId,jdbcType=BIGINT}) union SELECT #{stateId,jdbcType=BIGINT})
		</if>  
  </select>
  
  <update id = "clearOrganizationReportDetail" >
	  update organizationreportdetails set detailedreportpath = null, modifieddate = now(), modifieduser = #{uploadedUser,jdbcType=BIGINT}
	  where assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}	
		and schoolyear = #{schoolYear,jdbcType=BIGINT}
		and testingprogramid=#{testingProgramId,jdbcType=BIGINT}
	  	and reportcycle=#{reportCycle,jdbcType=VARCHAR}
	  	and reporttype = #{reportType,jdbcType=VARCHAR}
		<if test="subjectId != null">
			and contentAreaId = #{subjectId,jdbcType=BIGINT}
		</if>
		<if test="stateId != null">
			and organizationid in (select id from organization_children_Active_or_Inactive(#{stateId,jdbcType=BIGINT}) union SELECT #{stateId,jdbcType=BIGINT})
		</if>  
  </update>
  
   <update id="updateResults" >
   		 update organizationreportdetails  
    	 set  modifieddate = now(), 
    	 modifieduser = #{createdUser,jdbcType=BIGINT},
    	 scalescore = #{scaleScore, jdbcType=BIGINT},
    	 standarderror = #{standardError,jdbcType=BIGINT}
    	 where organizationid = #{organizationId,jdbcType=BIGINT}
    	 and  assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
		<if test="subjectId != null">
			and contentareaid =#{subjectId,jdbcType=BIGINT}
		</if>
		<if test="gradeId != null">
			and gradeid =#{gradeId,jdbcType=BIGINT} 
		</if> 
		and assessmentcode = #{testType,jdbcType=VARCHAR}
	    and reportcycle = #{reportCycle, jdbcType=VARCHAR}
	    and testingprogramid = #{testingProgramInternalId, jdbcType=BIGINT}
		and schoolyear = #{schoolYear,jdbcType=BIGINT} 
		and reporttype = #{reportType,jdbcType=VARCHAR}
   </update>
   
    <select id = "getOrganizationReportDetails" resultMap="BaseResultMap">
	  select * from organizationreportdetails
	  where assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}	
		and schoolyear = #{schoolYear,jdbcType=BIGINT}
		<if test="stateId != null">
			and organizationid in (select id from organization_children_Active_or_Inactive(#{stateId,jdbcType=BIGINT}) union SELECT #{stateId,jdbcType=BIGINT})
		</if>  
  </select> 
  
   <delete id="deleteAllOrganizationReportDetails">
  delete from organizationreportdetails
	where 
	assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
	<if test="schoolYear != null">	
	     and schoolyear = #{schoolYear,jdbcType=BIGINT}
	</if>	
	<if test="stateId != null">
		and organizationid in (select id from organization_children_Active_or_Inactive(#{stateId,jdbcType=BIGINT}) union SELECT #{stateId,jdbcType=BIGINT})
	</if>
  </delete>  
  
  <!-- test -->
  <select id="getStudentsCountOfDistrictlLevel" resultType="java.lang.Long">
  select count(*) from organizationreportdetails where organizationid in 
  (select id from organization_children(#{stateId,jdbcType=BIGINT}) where organizationtypeid in(select id from organizationtype where typecode = 'DT'))
  and
  reporttype = #{reportType,jdbcType=VARCHAR}
  and
  assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
  and
  schoolyear = #{reportYear}
  </select>
  
  <select id="getexternelStudentsCountOfDistrictlLevel" resultType="java.lang.Long">
  select count(studentreport_grade) from (select 1 
  from 
  externalstudentreports es,
  gradecourse gc
  where gc.id = es.gradeid and
  es.districtid in 
  (select id from organization_children(#{stateId,jdbcType=BIGINT}) 
  where organizationtypeid in(select id from organizationtype where typecode = 'DT')) 
  and
  es.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} and 
  es.schoolyear = #{reportYear} and 
  es.reporttype = #{reportType,jdbcType=VARCHAR} and 
  es.filepath is not null group by es.districtid)studentreport_grade
  </select>
  
  <select id="getStateName" resultType="java.lang.String">
  select organizationname from organization where id=#{stateId,jdbcType=BIGINT}
  </select>
  
  <select id="getStudentsCountOfSchoolLevel" resultType="java.lang.Long">
  select count(*) from organizationreportdetails where organizationid in 
  (select id from organization_children_oftype(#{stateId,jdbcType=BIGINT},'SCH'))
  and
  reporttype = #{reportType,jdbcType=VARCHAR}
  and
  assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
  and
  schoolyear = #{reportYear}
  </select>
  
  <select id="getexternelStudentsCountOfSchoolLevel" resultType="java.lang.Long">
  select count(studentreport_grade) from 
  (select 1 from externalstudentreports es, gradecourse gc where gc.id = es.gradeid and es.schoolid in 
  (select id from organization_children_oftype(#{stateId,jdbcType=BIGINT},'SCH')) 
  and es.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} 
  and es.schoolyear = #{reportYear} 
  and es.reporttype = #{reportType,jdbcType=VARCHAR} 
  and es.filepath is not null group by gc.abbreviatedname, es.schoolid)studentreport_grade
  </select>
  
  <select id="getSchoolSummaryBundleCountOfDistrictlLevel" resultType="java.lang.Long">
 	select count(distinct ord.organizationid)
		from organizationreportdetails ord 
		where
			ord.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
			AND ord.schoolyear = #{reportYear}
			AND ord.organizationid in (select id from organization_children_active_or_inactive(#{stateId,jdbcType=BIGINT}) 
 			where organizationtypeid in(select id from organizationtype where typecode = 'DT')) 
			AND ord.reporttype = #{reportType,jdbcType=VARCHAR}
  </select>
  
  <select id="getSchoolSummaryCountOfDistrictlLevel" resultType="java.lang.Long">
 		 SELECT count(DISTINCT otd.districtid) 
		   FROM organizationreportdetails ord
		   JOIN organizationtreedetail otd ON otd.schoolid = ord.organizationid
		   WHERE ord.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
		   AND ord.schoolyear = #{reportYear}
		   AND ord.reporttype = #{reportType,jdbcType=VARCHAR}
		   AND otd.stateid = #{stateId,jdbcType=BIGINT}
  </select>
</mapper>
  