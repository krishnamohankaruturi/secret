<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.DashboardMessageMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.DashboardMessage">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 29 12:02:58 CDT 2018.
    -->
    <result column="id" jdbcType="BIGINT" property="id" />
    <result column="assessmentprogramid" jdbcType="BIGINT" property="assessmentProgramId" />
    <result column="recordtype" jdbcType="VARCHAR" property="recordType" />
    <result column="studentid" jdbcType="BIGINT" property="studentId" />
    <result column="enrollmentid" jdbcType="BIGINT" property="enrollmentId" />
    <result column="attendanceschoolid" jdbcType="BIGINT" property="attendanceSchoolId" />
    <result column="contentareaid" jdbcType="BIGINT" property="contentAreaId" />
    <result column="gradebandid" jdbcType="BIGINT" property="gradeBandId" />
    <result column="schoolyear" jdbcType="BIGINT" property="schoolYear" />
    <result column="rosterid" jdbcType="BIGINT" property="rosterId" />
    <result column="classroomid" jdbcType="BIGINT" property="classroomId" />
    <result column="message" jdbcType="VARCHAR" property="message" />
    <result column="batchregistrationid" jdbcType="BIGINT" property="batchRegistrationId" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
    <result column="createduser" jdbcType="BIGINT" property="createdUser" />
    <result column="modifieduser" jdbcType="BIGINT" property="modifiedUser" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
  </resultMap>
  
   <resultMap id="TestAssignmentResultMap" type="edu.ku.cete.domain.testerror.TestAssignmentErrorRecord">
    <result column="assessmentprogramid" jdbcType="BIGINT" property="assessmentProgramId" />
    <result column="recordtype" jdbcType="VARCHAR" property="recordType" />
    <result column="studentid" jdbcType="BIGINT" property="studentId" />
    <result column="enrollmentid" jdbcType="BIGINT" property="enrollmentId" />
    <result column="attendanceschoolid" jdbcType="BIGINT" property="attendanceSchoolId" />
    <result column="contentareaid" jdbcType="BIGINT" property="contentAreaId" />
    <result column="gradebandid" jdbcType="BIGINT" property="gradeBandId" />
    <result column="schoolyear" jdbcType="BIGINT" property="schoolYear" />
    <result column="rosterid" jdbcType="BIGINT" property="rosterId" />
    <result column="classroomid" jdbcType="BIGINT" property="classroomId" />
    <result column="message" jdbcType="VARCHAR" property="message" />
    <result column="batchregistrationid" jdbcType="BIGINT" property="batchRegistrationId" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
    <result column="createduser" jdbcType="BIGINT" property="createdUser" />
    <result column="modifieduser" jdbcType="BIGINT" property="modifiedUser" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="ssid" jdbcType="VARCHAR" property="ssid" />
    <result column="school" jdbcType="VARCHAR" property="school" />
    <result column="course" jdbcType="VARCHAR" property="course" />
    <result column="educatorid" jdbcType="VARCHAR" property="educatorId" />
    <result column="studentfirstname" jdbcType="VARCHAR" property="studentFirstName" />
    <result column="studentlaststname" jdbcType="VARCHAR" property="studentLastName" />
    <result column="educatorfirstname" jdbcType="VARCHAR" property="educatorFirstName" />
    <result column="educatorlastname" jdbcType="VARCHAR" property="educatorLastName" />
    
  </resultMap>
  
   <resultMap id="AllTestAssignmentResultMap" type="edu.ku.cete.domain.testerror.TestAssignmentErrorRecordDTO">
    <result column="classroomid" jdbcType="BIGINT" property="classroomId" />
    <result column="message" jdbcType="VARCHAR" property="message" />
	<result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="ssid" jdbcType="VARCHAR" property="ssid" />
    <result column="school" jdbcType="VARCHAR" property="school" />
    <result column="course" jdbcType="VARCHAR" property="course" />
    <result column="educatorid" jdbcType="VARCHAR" property="educatorId" />
    <result column="studentfirstname" jdbcType="VARCHAR" property="studentFirstName" />
    <result column="studentlaststname" jdbcType="VARCHAR" property="studentLastName" />
    <result column="educatorfirstname" jdbcType="VARCHAR" property="educatorFirstName" />
    <result column="educatorlastname" jdbcType="VARCHAR" property="educatorLastName" />
    
  </resultMap>
  
  
  <sql id="Base_Column_List" >
  		id, assessmentprogramid, recordtype, studentid, enrollmentid, attendanceschoolid, contentareaid, gradebandid, schoolyear,
  		rosterid, classroomid, message, batchregistrationid, activeflag, createduser, modifieduser, createddate, modifieddate
  </sql>
  <insert id="insert" parameterType="edu.ku.cete.domain.DashboardMessage">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 29 12:02:58 CDT 2018.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('dashboardmessage_id_seq')
    </selectKey>
    insert into dashboardmessage (id, assessmentprogramid, recordtype, 
      studentid, enrollmentid, attendanceschoolid, 
      contentareaid, gradebandid,schoolyear, rosterid, 
      classroomid, message, batchregistrationid, 
      activeflag, createduser, modifieduser, 
      createddate, modifieddate)
    values (#{id,jdbcType=BIGINT}, #{assessmentProgramId,jdbcType=BIGINT}, #{recordType,jdbcType=VARCHAR}, 
      #{studentId,jdbcType=BIGINT}, #{enrollmentId,jdbcType=BIGINT}, #{attendanceSchoolId,jdbcType=BIGINT}, 
      #{contentAreaId,jdbcType=BIGINT}, #{gradeBandId,jdbcType=BIGINT}, #{schoolYear,jdbcType=BIGINT}, #{rosterId,jdbcType=BIGINT}, 
      #{classroomId,jdbcType=BIGINT}, #{message,jdbcType=VARCHAR}, #{batchRegistrationId,jdbcType=BIGINT}, 
      #{activeFlag,jdbcType=BIT}, #{createdUser,jdbcType=BIGINT}, #{modifiedUser,jdbcType=BIGINT}, 
      #{createdDate,jdbcType=TIMESTAMP}, #{modifiedDate,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.DashboardMessage">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 29 12:02:58 CDT 2018.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('dashboardmessage_id_seq')
    </selectKey>
    insert into dashboardmessage
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="assessmentProgramId != null">
        assessmentprogramid,
      </if>
      <if test="recordType != null">
        recordtype,
      </if>
      <if test="studentId != null">
        studentid,
      </if>
      <if test="enrollmentId != null">
        enrollmentid,
      </if>
      <if test="attendanceSchoolId != null">
        attendanceschoolid,
      </if>
      <if test="contentAreaId != null">
        contentareaid,
      </if>
      <if test="gradeBandId != null">
        gradebandid,
      </if>
      <if test="schoolYear != null">
        schoolyear,
      </if>
      <if test="rosterId != null">
        rosterid,
      </if>
      <if test="classroomId != null">
        classroomid,
      </if>
      <if test="message != null">
        message,
      </if>
      <if test="batchRegistrationId != null">
        batchregistrationid,
      </if>
      <if test="activeFlag != null">
        activeflag,
      </if>
      <if test="createdUser != null">
        createduser,
      </if>
      <if test="modifiedUser != null">
        modifieduser,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="assessmentProgramId != null">
        #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="recordType != null">
        #{recordType,jdbcType=VARCHAR},
      </if>
      <if test="studentId != null">
        #{studentId,jdbcType=BIGINT},
      </if>
      <if test="enrollmentId != null">
        #{enrollmentId,jdbcType=BIGINT},
      </if>
      <if test="attendanceSchoolId != null">
        #{attendanceSchoolId,jdbcType=BIGINT},
      </if>
      <if test="contentAreaId != null">
        #{contentAreaId,jdbcType=BIGINT},
      </if>
      <if test="gradeBandId != null">
        #{gradeBandId,jdbcType=BIGINT},
      </if>
      <if test="schoolYear != null">
        #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="rosterId != null">
        #{rosterId,jdbcType=BIGINT},
      </if>
      <if test="classroomId != null">
        #{classroomId,jdbcType=BIGINT},
      </if>
      <if test="message != null">
        #{message,jdbcType=VARCHAR},
      </if>
      <if test="batchRegistrationId != null">
        #{batchRegistrationId,jdbcType=BIGINT},
      </if>
      <if test="activeFlag != null">
        #{activeFlag,jdbcType=BIT},
      </if>
      <if test="createdUser != null">
        #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedUser != null">
        #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  
  <select id="getDashboardMessages" resultMap="BaseResultMap" parameterType="edu.ku.cete.domain.DashboardMessage">
  		SELECT DISTINCT <include refid="Base_Column_List" />
  		FROM dashboardmessage
  		WHERE activeflag is true
  		<if test="assessmentProgramId != null">
  			AND assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
  		</if>  		
  		<if test="studentId != null">
  			AND studentid = #{studentId,jdbcType=BIGINT}
  		</if>
  		<if test="schoolYear != null">
  			AND schoolyear = #{schoolYear,jdbcType=BIGINT}
  		</if>
  		<if test="contentAreaId != null">
  			AND contentareaid = #{contentAreaId,jdbcType=BIGINT}
  		</if>
  		<if test="gradeBandId != null">
  			AND gradebandid = #{gradeBandId,jdbcType=BIGINT}
  		</if>
  		
  </select>
  
 <!--  Changes for F845 Test Assignment Errors Dashboard -->
 
  <sql id="findTestAssignmentErrorsToView">
  	select dm.id,
  	dm.createddate as createddate, 
  	st.statestudentidentifier as ssid, 
  	dm.message, 
  	org.schoolname as school, 
  	ct.name as course, 
  	dm.classroomid, 
  	aart.uniquecommonidentifier as educatorid,
  	st.legalfirstname as studentfirstname, 
  	st.legallastname as studentlastname, 
  	aart.firstname as educatorfirstname, 
  	aart.surname as educatorlastname
 	from dashboardmessage dm
	inner join student st on dm.studentid = st.id
	inner join organizationtreedetail org on dm.attendanceschoolid = org.schoolid
	inner join roster rt on dm.rosterid = rt.id
	inner join aartuser aart on rt.teacherid = aart.id
	inner join contentarea ct on dm.contentareaid = ct.id
	WHERE org.stateid = #{stateId,jdbcType=BIGINT} 
	AND (org.schoolid = #{organizationId,jdbcType=BIGINT} OR org.districtid = #{organizationId,jdbcType=BIGINT})
	AND dm.activeflag is true
	<if test="isTeacher">
		AND rt.teacherid = #{curUserID}
	</if>
  </sql>
  
  <sql id="findTestAssignmentErrorsToViewWhere">
  
  	WHERE 1=1 	
  	<if test="id != null">AND (dm.id) like ('%' || #{id} || '%')</if>
  	<if test="createdDate != null">AND (dbm.createddate) like ('%' || #{createdDate} || '%')</if>
  	<if test="ssid != null">AND upper(dbm.ssid) like upper('%' || #{ssid} || '%')</if>
  	<if test="message != null">AND upper(dbm.message) like upper('%' || #{message} || '%')</if>
  	<if test="school != null">AND upper(dbm.school) like upper('%' || #{school} || '%')</if>  
  	<if test="course != null">AND upper(dbm.course) like upper('%' || #{course} || '%')</if>	
  	<if test="classroomId != null">AND (dbm.classroomid::text) like ('%' || #{classroomId} || '%')</if>
  	<if test="educatorId != null">AND upper(dbm.educatorid) like upper('%' || #{educatorId} || '%')</if>
  	<if test="studentFirstName != null">AND upper(dbm.studentfirstname) like upper('%' || #{studentFirstName} || '%')</if>
  	<if test="studentLastName != null">AND upper(dbm.studentlastname) like upper('%' || #{studentLastName} || '%')</if>
  	<if test="educatorFirstName != null">AND upper(dbm.educatorfirstname) like upper('%' || #{educatorFirstName} || '%')</if>
  	<if test="educatorLastName != null">AND upper(dbm.educatorlastname) like upper('%' || #{educatorLastName} || '%')</if>
  </sql>
  
  <select id="getTestAssignmentErrors"  resultMap="TestAssignmentResultMap" parameterType="hashmap" useCache="false">  	
  	/*NO LOAD BALANCE*/
		SELECT * FROM  (<include refid="findTestAssignmentErrorsToView"/>) AS dbm
		<include refid="findTestAssignmentErrorsToViewWhere"/> 
    	<if test="sortByColumn != null">
    	ORDER BY   	
    		<choose>
	      		<when test="sortByColumn == 'date'">dbm.createddate</when>
	  			<when test="sortByColumn == 'ssid'" >dbm.ssid</when>
	  			<when test ="sortByColumn == 'message'">dbm.message</when>
	      		<when test="sortByColumn == 'school'">dbm.school</when>
	      		<when test="sortByColumn == 'course'">dbm.course</when>
	      		<when test="sortByColumn == 'classroomId'">dbm.classroomid</when>
	      		<when test="sortByColumn == 'educatorId'">dbm.educatorid</when>
	      		<when test="sortByColumn == 'studentFirstName'">dbm.studentfirstname</when>
	      		<when test="sortByColumn == 'studentLastName'">dbm.studentlastname</when>
	      		<when test="sortByColumn == 'educatorFirstName'">dbm.educatorfirstname</when>
	      		<when test="sortByColumn == 'educatorLastName'">dbm.educatorlastname</when>
	      	</choose>	
		<if test="sortType=='desc'">
    		desc
   	 	</if>
   	 	<if test="sortType=='asc' or sortType==null">
   	 		asc
   	 	</if>
   	 	</if>
  	 		
    	LIMIT #{limit}
    	OFFSET #{offset}
  </select>
  
  
  
  <select id="getCountOfTestAssignmentErrors" resultType="java.lang.Integer" parameterType="hashmap"  useCache="false">
		/*NO LOAD BALANCE*/
   		SELECT count(1) FROM  (<include refid="findTestAssignmentErrorsToView"/>) AS dbm
			<include refid="findTestAssignmentErrorsToViewWhere"/> 
  </select>
  
  <select id="getAllTestAssignmentErrorMessages" resultMap="AllTestAssignmentResultMap" parameterType="hashmap" useCache="false">
		SELECT * FROM  (<include refid="findTestAssignmentErrorsToView"/>) AS dbm
			<include refid="findTestAssignmentErrorsToViewWhere"/> 
  </select>
  
  <!-- <select id="getMessagesByStudentIdAssmntProgramIdSchYr" resultMap="BaseResultMap" parameterType="edu.ku.cete.domain.DashboardMessage">
  		SELECT DISTINCT <include refid="Base_Column_List" />
  		FROM dashboardmessage
  		WHERE activeflag is true
  		<if test="assessmentProgramId != null">
  			AND assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
  		</if>  		
  		<if test="studentId != null">
  			AND studentid = #{studentId,jdbcType=BIGINT}
  		</if>
  		<if test="schoolYear != null">
  			AND schoolyear = #{schoolYear,jdbcType=BIGINT}
  		</if>
  		<if test="contentAreaId != null">
  			AND contentareaid = #{contentAreaId,jdbcType=BIGINT}
  		</if>
  		<if test="gradeBandId != null">
  			AND gradebandid = #{gradeBandId,jdbcType=BIGINT}
  		</if>
  		
  </select> -->
  
  <update id="updateMessages" parameterType="edu.ku.cete.domain.DashboardMessage">
  		UPDATE dashboardmessage
  		SET	message = #{message,jdbcType=VARCHAR},
  		modifieddate = now()
  		<if test="modifiedUser != null">
  			,modifieduser = #{modifiedUser,jdbcType=BIGINT}
  		</if>
  		WHERE activeflag is true 
  			<if test="studentId != null">
  				AND studentid = #{studentId,jdbcType=BIGINT}
  			</if>  		  			
  			<if test="assessmentProgramId != null">
  				AND assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
  			</if>
  			<if test="schoolYear != null">
  				AND schoolyear = #{schoolYear,jdbcType=BIGINT}
  			</if>
  			<if test="contentAreaId != null">
  				AND contentareaid = #{contentAreaId,jdbcType=BIGINT}
  			</if>
  			<if test="gradeBandId != null">
  				AND gradebandid = #{gradeBandId,jdbcType=BIGINT}
  			</if>
  			<if test="recordType != null">
  				AND recordtype = #{recordType,jdbcType=VARCHAR}
  			</if>
  			<if test="attendanceSchoolId != null">
  				AND attendanceschoolid = #{attendanceSchoolId,jdbcType=BIGINT}
  			</if>	
  </update>
  
  <update id="inactivateMessages" parameterType="edu.ku.cete.domain.DashboardMessage">
  		UPDATE dashboardmessage
  		SET	activeflag = false,
  		modifieddate = now()
  		<if test="modifiedUser != null">
  			,modifieduser = #{modifiedUser,jdbcType=BIGINT}
  		</if>
  		WHERE activeflag is true 
  			<if test="studentId != null">
  				AND studentid = #{studentId,jdbcType=BIGINT}
  			</if>  			  			
  			<if test="assessmentProgramId != null">
  				AND assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
  			</if>
  			<if test="schoolYear != null">
  				AND schoolyear = #{schoolYear,jdbcType=BIGINT}
  			</if>
  			<if test="contentAreaId != null">
  				AND contentareaid = #{contentAreaId,jdbcType=BIGINT}
  			</if>
  			<if test="gradeBandId != null">
  				AND gradebandid = #{gradeBandId,jdbcType=BIGINT}
  			</if>
  			<if test="recordType != null">
  				AND recordtype = #{recordType,jdbcType=VARCHAR}
  			</if>
  			<if test="attendanceSchoolId != null">
  				AND attendanceschoolid = #{attendanceSchoolId,jdbcType=BIGINT}
  			</if>	
  </update>
  
</mapper>
