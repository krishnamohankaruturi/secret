<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.ku.cete.model.student.survey.StudentSurveyResponseLabelDao" >
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.student.survey.StudentSurveyResponseLabel" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Apr 13 21:14:54 CDT 2013.
    -->
    <result column="survey_response_id" property="surveyResponseId" jdbcType="BIGINT" />
    <result column="response_label" property="responseLabel" jdbcType="VARCHAR" />
    <result column="survey_label_id" property="surveyLabelId" jdbcType="BIGINT" />
    <result column="label_number" property="labelNumber" jdbcType="VARCHAR" />
    <result column="global_page_num" property="globalPageNum" jdbcType="INTEGER" />
    <result column="survey_id" property="surveyId" jdbcType="BIGINT" />
    <result column="student_survey_response_id" property="studentSurveyResponseId" jdbcType="BIGINT" />
    <result column="student_survey_response_text" property="studentSurveyResponseText" jdbcType="VARCHAR" />
    <result column="optional" property="optional" jdbcType="BIT" />
    <result column="active_flag" property="activeFlag" jdbcType="BIT" />
  </resultMap>
  
  <resultMap id="BaseAndAnswerInfo" extends="BaseResultMap" type="edu.ku.cete.domain.student.survey.StudentSurveyResponseLabel">
    <result column="survey_response_value" property="surveyResponseValue" jdbcType="VARCHAR" />
  </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Apr 13 21:14:54 CDT 2013.
    -->
    survey_response_id, response_label, survey_label_id,
     label_number,global_page_num,
      survey_id, student_survey_response_id, 
    student_survey_response_text
  </sql>
    <select id="selectSurveyResult" resultMap="BaseAndAnswerInfo">
	Select sr.id as survey_response_id,sr.responselabel as response_label,
	sl.id as survey_label_id,sl.labelnumber as label_number,
	sl.globalPageNum as global_page_num,
	ssr.surveyid as survey_id,
	ssr.id as student_survey_response_id,
	sl.optional AS optional,
	ssr.activeflag as active_flag,
	ssr.responsetext as student_survey_response_text,
	sr.responsevalue as survey_response_value
	from surveylabel sl,surveyresponse sr left join
	  (Select * from studentsurveyresponse where surveyid=#{surveyId}) ssr on (ssr.surveyresponseid=sr.id)
	where
	sr.labelid=sl.id and sl.complexityband is true and sl.activeflag is true
  </select>
   <select id="selectExistingStudentSurveyResponseLabels"
    resultType="edu.ku.cete.domain.student.survey.StudentSurveyResponseLabel">
		SELECT 
			sl.id AS surveyLabelId, sl.labelnumber AS labelNumber, sl.label AS label,sl.globalpagenum AS globalPageNum,
			sr.id AS surveyResponseId, sr.responselabel AS responseLabel, sr.responsevalue AS responseValue,
			ssr.id AS studentSurveyResponseId, ssr.surveyresponseid AS studentResponseId, 
			ssr.responsetext AS studentSurveyResponseText,
			sl.optional AS optional,
			ssr.activeflag AS activeFlag, ssr.surveyid AS surveyId
		FROM	
			surveylabel sl 
			JOIN surveyresponse sr ON sl.id = sr.labelid 
			LEFT JOIN (SELECT * FROM studentsurveyresponse WHERE surveyid=#{surveyId}) ssr ON (ssr.surveyresponseid=sr.id)
		WHERE
			sr.labelid=sl.id
			AND sr.responselabel != '-1'
			AND sl.labelnumber  = #{labelNumber}
			AND ssr.activeflag = true
		ORDER BY surveyLabelId, responseLabel
  </select>
   <select id="selectAllowedStudentSurveyResponseLabels"
    resultType="edu.ku.cete.domain.student.survey.StudentSurveyResponseLabelInfo">
		SELECT 
			sl.id AS surveyLabelId, sl.labelnumber AS labelNumber, sl.label AS label,
			sr.id AS surveyResponseId, sr.responselabel AS responseLabel, sr.responsevalue AS responseValue,
			ssr.id AS studentSurveyResponseId, ssr.surveyresponseid AS studentResponseId, 
			ssr.responsetext AS studentSurveyResponseText, ssr.activeflag AS activeFlag,
			sl.optional AS optional,ss.surveysectionname As surveySectionName,
			ssr.surveyid AS surveyId, 
			(select categorycode from category c where categorytypeid  = 
				(select id from categorytype  where typecode  = 'FIRST_CONTACT_QUESTION_TYPES') 
					and c.id = sl.labeltype) as labelType
		FROM	
			surveylabel sl 
			JOIN surveyresponse sr ON sl.id = sr.labelid 
			LEFT JOIN
				 (SELECT * FROM studentsurveyresponse WHERE surveyid=#{surveyId}) ssr
				  ON (ssr.surveyresponseid=sr.id)
			JOIN surveysection ss ON sl.surveysectionid = ss.id
		WHERE
			sr.labelid=sl.id
			AND sl.activeflag = true
			AND sr.activeflag = true
			AND sr.responselabel != '-1'
			AND sl.globalPageNum = #{globalPageNum}
		<!--ORDER BY surveyLabelId, responseLabel-->
		ORDER BY surveyorder,labelnumber,responselabel
  </select>
   
  
</mapper>