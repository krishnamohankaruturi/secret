<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.report.model.UserAuditTrailHistoryMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.report.domain.UserAuditTrailHistory">
	<result column="id" jdbcType="BIGINT" property="id" />
    <result column="eventname" jdbcType="VARCHAR" property="eventName" />
    <result column="modifieduser" jdbcType="BIGINT" property="modifiedUser" />
    <result column="affecteduser" jdbcType="BIGINT" property="affectedUser" />
    <result column="beforevalue" jdbcType="VARCHAR" property="beforeValue" />
    <result column="currentvalue" jdbcType="VARCHAR" property="currentValue" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="domainaudithistoryid" jdbcType="BIGINT" property="domainAuditHistoryId" />
   </resultMap>


<insert id="insert" parameterType="edu.ku.cete.report.domain.UserAuditTrailHistory">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 14 15:51:01 IST 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('userAuditTrailHistory_id_seq')
    </selectKey>
    INSERT INTO useraudittrailhistory(
            id, eventname, modifieduser, affecteduser, 
            beforevalue, currentvalue, createddate, domainaudithistoryid,username,userfirstname,userlastname,usereducatoridentifier,
            modifiedusername,modifieduserfirstname,modifieduserlastName,modifiedUsereducatoridentifier)
    VALUES (#{id,jdbcType=BIGINT}, #{eventName,jdbcType=VARCHAR},#{modifiedUser,jdbcType=BIGINT},
    		#{affectedUser,jdbcType=BIGINT},#{beforeValue,jdbcType=VARCHAR},#{currentValue,jdbcType=VARCHAR},
     		#{createdDate,jdbcType=TIMESTAMP},#{domainAuditHistoryId,jdbcType=BIGINT},#{userName,jdbcType=VARCHAR},
     		#{userFirstName,jdbcType=VARCHAR},#{userLastName,jdbcType=VARCHAR},#{userEducatorIdentifier,jdbcType=VARCHAR},
     		#{modifiedUserName,jdbcType=VARCHAR},#{modifiedUserFirstName,jdbcType=VARCHAR},
     		#{modifiedUserLastName,jdbcType=VARCHAR},#{modifiedUserEducatorIdentifier,jdbcType=VARCHAR});
     </insert>
     
<select id="getLastJobRunDateTime" resultType="java.util.Date">
		Select lastbatchexecutiontime from useraudittrailhistory order by createddate desc limit 1;
</select>

<!--Added during US18004 - creating organization json  -->
<insert id="insertOrganizationAuditTrail" parameterType="edu.ku.cete.report.domain.OrganizationAuditTrailHistory">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 14 15:51:01 IST 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('organizationaudittrailhistory_id_seq')
    </selectKey>
    INSERT INTO organizationaudittrailhistory(
            id, eventname, modifieduser, affectedorganization, 
            beforevalue, currentvalue, createddate, domainaudithistoryid,statename,stateid,districtname,districtid,schoolname,schoolid,
            modifiedusername,modifieduserfirstname,modifieduserlastName,modifiedUsereducatoridentifier)
    VALUES (#{id,jdbcType=BIGINT}, #{eventName,jdbcType=VARCHAR},#{modifiedUser,jdbcType=BIGINT},
    		#{affectedorganization,jdbcType=BIGINT},#{beforeValue,jdbcType=VARCHAR},#{currentValue,jdbcType=VARCHAR},
     		#{createdDate,jdbcType=TIMESTAMP},#{domainAuditHistoryId,jdbcType=BIGINT},#{stateName,jdbcType=VARCHAR},#{stateId,jdbcType=BIGINT},
     		#{districtName,jdbcType=VARCHAR},#{districtId,jdbcType=BIGINT},#{schoolName,jdbcType=VARCHAR},#{schoolId,jdbcType=BIGINT},
     		#{modifiedUserName,jdbcType=VARCHAR},#{modifiedUserFirstName,jdbcType=VARCHAR},
     		#{modifiedUserLastName,jdbcType=VARCHAR},#{modifiedUserEducatorIdentifier,jdbcType=VARCHAR});
     </insert>

<insert id="insertRoleAuditTrail" parameterType="edu.ku.cete.report.domain.UserAuditTrailHistory">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 14 15:51:01 IST 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('roleaudittrailhistory_id_seq')
    </selectKey>
    INSERT INTO roleaudittrailhistory(
            id, eventname, modifieduser, affectedrole, 
            beforevalue, currentvalue, createddate, domainaudithistoryid,stateids,statenames,assessmentprogram,assessmentprogramid,
            modifiedusername,modifieduserfirstname,modifieduserlastname,modifiedusereducatoridentifier,affectedrolename)
    VALUES (#{id,jdbcType=BIGINT}, #{eventName,jdbcType=VARCHAR},#{modifiedUser,jdbcType=BIGINT},
    		#{affectedUser,jdbcType=BIGINT},#{beforeValue,jdbcType=VARCHAR},#{currentValue,jdbcType=VARCHAR},
     		#{createdDate,jdbcType=TIMESTAMP},#{domainAuditHistoryId,jdbcType=BIGINT},#{stateIds,jdbcType=BIGINT},#{stateNames,jdbcType=VARCHAR}
     		,#{assessmentProgram,jdbcType=VARCHAR},#{assessmentProgramId,jdbcType=BIGINT},#{modifiedUserName,jdbcType=VARCHAR}
     		,#{modifiedUserFirstName,jdbcType=VARCHAR},#{modifiedUserLastName,jdbcType=VARCHAR},#{modifiedUserEducatorIdentifier,jdbcType=VARCHAR}
     		,#{affectedrolename,jdbcType=VARCHAR});
     </insert>
     <insert id="insertRosterAuditTrail" parameterType="edu.ku.cete.report.domain.RosterAuditTrailHistory">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 14 15:51:01 IST 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('roleaudittrailhistory_id_seq')
    </selectKey>
    INSERT INTO rosteraudittrailhistory(
            id, eventname, modifieduser, affectedroster,beforevalue, currentvalue, createddate, domainaudithistoryid,
            modifiedusername,modifieduserfirstname,modifieduserlastName,modifiedUsereducatoridentifier,
             rostername, state, stateid, district, districtid, school, schoolid, educatorname, 
            educatorid, subject, subjectid,educatorinternalid)
    VALUES (#{id,jdbcType=BIGINT}, #{eventName,jdbcType=VARCHAR},#{modifiedUser,jdbcType=BIGINT},
    		#{affectedroster,jdbcType=BIGINT}, #{beforeValue,jdbcType=CHAR}::json,#{currentValue,jdbcType=CHAR}::json,
     		#{createdDate,jdbcType=TIMESTAMP},#{domainAuditHistoryId,jdbcType=BIGINT},
     		#{modifiedUserName,jdbcType=VARCHAR},#{modifiedUserFirstName,jdbcType=VARCHAR},
     		#{modifiedUserLastName,jdbcType=VARCHAR},#{modifiedUserEducatorIdentifier,jdbcType=VARCHAR},#{rosterName,jdbcType=VARCHAR}
     		,#{state,jdbcType=VARCHAR},#{stateId,jdbcType=BIGINT},#{district,jdbcType=VARCHAR},#{districtId,jdbcType=BIGINT}
     		,#{school,jdbcType=VARCHAR},#{schoolId,jdbcType=BIGINT},#{educatorName,jdbcType=VARCHAR},#{educatorId,jdbcType=VARCHAR}
     		,#{subject,jdbcType=VARCHAR},#{subjectId,jdbcType=BIGINT},#{educatorInternalId,jdbcType=BIGINT});
     </insert>
     
 <insert id="insertStudent" parameterType="edu.ku.cete.report.domain.StudentAuditTrailHistory">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 14 15:51:01 IST 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('studentaudittrailhistory_id_seq')
    </selectKey>
    INSERT INTO studentaudittrailhistory(
            id, eventname, modifieduser, statestudentid,studentfirstname,studentlastname, 
            beforevalue, currentvalue, createddate, domainaudithistoryid,
			modifiedusername,modifieduserfirstname,modifieduserlastName,modifiedUsereducatoridentifier,studentid)
    VALUES (#{id,jdbcType=BIGINT}, #{eventName,jdbcType=VARCHAR},#{modifiedUser,jdbcType=BIGINT},
    		#{studentStateId,jdbcType=VARCHAR},#{studentFirstName,jdbcType=VARCHAR},#{studentLastName,jdbcType=VARCHAR},#{beforeValue,jdbcType=CHAR}::json,
    		#{currentValue,jdbcType=CHAR}::json,#{createdDate,jdbcType=TIMESTAMP},#{domainAuditHistoryId,jdbcType=BIGINT},
			#{modifiedUserName,jdbcType=VARCHAR},#{modifiedUserFirstName,jdbcType=VARCHAR},
     		#{modifiedUserLastName,jdbcType=VARCHAR},#{modifiedUserEducatorIdentifier,jdbcType=VARCHAR},#{studentId,jdbcType=BIGINT});
     </insert>
     
     <insert id="insertSurvey" parameterType="edu.ku.cete.report.domain.FirstContactSurveyAuditHistory">    
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('firstcontactsurveyaudithistory_id_seq')
    </selectKey>
    INSERT INTO firstcontactsurveyaudithistory(
            id, eventname, modifieduser, statestudentidentifier,studentfirstname,studentlastname,surveyid,studentid,
            surveystatusbeforeedit,surveystatusafteredit,
            beforevalue, currentvalue, domainaudithistoryid,modifiedusername,modifieduserfirstname,modifieduserlastName,modifiedUsereducatoridentifier)
    VALUES (#{id}, #{eventName},#{modifiedUser},
    		#{stateStudentIdentifier},#{studentFirstName},#{studentLastName}, #{surveyId}, #{studentId},
    		#{surveyStatusBeforeEdit}, #{surveyStatusAfterEdit}, #{beforeValue,jdbcType=CHAR}::json,    		
    		#{currentValue,jdbcType=CHAR}::json, #{domainAuditHistoryId},#{modifiedUserName,jdbcType=VARCHAR},#{modifiedUserFirstName,jdbcType=VARCHAR},
     		#{modifiedUserLastName,jdbcType=VARCHAR},#{modifiedUserEducatorIdentifier,jdbcType=VARCHAR})
     </insert>    
      
     <insert id="insertActivationEmailAuditTrail" parameterType="edu.ku.cete.report.domain.ActivationTemplateAuditTrailHistory">
   INSERT INTO activationtemplateaudittrailhistory(
             eventname, modifieduser, affectedemailtemplateid, 
            beforevalue, currentvalue, createddate, domainaudithistoryid,assessmentprogramid,assessmentprogram,stateids,statenames,templatename,
            modifiedusername,modifieduserfirstname,modifieduserlastName,modifiedUsereducatoridentifier)
    VALUES ( #{eventName,jdbcType=VARCHAR},#{modifiedUser,jdbcType=BIGINT},
    		#{affectedemailtemplateid,jdbcType=BIGINT}, #{beforeValue,jdbcType=CHAR}::json,#{currentValue,jdbcType=CHAR}::json,
     		#{createdDate,jdbcType=TIMESTAMP},#{domainAuditHistoryId,jdbcType=BIGINT},#{assessmentProgramId,jdbcType=BIGINT},#{assessmentProgram,jdbcType=VARCHAR},#{stateIds,jdbcType=CHAR}::text,
     		#{stateNames,jdbcType=CHAR}::text,#{templateName,jdbcType=VARCHAR},#{modifiedUserName,jdbcType=VARCHAR},#{modifiedUserFirstName,jdbcType=VARCHAR},
     		#{modifiedUserLastName,jdbcType=VARCHAR},#{modifiedUserEducatorIdentifier,jdbcType=VARCHAR});
     </insert>
 
 <select id="getUserAuditTrailHistory" resultType="edu.ku.cete.report.domain.UserAuditTrailHistory" >
 	 SELECT *, to_char(createddate AT time zone 'US/Central', 'MM-DD-YYYY hh12:mi:ss AM') createddateStr
 from useraudittrailhistory uath
	where uath.createddate &gt;=#{startDateTimes,jdbcType=TIMESTAMP} 
	AND uath.createddate &lt;=#{endDateTimes,jdbcType=TIMESTAMP}
	<if test="(educatorId !=null and educatorId !='')or(emailAddress !=null and emailAddress !='')">
	and affecteduser in (
	<if test="educatorId !=null and educatorId !=''">
	select distinct affecteduser from useraudittrailhistory where usereducatoridentifier =trim(#{educatorId,jdbcType=VARCHAR})
	</if>
	<if test="educatorId !=null and educatorId !='' and emailAddress !=null and emailAddress !=''">
	union
	</if>
	<if test="emailAddress !=null and emailAddress !=''">
	select distinct affecteduser from useraudittrailhistory where username=trim(#{emailAddress,jdbcType=VARCHAR})
	</if>
	)
	</if>
	order by id
	<if test="offset !=null ">
	offset #{offset,jdbcType=INTEGER}
	</if>
	<if test="limit !=null">
	limit #{limit,jdbcType=INTEGER}
	</if>
 </select>
 <select id="getStudentAuditTrailHistory" resultType="edu.ku.cete.report.domain.StudentAuditTrailHistory" >
 	 select *,to_char(createddate AT time zone 'US/Central', 'MM-DD-YYYY hh12:mi:ss AM') createddateStr
 	 from studentaudittrailhistory studaudtrailhistory
	where studaudtrailhistory.createddate &gt;=#{startDateTimes,jdbcType=TIMESTAMP} 
	AND studaudtrailhistory.createddate &lt;=#{endDateTimes,jdbcType=TIMESTAMP}
	<if test="stateStudentId !=null and stateStudentId !=''">
	AND id in (select id   from studentaudittrailhistory studaudtrailhistory
	where studentid in (select distinct studentid from studentaudittrailhistory
	 where statestudentid=trim(#{stateStudentId,jdbcType=VARCHAR}))
	union 
	select id from   studentaudittrailhistory studaudtrailhistory	where 	statestudentid=trim(#{stateStudentId,jdbcType=VARCHAR})) 
	</if>
	order by id 
	<if test="offset !=null ">
	offset #{offset,jdbcType=INTEGER}
	</if>
	<if test="limit !=null">
	limit #{limit,jdbcType=INTEGER}
	</if>
	
 </select>
 <select id="getRosterAuditTrailHistory" resultType="edu.ku.cete.report.domain.RosterAuditTrailHistory">
 SELECT *,to_char(createddate AT time zone 'US/Central', 'MM-DD-YYYY hh12:mi:ss AM') createddateStr
  from rosteraudittrailhistory rostaudtrailhistory
	where rostaudtrailhistory.createddate &gt;=#{startDateTimes,jdbcType=TIMESTAMP} 
	AND rostaudtrailhistory.createddate &lt;=#{endDateTimes,jdbcType=TIMESTAMP}
	<if test="stateId !=null and stateId!=''">
			and stateid ::text=#{stateId}
     </if>
     <if test="schoolIds != null and schoolIds.size > 0">
			 and affectedroster in( select affectedroster from rosteraudittrailhistory where schoolid in 
			<foreach collection="schoolIds" item="schoolId" open="(" close=")" separator=",">
		 	 #{schoolId}
		 	 </foreach>)
    </if>
    <if test="contentArea !=null and contentArea!=''">
			and subjectid ::text=#{contentArea}
    </if>
    <if test="educatorId !=null and educatorId !=''">
			and affectedroster in( select affectedroster from rosteraudittrailhistory where educatorInternalId in 
			 (select distinct affecteduser from useraudittrailhistory where usereducatoridentifier =trim(#{educatorId}))
			 union 
			select affectedroster from rosteraudittrailhistory  where educatorid =trim(#{educatorId}))
    </if>
    order by id
    <if test="offset !=null ">
	offset #{offset,jdbcType=INTEGER}
	</if>
	<if test="limit !=null">
	limit #{limit,jdbcType=INTEGER}
	</if>
 </select>
 <select id="getRoleAuditTrailHistory" resultType="edu.ku.cete.report.domain.RoleAuditTrailHistory">
 SELECT *, to_char(createddate AT time zone 'US/Central', 'MM-DD-YYYY hh12:mi:ss AM') createddateStr
   from roleaudittrailhistory roleaudtrailhistory
	where roleaudtrailhistory.createddate &gt;=#{startDateTimes,jdbcType=TIMESTAMP} 
	AND roleaudtrailhistory.createddate &lt;=#{endDateTimes,jdbcType=TIMESTAMP}
	<if test="assessmentProgram != null and assessmentProgram != '' and assessmentProgram !=' '">
	
	and assessmentprogramid::text=#{assessmentProgram,jdbcType=VARCHAR}
	</if>
	<if test="stateId != null and stateId !='0' and stateId !=' ' and stateId !='' ">
	and stateids::text=#{stateId,jdbcType=VARCHAR}
	
	
	</if>
	<if test="groupId != null and groupId !='0' and groupId !=' ' and groupId !='' ">
	and affectedrole::text=#{groupId,jdbcType=VARCHAR}
	<!-- and #{stateId,jdbcType=VARCHAR}=any(stateids::text[]) -->
	<!-- and #{stateId,jdbcType=VARCHAR}=any(stateids::text) -->
	
	</if>
	order by id
	<if test="offset !=null ">
	offset #{offset,jdbcType=INTEGER}
	</if>
	<if test="limit !=null">
	limit #{limit,jdbcType=INTEGER}
	</if>
	</select>
	<select id="getOrganizationAuditTrailHistory" resultType="edu.ku.cete.report.domain.OrganizationAuditTrailHistory">
	SELECT *, to_char(createddate AT time zone 'US/Central', 'MM-DD-YYYY hh12:mi:ss AM') createddateStr 
	from organizationaudittrailhistory orgaudittrailhistory
	where orgaudittrailhistory.createddate &gt;=#{startDateTimes,jdbcType=TIMESTAMP} 
	AND orgaudittrailhistory.createddate &lt;=#{endDateTimes,jdbcType=TIMESTAMP}
	 	<if test="filterValues.organizationId!=null">
			and affectedorganization ::text =#{filterValues.organizationId}
         </if>        
          <if test="filterValues.stateId!=null">
			and stateid ::text=#{filterValues.stateId}
         </if>
          <if test="filterValues.districtId!=null">
			and districtid ::text=#{filterValues.districtId}
         </if>
          <if test="filterValues.schoolId!=null">
			and schoolid ::text=#{filterValues.schoolId}
         </if>
         
         order by id
         <if test="offset !=null ">
	offset #{offset,jdbcType=INTEGER}
	</if>
	<if test="limit !=null">
	limit #{limit,jdbcType=INTEGER}
	</if>
	</select>
	<select id="getFirstContactSurveyAuditHistory" resultType="edu.ku.cete.report.domain.FirstContactSurveyAuditHistory">
	SELECT *, currentvalue,to_char(createddate AT time zone 'US/Central', 'MM-DD-YYYY hh12:mi:ss AM') createddateStr 
       from firstcontactsurveyaudithistory fcsaudithistory
	where fcsaudithistory.createddate &gt;=#{startDateTimes,jdbcType=TIMESTAMP} 	
	AND fcsaudithistory.createddate &lt;=#{endDateTimes,jdbcType=TIMESTAMP}
	 <if test="stateStudentId !=null and stateStudentId !=''">
	AND id in (select id   from studentaudittrailhistory studaudtrailhistory
	where studentid in (select distinct studentid from studentaudittrailhistory
	 where statestudentid=trim(#{stateStudentId,jdbcType=VARCHAR}))
	union 
	select id from   firstcontactsurveyaudithistory 	where 	stateStudentIdentifier=trim(#{stateStudentId,jdbcType=VARCHAR})) 
	</if> 
	order by id
	<if test="offset !=null ">
	offset #{offset,jdbcType=INTEGER}
	</if>
	<if test="limit !=null">
	limit #{limit,jdbcType=INTEGER}
	</if>
	</select>
	<select id="getActivationTemplateAuditTrailHistory" resultType="edu.ku.cete.report.domain.ActivationTemplateAuditTrailHistory" >
	SELECT *, to_char(createddate AT time zone 'US/Central', 'MM-DD-YYYY hh12:mi:ss AM') createddateStr     
       from activationtemplateaudittrailhistory acttempaudhistory
	where acttempaudhistory.createddate &gt;=#{startDateTimes,jdbcType=TIMESTAMP} 
	AND acttempaudhistory.createddate &lt;=#{endDateTimes,jdbcType=TIMESTAMP}
	<if test="assessmentProgram != null and assessmentProgram != '' and assessmentProgram !=' '">
	and assessmentprogramid::text=#{assessmentProgram,jdbcType=VARCHAR}
	</if>
	<if test="stateId != null and stateId !='0' and stateId !=' ' and stateId !='' ">
	and #{stateId,jdbcType=VARCHAR}=any(stateids::text[])
	</if>
	order by id
	<if test="offset !=null ">
	offset #{offset,jdbcType=INTEGER}
	</if>
	<if test="limit !=null">
	limit #{limit,jdbcType=INTEGER}
	</if>
	</select>
	
	 <insert id="insertComplexityBandHistory" parameterType="edu.ku.cete.report.domain.FCSComplexityBandHistory">    
	    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
	      SELECT nextval('fcscompbandhistory_id_seq')
	    </selectKey>
	    INSERT INTO fcscompbandhistory(id, studentid, studentname, compbandsubject, previouscompband,updatedcompband, 
	    schoolyear,modifieddate, modifiedby,createddate)
		VALUES (#{id}, #{studentId}, #{studentName}, #{compBandSubject},#{previousCompBand}, #{updatedCompBand}, #{schoolYear},
		#{surveyModifiedDate},#{surveyModifiedUserId},now());
    </insert>  
</mapper>

