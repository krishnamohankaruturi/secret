<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.ku.cete.model.ReportAssessmentProgramMapper" >
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.report.ReportAssessmentProgram" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 06 12:07:19 CDT 2015.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="reporttypeid" property="reportTypeId" jdbcType="BIGINT" />
    <result column="assessmentprogramid" property="assessmentProgramId" jdbcType="BIGINT" />
    <result column="createdate" property="createDate" jdbcType="TIMESTAMP" />
    <result column="modifieddate" property="modifiedDate" jdbcType="TIMESTAMP" />
    <result column="readytoview" property="readyToView" jdbcType="BIT" />
    <result column="activeflag" property="activeFlag" jdbcType="BIT" />
  </resultMap>
    <resultMap id="ReportDetailsMap" extends="BaseResultMap" type="edu.ku.cete.domain.report.ReportAssessmentProgramDetails">
    <result column="programname" property="programName" jdbcType="VARCHAR"/>
    <result column="abbreviatedname" property="abbreviatedName" jdbcType="VARCHAR"/>
    <result column="categorycode" property="reportCode" jdbcType="VARCHAR"/>
    <result column="categoryname" property="categoryName" jdbcType="VARCHAR"/>
    <result column="assessmentprogramid" property="assessmentProgramId" jdbcType="VARCHAR"/>
    <result column="readytoview" property="readyToView" jdbcType="VARCHAR"/>
    <result column="access" property="access" jdbcType="VARCHAR"/>
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 06 12:07:19 CDT 2015.
    -->
    id, reporttypeid, assessmentprogramid, createdate, modifieddate, readytoview, activeflag
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 06 12:07:19 CDT 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from reportassessmentprogram
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.report.ReportAssessmentProgram" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 06 12:07:19 CDT 2015.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('reportassessmentprogram_id_seq')
    </selectKey>
    insert into reportassessmentprogram (id, reporttypeid, assessmentprogramid, 
      createdate, modifieddate, readytoview, 
      activeflag)
    values (#{id,jdbcType=BIGINT}, #{reportTypeId,jdbcType=BIGINT}, #{assessmentProgramId,jdbcType=BIGINT}, 
      #{createDate,jdbcType=TIMESTAMP}, #{modifiedDate,jdbcType=TIMESTAMP}, #{readyToView,jdbcType=BIT}, 
      #{activeFlag,jdbcType=BIT})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.report.ReportAssessmentProgram" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 06 12:07:19 CDT 2015.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('reportassessmentprogram_id_seq')
    </selectKey>
    insert into reportassessmentprogram
    <trim prefix="(" suffix=")" suffixOverrides="," >
      id,
      <if test="reportTypeId != null" >
        reporttypeid,
      </if>
      <if test="assessmentProgramId != null" >
        assessmentprogramid,
      </if>
      <if test="createDate != null" >
        createdate,
      </if>
      <if test="modifiedDate != null" >
        modifieddate,
      </if>
      <if test="readyToView != null" >
        readytoview,
      </if>
      <if test="activeFlag != null" >
        activeflag,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      #{id,jdbcType=BIGINT},
      <if test="reportTypeId != null" >
        #{reportTypeId,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null" >
        #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="createDate != null" >
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null" >
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="readyToView != null" >
        #{readyToView,jdbcType=BIT},
      </if>
      <if test="activeFlag != null" >
        #{activeFlag,jdbcType=BIT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.report.ReportAssessmentProgram" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 06 12:07:19 CDT 2015.
    -->
    update reportassessmentprogram
    <set >
      <if test="reportTypeId != null" >
        reporttypeid = #{reportTypeId,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null" >
        assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="createDate != null" >
        createdate = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null" >
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="readyToView != null" >
        readytoview = #{readyToView,jdbcType=BIT},
      </if>
      <if test="activeFlag != null" >
        activeflag = #{activeFlag,jdbcType=BIT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.report.ReportAssessmentProgram" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 06 12:07:19 CDT 2015.
    -->
    update reportassessmentprogram
    set reporttypeid = #{reportTypeId,jdbcType=BIGINT},
      assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      createdate = #{createDate,jdbcType=TIMESTAMP},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      readytoview = #{readyToView,jdbcType=BIT},
      activeflag = #{activeFlag,jdbcType=BIT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="getReadyToViewFlagsForReports" resultMap="ReportDetailsMap">
  <!-- 	SELECT DISTINCT ap.programname, ap.abbreviatedname, rt.categorycode, rap.*
    FROM reportassessmentprogram rap
	JOIN assessmentprogram ap ON rap.assessmentprogramid = ap.id
  	JOIN category rt ON rt.id = rap.reporttypeid
  	inner join reportassessmentprogramgroup rag on rap.id =  rag.reportassessmentprogramid 
  	inner join groups gr on gr.id = rag.groupid 
  	inner join groupauthorities gau on gau.authorityid = rap.authorityid and gau.groupid = rag.groupid
    WHERE rt.categorytypeid = (select id from categorytype where typecode = 'REPORT_TYPES_UI')
	and gr.id in (${userCurrentRoleId}) 
	<if test="orgType != 'ST'" >
	  and rap.stateid in (select id from  organization_parent(${orgId}) where organizationtypeid = (select id from organizationtype where typecode = 'ST'))	
	</if>
	<if test="orgType == 'ST'" >
	and rap.stateid=${orgId}
	</if>	
	and rap.activeflag is true and rt.activeflag is true and rap.readytoview is true and rag.activeflag is true
	and gr.activeflag is true
	and gau.activeflag is true -->
	SELECT DISTINCT ap.programname, ap.abbreviatedname, rt.categorycode,rt.categoryname as categoryName,rap.assessmentprogramid as assessmentProgramId,
	 rap.readytoview, (case when rag.id is not null then true else false end) as access
	FROM reportassessmentprogram rap 
	JOIN assessmentprogram ap ON rap.assessmentprogramid = ap.id 
	JOIN category rt ON rt.id = rap.reporttypeid and rt.activeflag is true 
	JOIN groupauthorities gau on rap.authorityid = gau.authorityid and gau.groupid = #{userCurrentRoleId} 
	and gau.organizationid = #{orgId} and gau.activeflag is true
	left join reportassessmentprogramgroup rag on rap.id = rag.reportassessmentprogramid and rag.groupid = #{userCurrentRoleId} and rag.activeflag is true
	WHERE rt.categorytypeid = (select id from categorytype where typecode = 'REPORT_TYPES_UI') and rap.stateid =#{orgId} and rap.activeflag is true order by access
	
  </select>
</mapper>