<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.professionaldevelopment.UserTestMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.professionaldevelopment.UserTest">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 09 17:07:04 CDT 2014.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="usermoduleid" jdbcType="BIGINT" property="userModuleId" />
    <result column="testid" jdbcType="BIGINT" property="testId" />
    <result column="status" jdbcType="BIGINT" property="statusId" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="startdatetime" jdbcType="TIMESTAMP" property="startDateTime" />
    <result column="enddatetime" jdbcType="TIMESTAMP" property="endDateTime" />
    <result column="scores" jdbcType="VARCHAR" property="scores" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 09 17:07:04 CDT 2014.
    -->
    id, usermoduleid, testid, status, createddate, activeflag, 
    modifieddate, startdatetime, enddatetime, scores
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 09 17:07:04 CDT 2014.
    -->
    select 
    <include refid="Base_Column_List" />
    from usertest
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.professionaldevelopment.UserTest">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 09 17:07:04 CDT 2014.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('usertest_id_seq')
    </selectKey>
    insert into usertest (id, usermoduleid, testid, 
      status, createddate,  
      activeflag, modifieddate, 
      startdatetime, enddatetime, scores
      )
    values (#{id,jdbcType=BIGINT}, #{userModuleId,jdbcType=BIGINT}, #{testId,jdbcType=BIGINT}, 
      #{statusId,jdbcType=BIGINT}, #{createdDate,jdbcType=TIMESTAMP},  
      #{activeFlag,jdbcType=BIT}, #{modifiedDate,jdbcType=TIMESTAMP}, 
      #{startDateTime,jdbcType=TIMESTAMP}, #{endDateTime,jdbcType=TIMESTAMP}, #{scores,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.professionaldevelopment.UserTest">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 09 17:07:04 CDT 2014.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('usertest_id_seq')
    </selectKey>
    insert into usertest
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="userModuleId != null">
        usermoduleid,
      </if>
      <if test="testId != null">
        testid,
      </if>
      <if test="statusId != null">
        status,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="activeFlag != null">
        activeflag,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
      <if test="startDateTime != null">
        startdatetime,
      </if>
      <if test="endDateTime != null">
        enddatetime,
      </if>
      <if test="scores != null">
        scores,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="userModuleId != null">
        #{userModuleId,jdbcType=BIGINT},
      </if>
      <if test="testId != null">
        #{testId,jdbcType=BIGINT},
      </if>
      <if test="statusId != null">
        #{statusId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="activeFlag != null">
        #{activeFlag,jdbcType=BIT},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="startDateTime != null">
        #{startDateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endDateTime != null">
        #{endDateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="scores != null">
        #{scores,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.professionaldevelopment.UserTest">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 09 17:07:04 CDT 2014.
    -->
    update usertest
    <set>
      <if test="userModuleId != null">
        usermoduleid = #{userModuleId,jdbcType=BIGINT},
      </if>
      <if test="testId != null">
        testid = #{testId,jdbcType=BIGINT},
      </if>
      <if test="statusId != null">
        status = #{statusId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="activeFlag != null">
        activeflag = #{activeFlag,jdbcType=BIT},
      </if>
      <if test="modifiedDate != null">
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="startDateTime != null">
        startdatetime = #{startDateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endDateTime != null">
        enddatetime = #{endDateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="scores != null">
        scores = #{scores,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.professionaldevelopment.UserTest">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 09 17:07:04 CDT 2014.
    -->
    update usertest
    set usermoduleid = #{userModuleId,jdbcType=BIGINT},
      testid = #{testId,jdbcType=BIGINT},
      status = #{statusId,jdbcType=BIGINT},
      createddate = #{createdDate,jdbcType=TIMESTAMP},
      activeflag = #{activeFlag,jdbcType=BIT},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      startdatetime = #{startDateTime,jdbcType=TIMESTAMP},
      enddatetime = #{endDateTime,jdbcType=TIMESTAMP},
      scores = #{scores,jdbcType=VARCHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>

  <resultMap extends="BaseResultMap" id="DetailedResultMap" type="edu.ku.cete.domain.professionaldevelopment.UserTest">
    <result column="testtypeid" jdbcType="BIGINT" property="testTypeId" />
    <result column="testcollectionid" jdbcType="BIGINT" property="testCollectionId" />
    <result column="testname" jdbcType="VARCHAR" property="testName" />
    <result column="studentid" jdbcType="BIGINT" property="studentId" />
  </resultMap>
  
  <select id="getUserTestById" parameterType="java.lang.Long" resultMap="DetailedResultMap">
	select tp.id as testtypeid, st.id, 
		um.userid as studentid, 
		st.testid, st.status, 
		tct.testcollectionid,  
		t.testname,st.modifieddate,
		st.scores 
	from usertest st
		inner join usermodule um on um.id=st.usermoduleid
	 	inner join test t on st.testid = t.id 
		inner join testcollectionstests tct on t.id = tct.testid
	 	inner join assessmentstestcollections atc on tct.testcollectionid = atc.testcollectionid 
	 	inner join assessment a on atc.assessmentid = a.id 
	 	inner join testingprogram tp on a.testingprogramid=tp.id 
	 	inner join assessmentprogram ap on tp.assessmentprogramid=ap.id 
	 where st.id = #{userTestId,jdbcType=BIGINT} LIMIT 1
  </select>
  <select id="updateSectionStatusAndGetTestStatus" resultType="java.lang.Boolean">
  		/*NO LOAD BALANCE*/ select pdupdatesectionstatusandgetstatus(#{userTestId,jdbcType=BIGINT}, #{testSectionId,jdbcType=BIGINT}, #{sectionScore,jdbcType=VARCHAR}, #{testScore,jdbcType=VARCHAR}, #{categoryCode,jdbcType=VARCHAR});
  </select>
  <select id="getTotalTestScore" parameterType="java.lang.Long" resultType="BigDecimal">
		select sum(score) as totaltestscore from usertestresponse 
		where usertestsectionid in(select id from usertestsection where usertestid = #{userTestId,jdbcType=BIGINT});
  </select> 
  <select id="getUserTestByModuleTestUserIds" parameterType="map" resultMap="BaseResultMap">
  		select ut.*
		from usertest ut
		join usermodule um on ut.usermoduleid=um.id
		where um.moduleid=#{moduleId,jdbcType=BIGINT} and um.userid=#{userId,jdbcType=BIGINT} 
		and ut.testid=#{testId,jdbcType=BIGINT} and um.activeflag=true and ut.activeflag=true;
  </select>
  
  <select id="isUserTestATutorial" parameterType="java.lang.Long" resultType="java.lang.Boolean">
  	select CASE WHEN (count(*) > 0) THEN TRUE ELSE FALSE END from usertest ut
	inner join usermodule um on ut.usermoduleid=um.id
	inner join module m on um.moduleid=m.id
	where ut.testid=m.tutorialid and ut.id=#{userTestId,jdbcType=BIGINT};
  </select>
  
  <update id="deactivateByModuleId" parameterType="java.lang.Long">

    update usertestresponse set activeflag=false
    	where activeflag=true and usertestsectionid in (
    		select id from usertestsection where activeflag=true 
				and usertestid in (select id from usertest where usermoduleid=#{userModuleId, jdbcType=BIGINT} and activeflag=true));
	
	update usertestsection set activeflag=false
    	where activeflag=true and usertestid in (select id from usertest where usermoduleid= #{userModuleId, jdbcType=BIGINT} and activeflag=true);
    
    update usertest set activeflag = false
    	where usermoduleid = #{userModuleId,jdbcType=BIGINT} and activeflag=true;
  </update>  
</mapper>