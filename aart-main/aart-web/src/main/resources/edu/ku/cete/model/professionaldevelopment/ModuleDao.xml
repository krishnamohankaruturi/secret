<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.ku.cete.model.professionaldevelopment.ModuleDao" >
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.professionaldevelopment.Module" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    <id column="m.id" property="id" jdbcType="BIGINT" />
    <result column="m.name" property="name" jdbcType="VARCHAR" />
    <result column="m.description" property="description" jdbcType="VARCHAR" />
    <result column="m.assessmentprogramid" property="assessmentprogramid" jdbcType="BIGINT" />
    <result column="m.testid" property="testid" jdbcType="BIGINT" />
    <result column="m.tutorialid" property="tutorialid" jdbcType="BIGINT" />
    <result column="m.suggestedaudience" property="suggestedaudience" jdbcType="VARCHAR" />
    <result column="m.passingscore" property="passingScore" jdbcType="INTEGER" />
    <result column="m.statusid" property="statusid" jdbcType="BIGINT" />
    <result column="m.createddate" property="createddate" jdbcType="TIMESTAMP" />
    <result column="m.modifieddate" property="modifieddate" jdbcType="TIMESTAMP" />
    <result column="m.createduser" property="createduser" jdbcType="BIGINT" />
    <result column="m.modifieduser" property="modifieduser" jdbcType="BIGINT" />
    <result column="m.activeflag" property="activeflag" jdbcType="BIT" />
    <result column="m.requiredflag" property="requiredflag" jdbcType="BIT" />    
    <result column="status" property="status" jdbcType="VARCHAR" />
    <result column="stateCEU" property="stateCEU" jdbcType="INTEGER" />
    <result column="testcompletiondate" property="testCompletionDate" jdbcType="TIMESTAMP"/>
  </resultMap>
  
    <select id="findModuleDetailsById" resultMap="ModuleDetailResultMap">
  	SELECT 
    	<include refid="Base_Column_List" />, mg.groupid, mt.moduleid, mt.tagid, t.id, t.tagname
    FROM public.module m
    	JOIN public.category c ON c.id = m.statusid
		LEFT JOIN modulegroup mg ON m.id = mg.moduleid
    	LEFT JOIN moduletag mt ON m.id = mt.moduleid
    	LEFT JOIN tag t ON t.id = mt.tagid
    WHERE m.id = #{moduleId} and m.activeflag is true;
  </select>  
 
	  <resultMap id="ModuleDetailResultMap" type="edu.ku.cete.domain.professionaldevelopment.Module">
	  
	    <id column="id" property="id" jdbcType="BIGINT" />
	    <result column="name" property="name" jdbcType="VARCHAR" />
	    <result column="description" property="description" jdbcType="VARCHAR" />
	    <result column="assessmentprogramid" property="assessmentprogramid" jdbcType="BIGINT" />
	    <result column="testid" property="testid" jdbcType="BIGINT" />
	    <result column="tutorialid" property="tutorialid" jdbcType="BIGINT" />
	    <result column="suggestedaudience" property="suggestedaudience" jdbcType="VARCHAR" />
	    <result column="passingscore" property="passingScore" jdbcType="INTEGER" />
	    <result column="statusid" property="statusid" jdbcType="BIGINT" />
	    <result column="createddate" property="createddate" jdbcType="TIMESTAMP" />
	    <result column="modifieddate" property="modifieddate" jdbcType="TIMESTAMP" />
	    <result column="createduser" property="createduser" jdbcType="BIGINT" />
	    <result column="modifieduser" property="modifieduser" jdbcType="BIGINT" />
	    <result column="activeflag" property="activeflag" jdbcType="BIT" />
	    <result column="requiredflag" property="requiredflag" jdbcType="BIT" />
				
	    <collection column="mt.moduleid" javaType="ArrayList" ofType="edu.ku.cete.domain.Tag" property="tags">
			<result property="id" column="tagid"/>
			<result property="tagName" column="tagname"/>
	    </collection>		
	
	    <collection column="mg.moduleid" javaType="ArrayList" ofType="Long" property="groupIds">
	    	<result column="groupid" />
	    </collection>
	    
	    <collection column="mt.moduleid" javaType="ArrayList" ofType="Long" property="tagIds">
	    	<result column="tagid" />
	    </collection>    
	  </resultMap> 

  <sql id="Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    m.id, m.name, m.description, m.assessmentprogramid, m.suggestedaudience, m.passingscore, 
    m.statusid, m.createddate, m.modifieddate, m.createduser, m.modifieduser, m.activeflag, 
    m.requiredflag, c.categoryname as status, m.testid, m.tutorialid
  </sql>
  
  <sql id="State_Admin_Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    m.id, m.name, m.description, m.assessmentprogramid, m.suggestedaudience, m.passingscore, 
    m.statusid, m.createddate, m.modifieddate, m.createduser, m.modifieduser, m.activeflag, 
    m.requiredflag, m.testid, m.tutorialid, case when cms.categorycode is not null then cms.categorycode 
		    	when cms.categorycode is null then 'UNRELEASED' end as status, ms.ceu as stateCEU
  </sql>  
  
  <sql id="Extended_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    m.id, m.name, m.description, m.assessmentprogramid, m.suggestedaudience, m.passingscore, m.testid,
    m.tutorialid, m.statusid, m.createddate, m.modifieddate, m.createduser, m.modifieduser, m.activeflag, 
    m.requiredflag, ap.programname as assessmentProgramName, o.displayidentifier as OrgDisplayIdentifier,
    enrlstatus.id as enrollmentStatusId, enrlstatus.categoryname as enrollmentStatusName, um.testcompletiondate, um.testresult
    
  </sql>
  
  <select id="selectByExample" resultMap="BaseResultMap" parameterType="edu.ku.cete.domain.professionaldevelopment.ModuleExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from public.module m
    	inner join public.category c on c.id = m.statusid
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    select 
    <include refid="Base_Column_List" />
    from public.module m
    	inner join public.category c on c.id = m.statusid
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    delete from public.module
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <delete id="deleteByExample" parameterType="edu.ku.cete.domain.professionaldevelopment.ModuleExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    delete from public.module
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insertUserModule" parameterType="edu.ku.cete.domain.professionaldevelopment.Module" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->     
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('usermodule_id_seq')
    </selectKey>     
    insert into public.usermodule (id, userid, moduleId, enrollmentstatusid, 
      createddate, modifieddate, createduser, 
      modifieduser, activeflag)
    values (#{id,jdbcType=BIGINT}, #{userId,jdbcType=BIGINT}, #{moduleId,jdbcType=BIGINT}, 
      #{enrollmentstatusid,jdbcType=BIGINT}, #{createddate,jdbcType=TIMESTAMP}, 
      #{modifieddate,jdbcType=TIMESTAMP}, #{createduser,jdbcType=BIGINT}, 
      #{modifieduser,jdbcType=BIGINT}, #{activeflag,jdbcType=BIT})
  </insert>
  <insert id="insert" parameterType="edu.ku.cete.domain.professionaldevelopment.Module">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('module_id_seq')
    </selectKey>    
    insert into public.module (id, name, description, 
      assessmentprogramid, suggestedaudience, statusid, 
      createddate, modifieddate, createduser, 
      modifieduser, activeflag, requiredflag, testid, tutorialid, passingscore)
    values (#{id,jdbcType=BIGINT}, #{name,jdbcType=VARCHAR}, #{description,jdbcType=VARCHAR}, 
      #{assessmentprogramid,jdbcType=BIGINT}, #{suggestedaudience,jdbcType=VARCHAR}, #{statusid,jdbcType=BIGINT}, 
      #{createddate,jdbcType=TIMESTAMP}, #{modifieddate,jdbcType=TIMESTAMP}, #{createduser,jdbcType=BIGINT}, 
      #{modifieduser,jdbcType=BIGINT}, #{activeflag,jdbcType=BIT}, 
      #{requiredflag,jdbcType=BIT}, #{testid,jdbcType=BIGINT},  #{tutorialid,jdbcType=BIGINT}, #{passingScore,jdbcType=BIGINT})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.professionaldevelopment.Module" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    insert into public.module
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="name != null" >
        name,
      </if>
      <if test="description != null" >
        description,
      </if>
      <if test="assessmentprogramid != null" >
        assessmentprogramid,
      </if>
      <if test="suggestedaudience != null" >
        suggestedaudience,
      </if>
      <if test="passingScore != null" >
        passingscore,
      </if>
      <if test="statusid != null" >
        statusid,
      </if>
      <if test="createddate != null" >
        createddate,
      </if>
      <if test="modifieddate != null" >
        modifieddate,
      </if>
      <if test="createduser != null" >
        createduser,
      </if>
      <if test="modifieduser != null" >
        modifieduser,
      </if>
      <if test="activeflag != null" >
        activeflag,
      </if>
      <if test="requiredflag != null" >
        requiredflag,
      </if>      
       <if test="testid != null" >
        testid,
      </if>
       <if test="tutorialid != null" >
        tutorialid,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="name != null" >
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="description != null" >
        #{description,jdbcType=VARCHAR},
      </if>
      <if test="assessmentprogramid != null" >
        #{assessmentprogramid,jdbcType=BIGINT},
      </if>
      <if test="suggestedaudience != null" >
        #{suggestedaudience,jdbcType=VARCHAR},
      </if>
      <if test="passingScore != null" >
        #{passingScore,jdbcType=INTEGER},
      </if>
      <if test="statusid != null" >
        #{statusid,jdbcType=BIGINT},
      </if>
      <if test="createddate != null" >
        #{createddate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifieddate != null" >
        #{modifieddate,jdbcType=TIMESTAMP},
      </if>
      <if test="createduser != null" >
        #{createduser,jdbcType=BIGINT},
      </if>
      <if test="modifieduser != null" >
        #{modifieduser,jdbcType=BIGINT},
      </if>
      <if test="activeflag != null" >
        #{activeflag,jdbcType=BIT},
      </if>
      <if test="requiredflag != null" >
        #{requiredflag,jdbcType=BIT},
      </if>      
       <if test="testid != null" >
         #{testid,jdbcType=BIGINT},
      </if>
       <if test="tutorialid != null" >
         #{tutorialid,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="edu.ku.cete.domain.professionaldevelopment.ModuleExample" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    select count(*) from public.module
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    update public.module
    <set >
      <if test="record.id != null" >
        id = #{record.id,jdbcType=BIGINT},
      </if>
      <if test="record.name != null" >
        name = #{record.name,jdbcType=VARCHAR},
      </if>
      <if test="record.description != null" >
        description = #{record.description,jdbcType=VARCHAR},
      </if>
      <if test="record.assessmentprogramid != null" >
        assessmentprogramid = #{record.assessmentprogramid,jdbcType=BIGINT},
      </if>
      <if test="record.suggestedaudience != null" >
        suggestedaudience = #{record.suggestedaudience,jdbcType=VARCHAR},
      </if>
      <if test="record.passingScore != null" >
        passingscore = #{record.passingScore,jdbcType=INTEGER},
      </if>
      <if test="record.statusid != null" >
        statusid = #{record.statusid,jdbcType=BIGINT},
      </if>
      <if test="record.createddate != null" >
        createddate = #{record.createddate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.modifieddate != null" >
        modifieddate = #{record.modifieddate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.createduser != null" >
        createduser = #{record.createduser,jdbcType=BIGINT},
      </if>
      <if test="record.modifieduser != null" >
        modifieduser = #{record.modifieduser,jdbcType=BIGINT},
      </if>
      <if test="record.activeflag != null" >
        activeflag = #{record.activeflag,jdbcType=BIT},
      </if>
      <if test="record.requiredflag != null" >
        requiredflag = #{record.requiredflag,jdbcType=BIT},
      </if>      
       <if test="testid != null" >
        testid = #{record.testid,jdbcType=BIGINT},
      </if>
      <if test="tutorialid != null" >
        tutorialid = #{record.tutorialid,jdbcType=BIGINT},
      </if>
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    update public.module
    set id = #{record.id,jdbcType=BIGINT},
      name = #{record.name,jdbcType=VARCHAR},
      description = #{record.description,jdbcType=VARCHAR},
      assessmentprogramid = #{record.assessmentprogramid,jdbcType=BIGINT},
      suggestedaudience = #{record.suggestedaudience,jdbcType=VARCHAR},
      passingscore = #{record.passingScore,jdbcType=INTEGER},
      statusid = #{record.statusid,jdbcType=BIGINT},
      createddate = #{record.createddate,jdbcType=TIMESTAMP},
      modifieddate = #{record.modifieddate,jdbcType=TIMESTAMP},
      createduser = #{record.createduser,jdbcType=BIGINT},
      modifieduser = #{record.modifieduser,jdbcType=BIGINT},
      activeflag = #{record.activeflag,jdbcType=BIT},
      requiredflag = #{record.requiredflag,jdbcType=BIT},
      testid = #{record.testid,jdbcType=BIGINT},
      tutorialid = #{record.tutorialid,jdbcType=BIGINT}
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.professionaldevelopment.Module" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    update public.module
    <set >
      <if test="name != null" >
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="description != null" >
        description = #{description,jdbcType=VARCHAR},
      </if>
      <if test="assessmentprogramid != null" >
        assessmentprogramid = #{assessmentprogramid,jdbcType=BIGINT},
      </if>
      <if test="suggestedaudience != null" >
        suggestedaudience = #{suggestedaudience,jdbcType=VARCHAR},
      </if>
      <if test="passingScore != null" >
        passingscore = #{passingScore,jdbcType=INTEGER},
      </if>
      <if test="statusid != null" >
        statusid = #{statusid,jdbcType=BIGINT},
      </if>
      <if test="createddate != null" >
        createddate = #{createddate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifieddate != null" >
        modifieddate = #{modifieddate,jdbcType=TIMESTAMP},
      </if>
      <if test="createduser != null" >
        createduser = #{createduser,jdbcType=BIGINT},
      </if>
      <if test="modifieduser != null" >
        modifieduser = #{modifieduser,jdbcType=BIGINT},
      </if>
      <if test="activeflag != null" >
        activeflag = #{activeflag,jdbcType=BIT},
      </if>
      <if test="requiredflag != null" >
        requiredflag = #{requiredflag,jdbcType=BIT},
      </if>      
       <if test="testid != null" >
        testid = #{testid,jdbcType=BIGINT},
      </if>
      <if test="tutorialid != null" >
        tutorialid = #{tutorialid,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.professionaldevelopment.Module" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Aug 29 16:10:44 CDT 2013.
    -->
    update public.module
    set name = #{name,jdbcType=VARCHAR},
      description = #{description,jdbcType=VARCHAR},
      assessmentprogramid = #{assessmentprogramid,jdbcType=BIGINT},
      suggestedaudience = #{suggestedaudience,jdbcType=VARCHAR},
      passingscore = #{passingScore,jdbcType=INTEGER},
      statusid = #{statusid,jdbcType=BIGINT},
      createddate = #{createddate,jdbcType=TIMESTAMP},
      modifieddate = #{modifieddate,jdbcType=TIMESTAMP},
      createduser = #{createduser,jdbcType=BIGINT},
      modifieduser = #{modifieduser,jdbcType=BIGINT},
      activeflag = #{activeflag,jdbcType=BIT},
      requiredflag = #{requiredflag,jdbcType=BIT},
      testid = #{testid,jdbcType=BIGINT}
      tutorialid = #{tutorialid,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <sql id="Extended_Modules_Where_Clause">
 	<if test="modulesCollectionsCriteriaMap.id != null">
  		AND (m.id || '') ilike #{modulesCollectionsCriteriaMap.id}
  	</if>
 	<if test="modulesCollectionsCriteriaMap.name != null">
  		AND (m.name || '') ilike #{modulesCollectionsCriteriaMap.name}
  	</if>
  	<if test="modulesCollectionsCriteriaMap.passingScore != null">
  		AND (m.passingscore || '') ilike #{modulesCollectionsCriteriaMap.passingScore}
  	</if>	    	
 	<if test="modulesCollectionsCriteriaMap.assessmentProgramName != null">
  		AND (ap.programname || '') ilike #{modulesCollectionsCriteriaMap.assessmentProgramName}
  	</if>
  	<if test="modulesCollectionsCriteriaMap.orgDisplayIdentifier != null">
  		AND (o.displayidentifier || '') ilike #{modulesCollectionsCriteriaMap.orgDisplayIdentifier}
  	</if>
  	<if test="modulesCollectionsCriteriaMap.unenrolledStatus == null and modulesCollectionsCriteriaMap.enrollmentStatusName != null">  		
  		AND (um.enrollmentstatusid || '')= TRIM(#{modulesCollectionsCriteriaMap.enrollmentStatusName} , '%')
  	</if>
  	<if test="modulesCollectionsCriteriaMap.unenrolledStatus != null and modulesCollectionsCriteriaMap.enrollmentStatusName != null">  		
  		AND ((um.enrollmentstatusid || '')= TRIM(#{modulesCollectionsCriteriaMap.enrollmentStatusName} , '%') OR um.enrollmentstatusid is null)
  	</if>
 </sql>
		  
    <select id="getModulesForAdmin" resultType="Module">
  	SELECT 
    <include refid="Base_Column_List" />
    FROM public.module m
    	inner join public.category c on c.id = m.statusid 
    <if test="sortByColumn != null">
    	ORDER BY 
    		<choose>
	      		<when test="sortByColumn == 'id'">m.id</when>
	      		<when test="sortByColumn == 'name'">m.name</when>
	      		<when test="sortByColumn == 'status'">status</when>
	      		<when test="sortByColumn == 'ceu'">stateCEU</when>
	      	</choose>
    		<if test="sortType=='desc'">
	    		desc
    	 	</if>
    	 	<if test="sortType=='asc' or sortType==null">
    	 		asc
    	 	</if>
	</if>
    	limit #{limit}
		offset #{offset}
  </select>
  
  <select id="countModulesForAdmin" resultType="int">
   SELECT count(1)
   FROM public.module m
    	inner join public.category c on c.id = m.statusid 
  </select>
  
  <select id="getModulesForStateAdmin" resultType="Module">
  	SELECT 
  <include refid="State_Admin_Base_Column_List" />
    FROM public.module m
    	inner join public.category c on c.id = m.statusid
    	left join public.modulestate ms 
    		on (m.id = ms.moduleid 
    				AND ms.stateid = (select id from organization_parent(#{organizationId}) where contractingorganization is true union 
									select id from organization where id=#{organizationId} and contractingorganization is true) 
    			) 
    	left join public.category cms on ms.statusid = cms.id
    WHERE c.categorycode = 'PUBLISHED' 
    <if test="sortByColumn != null">
    	ORDER BY 
    		<choose>
	      		<when test="sortByColumn == 'id'">m.id</when>
	      		<when test="sortByColumn == 'name'">m.name</when>
	      		<when test="sortByColumn == 'status'">status</when>
	      		<when test="sortByColumn == 'ceu'">stateCEU</when>
	      	</choose>
    		<if test="sortType=='desc'">
	    		desc
    	 	</if>
    	 	<if test="sortType=='asc' or sortType==null">
    	 		asc
    	 	</if>
	</if>
    	limit #{limit}
		offset #{offset}
   </select>
  
   <select id="countModulesForStateAdmin" resultType="int">
  	SELECT count(1)
    FROM public.module m
	    inner join public.category c on c.id = m.statusid
    	left join public.modulestate ms 
    		on (m.id = ms.moduleid 
    				AND ms.stateid = (select id from organization_parent(#{organizationId}) where contractingorganization is true union 
									select id from organization where id=#{organizationId} and contractingorganization is true) 
    			)
    	left join public.category cms on ms.statusid = cms.id
    WHERE c.categorycode = 'PUBLISHED'
  </select>
  
  
  <select id="getModules" resultType="Module">
  	SELECT distinct <include refid="Extended_Column_List" />
    FROM module m
    	JOIN modulestate ms ON m.id = ms.moduleid
    	JOIN category c ON c.id = ms.statusid    	
    	JOIN assessmentprogram ap ON ap.id = m.assessmentprogramid
    	JOIN organization o ON o.id = ms.stateid
    	JOIN orgassessmentprogram oap on ap.id = oap.assessmentprogramid and oap.activeflag is true
    	<if test="userModulesOnly">
    		INNER JOIN usermodule um ON (m.id = um.moduleid and um.activeflag=true and um.userid = #{userId})
    	</if>    	
    	<if test="!userModulesOnly">
    		LEFT JOIN usermodule um ON (m.id = um.moduleid and um.activeflag=true and um.userid = #{userId})
    	</if>
    	LEFT JOIN Category enrlstatus ON um.enrollmentstatusid = enrlstatus.id
    WHERE c.categorycode = 'RELEASED'
    AND oap.organizationid = (select id from organization_parent(#{organizationId}) where contractingorganization is true union 
		select id from organization where id=#{organizationId} and contractingorganization is true) 
	AND ms.stateid = (select id from organization_parent(#{organizationId}) where contractingorganization is true union 
		select id from organization where id=#{organizationId} and contractingorganization is true) 
    <include refid="Extended_Modules_Where_Clause" />
    
    <if test="sortByColumn != null">
    	ORDER BY
    		<choose>
	      		<when test="sortByColumn == 'id'">m.id</when>
	      		<when test="sortByColumn == 'name'">m.name</when>
	      		<when test="sortByColumn == 'assessmentProgramName'">assessmentProgramName</when>
	      		<when test="sortByColumn == 'enrollmentStatusName'">enrollmentStatusName</when>
	      	</choose>
    	 	<if test="sortType=='desc'">
	    		desc
    	 	</if>
    	 	<if test="sortType=='asc' or sortType==null">
    	 		asc
    	 	</if>
	</if>
	
    LIMIT #{limit}
	OFFSET #{offset}
  </select>
  
  <select id="countModules" resultType="int">    	
    SELECT 
    	count(distinct m.id)
    FROM module m
    	JOIN modulestate ms ON m.id = ms.moduleid
    	JOIN category c ON c.id = ms.statusid    	
    	JOIN assessmentprogram ap ON ap.id = m.assessmentprogramid
    	JOIN organization o ON o.id = ms.stateid
    	JOIN orgassessmentprogram oap on ap.id = oap.assessmentprogramid and oap.activeflag is true
    	<if test="userModulesOnly">
    		INNER JOIN usermodule um ON (m.id = um.moduleid and um.activeflag=true and um.userid = #{userId})
    	</if>    	
    	<if test="!userModulesOnly">
    		LEFT JOIN usermodule um ON (m.id = um.moduleid and um.activeflag=true and um.userid = #{userId})
    	</if>
    	LEFT JOIN Category enrlstatus ON um.enrollmentstatusid = enrlstatus.id
    WHERE c.categorycode = 'RELEASED'
    AND oap.organizationid = (select id from organization_parent(#{organizationId}) where contractingorganization is true union 
		select id from organization where id=#{organizationId} and contractingorganization is true) 
	AND ms.stateid = (select id from organization_parent(#{organizationId}) where contractingorganization is true union 
		select id from organization where id=#{organizationId} and contractingorganization is true) 
    <include refid="Extended_Modules_Where_Clause" />   
  </select>

  <select id="getByModuleId" resultType="Module">
  	SELECT 
    	<include refid="Base_Column_List" />, mg.groupid, mt.tagid, t.id, t.tagname
    FROM public.module m
    	JOIN public.category c ON c.id = m.statusid
		LEFT JOIN modulegroup mg ON m.id = mg.moduleid
    	LEFT JOIN moduletag mt ON m.id = mt.moduleid
    	LEFT JOIN tag t ON t.id = mt.tagid
    WHERE m.id = #{moduleId}
  </select>
  <select id="getModuleByName" resultType="Module">
  	SELECT 
    	<include refid="Base_Column_List" />
    FROM public.module m
    	JOIN public.category c ON c.id = m.statusid  
    WHERE lower(m.name) = lower(#{name})
  </select>
   <select id="getModulesForPDuser" resultType="Module">
  	SELECT 
    	<include refid="Extended_Column_List" />
    FROM module m
    	JOIN modulestate ms ON m.id = ms.moduleid
    	JOIN category c ON c.id = m.statusid    	
    	JOIN assessmentprogram ap ON ap.id = m.assessmentprogramid
    	JOIN organization o ON o.id = ms.stateid
    	LEFT JOIN usermodule um ON m.id = um.moduleid
    	LEFT JOIN Category enrlstatus ON um.enrollmentstatusid = enrlstatus.id
    WHERE um.activeflag=true
    and m.stateassignedid != #{organizationId}
    <include refid="Extended_Modules_Where_Clause" />
    <if test="sortByColumn != null">
    	ORDER BY #{sortByColumn}
    		<if test="sortType=='desc'">
	    		desc
    	 	</if>
    	 	<if test="sortType=='asc' or sortType==null">
    	 		asc
    	 	</if>
	</if>
    LIMIT #{limit}
	OFFSET #{offset}
  </select>
  
</mapper>