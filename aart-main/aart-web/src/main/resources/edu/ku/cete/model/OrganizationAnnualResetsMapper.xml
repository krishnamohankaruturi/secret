<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.OrganizationAnnualResetsMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.OrganizationAnnualResets">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 13 15:05:44 CDT 2016.
    -->
    <result column="id" jdbcType="BIGINT" property="id" />
    <result column="organizationid" jdbcType="BIGINT" property="organizationId" />
    <result column="organizationname" jdbcType="VARCHAR" property="organizationName" />
    <result column="displayidentifier" jdbcType="VARCHAR" property="displayIdentifier" />
    <result column="schoolstartdate" jdbcType="TIMESTAMP" property="schoolStartDate" />
    <result column="schoolenddate" jdbcType="TIMESTAMP" property="schoolEndDate" />
    <result column="schoolyear" jdbcType="BIGINT" property="schoolYear" />
    <result column="fcsresetcomplete" jdbcType="BIT" property="fcsResetComplete" />
    <result column="schoolyearresetcomplete" jdbcType="BIT" property="schoolYearResetComplete" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="createduser" jdbcType="BIGINT" property="createdUser" />
    <result column="modifieduser" jdbcType="BIGINT" property="modifiedUser" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
  </resultMap>
  <insert id="insert" parameterType="edu.ku.cete.domain.OrganizationAnnualResets">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 13 15:05:44 CDT 2016.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('organizationannualresets_id_pk')
    </selectKey>
    insert into organizationannualresets (id, organizationid, organizationname, 
      displayidentifier, schoolstartdate, schoolenddate, 
      schoolyear, fcsresetcomplete, schoolyearresetcomplete, 
      activeflag, createddate, createduser, 
      modifieduser, modifieddate)
    values (#{id,jdbcType=BIGINT}, #{organizationId,jdbcType=BIGINT}, #{organizationName,jdbcType=VARCHAR}, 
      #{displayIdentifier,jdbcType=VARCHAR}, #{schoolStartDate,jdbcType=TIMESTAMP}, #{schoolEndDate,jdbcType=TIMESTAMP}, 
      #{schoolYear,jdbcType=BIGINT}, #{fcsResetComplete,jdbcType=BIT}, #{schoolYearResetComplete,jdbcType=BIT}, 
      #{activeFlag,jdbcType=BIT}, #{createdDate,jdbcType=TIMESTAMP}, #{createdUser,jdbcType=BIGINT}, 
      #{modifiedUser,jdbcType=BIGINT}, #{modifiedDate,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.OrganizationAnnualResets">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 13 15:05:44 CDT 2016.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('organizationannualresets_id_pk')
    </selectKey>
    insert into organizationannualresets
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="organizationId != null">
        organizationid,
      </if>
      <if test="organizationName != null">
        organizationname,
      </if>
      <if test="displayIdentifier != null">
        displayidentifier,
      </if>
      <if test="schoolStartDate != null">
        schoolstartdate,
      </if>
      <if test="schoolEndDate != null">
        schoolenddate,
      </if>
      <if test="schoolYear != null">
        schoolyear,
      </if>
      <if test="fcsResetComplete != null">
        fcsresetcomplete,
      </if>
      <if test="schoolYearResetComplete != null">
        schoolyearresetcomplete,
      </if>
      <if test="activeFlag != null">
        activeflag,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="createdUser != null">
        createduser,
      </if>
      <if test="modifiedUser != null">
        modifieduser,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="organizationId != null">
        #{organizationId,jdbcType=BIGINT},
      </if>
      <if test="organizationName != null">
        #{organizationName,jdbcType=VARCHAR},
      </if>
      <if test="displayIdentifier != null">
        #{displayIdentifier,jdbcType=VARCHAR},
      </if>
      <if test="schoolStartDate != null">
        #{schoolStartDate,jdbcType=TIMESTAMP},
      </if>
      <if test="schoolEndDate != null">
        #{schoolEndDate,jdbcType=TIMESTAMP},
      </if>
      <if test="schoolYear != null">
        #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="fcsResetComplete != null">
        #{fcsResetComplete,jdbcType=BIT},
      </if>
      <if test="schoolYearResetComplete != null">
        #{schoolYearResetComplete,jdbcType=BIT},
      </if>
      <if test="activeFlag != null">
        #{activeFlag,jdbcType=BIT},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createdUser != null">
        #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedUser != null">
        #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  
  <update flushCache="true" id="updateOrganizationAnnualResets" parameterType="edu.ku.cete.domain.OrganizationAnnualResets" statementType="PREPARED">
		update organizationannualresets 
		set schoolstartdate = #{schoolStartDate,jdbcType=TIMESTAMP}, 
			schoolenddate = #{schoolEndDate,jdbcType=TIMESTAMP}, 
			modifieduser = #{modifiedUser,jdbcType=BIGINT}, 
			modifieddate = #{modifiedDate,jdbcType=TIMESTAMP}, 
			schoolyearresetcomplete = #{schoolYearResetComplete,jdbcType=BIT}, 
			fcsresetcomplete = #{fcsResetComplete,jdbcType=BIT},
			schoolyear = #{schoolYear,jdbcType=BIGINT},
			organizationname = #{organizationName,jdbcType=VARCHAR},
      		displayidentifier =  #{displayIdentifier,jdbcType=VARCHAR}
      	where organizationid = #{organizationId,jdbcType=BIGINT} and activeflag is true 
   </update>
  
  <update id="inactivateOldRecords">
		UPDATE organizationannualresets
		SET activeflag = false
  </update>
  
   <update id="resetAnnualDates" parameterType="edu.ku.cete.domain.OrganizationAnnualResets">
		update organization 
		set schoolstartdate=(select schoolstartdate from organizationannualresets where organizationid = #{organizationId,jdbcType=BIGINT} and activeflag is true), 
		schoolenddate=(select schoolenddate from organizationannualresets where organizationid =#{organizationId,jdbcType=BIGINT} and activeflag is true),
		modifieduser = #{modifiedUser,jdbcType=BIGINT}, 
		modifieddate = #{modifiedDate,jdbcType=TIMESTAMP}
		where id = #{organizationId,jdbcType=BIGINT} and activeflag is true
   </update>
   
   <update id="resetAnnualDatesStatus" parameterType="edu.ku.cete.domain.OrganizationAnnualResets">
		update organizationannualresets 
		set schoolyearresetcomplete = true,
		modifieduser = #{modifiedUser,jdbcType=BIGINT}, 
		modifieddate = #{modifiedDate,jdbcType=TIMESTAMP}
		where organizationid = #{organizationId,jdbcType=BIGINT} and activeflag is true
   </update>   
   
   <select id="checkIfOrgUpdateRecordExists" resultMap="BaseResultMap">
	  	select * from organizationannualresets
		where organizationid = #{organizationId,jdbcType=BIGINT}
		and activeflag is true
   </select>
   
   <select id="getAnnualResetStates" resultMap="BaseResultMap">
		SELECT *
		FROM organizationannualresets
		WHERE activeflag = true and schoolyearresetcomplete = false
		ORDER BY organizationname
	</select>
 
 
  <select id="selectSchoolYearByOrgId" resultMap="BaseResultMap">
	  	SELECT organizationid, displayidentifier, schoolstartdate, schoolenddate, schoolyear, fcsresetcomplete, schoolyearresetcomplete
	  	FROM organizationannualresets
	  	WHERE organizationid=#{organizationId,jdbcType=BIGINT}
	  	AND activeflag is true
  </select>
   
  <update id="updateFCSResetCompleteFlagByOrgId">
		UPDATE organizationannualresets 
			SET fcsresetcomplete = #{fcsResetComplete,jdbcType=BIT}
			WHERE organizationid = #{organizationId,jdbcType=BIGINT}
			AND activeflag is true
  </update>
   
   <select id="getStatesBasedOnAssmntProgramIdFCSResetFlag" resultType="Organization">		
		SELECT org.* FROM organization org
			JOIN orgassessmentprogram orga ON orga.organizationid = org.id and orga.activeflag is true
			JOIN organizationannualresets orgreset ON org.id = orgreset.organizationid
			WHERE orga.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} 
		 		AND orga.activeflag = true 
				AND org.activeflag = true 
				AND organizationtypeid = (SELECT id FROM organizationtype WHERE typecode = 'ST')
				AND orgreset.fcsresetcomplete = false
				ORDER BY org.organizationname
	</select>
  
</mapper>