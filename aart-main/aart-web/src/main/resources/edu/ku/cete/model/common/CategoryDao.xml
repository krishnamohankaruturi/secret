<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.ku.cete.model.common.CategoryDao" >
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.common.Category" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="categoryname" property="categoryName" jdbcType="VARCHAR" />
    <result column="categorycode" property="categoryCode" jdbcType="VARCHAR" />
    <result column="categorydescription" property="categoryDescription" jdbcType="VARCHAR" />
    <result column="categorytypeid" property="categoryTypeId" jdbcType="BIGINT" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="createduser" jdbcType="INTEGER" property="createdUser" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
    <result column="modifieduser" jdbcType="INTEGER" property="modifiedUser" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />    
  </resultMap>
  
   <sql id="Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>      
    </where>
  </sql> 
	<select id="lastid" resultType="java.lang.Long">
		SELECT lastval() AS id
	</select>  
  <sql id="Example_Join_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
          and
        </if>
      </foreach>
      <foreach collection="categoryTypeCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and categoryType.${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and categoryType.${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and categoryType.${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and categoryType.${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>      
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    category.id, categoryname, categorycode,
     categorydescription, categorytypeid,
    category.createddate,category.createduser,category.modifieddate,category.modifieduser, category.activeflag
  </sql>
  <select id="selectByExample" resultMap="BaseResultMap" parameterType="edu.ku.cete.domain.common.CategoryExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from public.category
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByCategoryAndType" resultMap="BaseResultMap" parameterType="edu.ku.cete.domain.common.CategoryExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from public.category ,public.categorytype
    <if test="_parameter != null" >
      <include refid="Example_Join_Where_Clause" />
      and 
    </if>
    <if test="_parameter == null" >
      where 
    </if>
    category.categorytypeid = categorytype.id
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    select 
    <include refid="Base_Column_List" />
    from public.category
    where id = #{id,jdbcType=BIGINT}
  </select>
  
  <select id="selectByCategoryName" resultMap="BaseResultMap" >
    select 
    <include refid="Base_Column_List" />
    from public.category
    where categoryname ilike #{categoryName,jdbcType=VARCHAR} and activeflag is true limit 1
  </select>
  <select id="selectTestPurposeForInterim" resultMap="BaseResultMap" >
	select distinct (ct.id), ct.categoryname 
	from test t
	<if test="isInterim==true">
	join interimtest it on t.id=it.testtestid and it.currentschoolyear = #{schoolYear}
	</if>
	INNER JOIN testcollectionstests tct on t.id = tct.testid
	INNER JOIN testspecstatementofpurpose tstop on t.testspecificationid=tstop.testspecificationid
	INNER JOIN category ct on ct.id=tstop.statementofpurposeid 
	INNER JOIN  assessmentstestcollections atc on atc.testcollectionid=tct.testcollectionid
	INNER JOIN  assessment a on a.id=atc.assessmentid
	INNER JOIN  testingprogram tp on tp.id=a.testingprogramid
	INNER JOIN  assessmentprogram ap on tp.assessmentprogramid=ap.id
	INNER JOIN  category c  on c.id=t.status
	INNER JOIN  categorytype cct on c.categorytypeid = cct.id and c.categorycode='DEPLOYED' and cct.typecode='TESTSTATUS'  
	where tstop.activeflag is true and t.qccomplete is true and c.activeflag is true and ct.activeflag is true
	 and tp.programname ilike 'interim' and ap.id = #{assessmentProgramId} and t.activeflag is true
	 and t.is_interim_test=#{isInterim}
	<if test="isInterim==true">
		<if test="organizationId != null">
			and it.organizationid in (
			select od.id from
			organization_children((select op.id from organization_parent(#{organizationId}) op
			inner join organizationtype ot ON op.organizationtypeid=ot.id
			where ot.typecode='ST'
			union
			select o.id from organization o
			inner join organizationtype ot ON o.organizationtypeid=ot.id
			where ot.typecode='ST' and o.id = #{organizationId})) od
			inner join organizationtype ot ON od.organizationtypeid=ot.id
			where ot.typecode='DT')
		</if>
	</if>
	group by ct.id, ct.categoryname 
	order by ct.categoryname asc;
	
</select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    delete from public.category
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <delete id="deleteByExample" parameterType="edu.ku.cete.domain.common.CategoryExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    delete from public.category
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="edu.ku.cete.domain.common.Category" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    insert into public.category (categoryname, categorycode, 
      categorydescription, categorytypeid, createddate, createduser, activeflag, modifieddate, modifieduser)
    values (#{categoryName,jdbcType=VARCHAR}, #{categoryCode,jdbcType=VARCHAR}, 
      #{categoryDescription,jdbcType=VARCHAR}, #{categoryTypeId,jdbcType=BIGINT}, #{createdDate}, #{createdUser}, #{activeFlag},#{modifiedDate},#{modifiedUser})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.common.Category" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    insert into public.category
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="categoryName != null" >
        categoryname,
      </if>
      <if test="categoryCode != null" >
        categorycode,
      </if>
      <if test="categoryDescription != null" >
        categorydescription,
      </if>
      <if test="categoryTypeId != null" >
        categorytypeid,
      </if>
       	createddate, 
		createduser, 
		activeflag,
		modifieddate, 
		modifieduser,
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="categoryName != null" >
        #{categoryName,jdbcType=VARCHAR},
      </if>
      <if test="categoryCode != null" >
        #{categoryCode,jdbcType=VARCHAR},
      </if>
      <if test="categoryDescription != null" >
        #{categoryDescription,jdbcType=VARCHAR},
      </if>
      <if test="categoryTypeId != null" >
        #{categoryTypeId,jdbcType=BIGINT},
      </if>
      #{createdDate},
	  #{createdUser},
	  #{activeFlag},
	  #{modifiedDate},
	  #{modifiedUser},      
    </trim>
  </insert>
  <insert id="insertSelectiveByType" parameterType="map" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    insert into public.category
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="category.categoryName != null" >
        categoryname,
      </if>
      <if test="category.categoryCode != null" >
        categorycode,
      </if>
      <if test="category.categoryDescription != null" >
        categorydescription,
      </if>
      <if test="categoryTypeCode != null" >
        categorytypeid,
      </if>
        createddate, 
		createduser, 
		activeflag,
		modifieddate, 
		modifieduser,
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="category.categoryName != null" >
        #{category.categoryName,jdbcType=VARCHAR},
      </if>
      <if test="category.categoryCode != null" >
        #{category.categoryCode,jdbcType=VARCHAR},
      </if>
      <if test="category.categoryDescription != null" >
        #{category.categoryDescription,jdbcType=VARCHAR},
      </if>
      <if test="categoryTypeCode != null" >
        (Select id from categorytype where typecode = #{categoryTypeCode,jdbcType=VARCHAR} ),
      </if>
      #{category.createdDate},
	  #{category.createdUser},
	  #{category.activeFlag},
	  #{category.modifiedDate},
	  #{category.modifiedUser},
    </trim>
  </insert>  
  <select id="countByExample" parameterType="edu.ku.cete.domain.common.CategoryExample" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    select count(*) from public.category
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    update public.category
    <set >
      <if test="record.id != null" >
        id = #{record.id,jdbcType=BIGINT},
      </if>
      <if test="record.categoryName != null" >
        categoryname = #{record.categoryName,jdbcType=VARCHAR},
      </if>
      <if test="record.categoryCode != null" >
        categorycode = #{record.categoryCode,jdbcType=VARCHAR},
      </if>
      <if test="record.categoryDescription != null" >
        categorydescription = #{record.categoryDescription,jdbcType=VARCHAR},
      </if>
      <if test="record.categoryTypeId != null" >
        categorytypeid = #{record.categoryTypeId,jdbcType=BIGINT},
      </if>
      modifieddate = #{record.modifiedDate},
	  modifieduser = #{record.modifiedUser},
	  activeflag = #{record.activeFlag}, 
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    update public.category
    set id = #{record.id,jdbcType=BIGINT},
      categoryname = #{record.categoryName,jdbcType=VARCHAR},
      categorycode = #{record.categoryCode,jdbcType=VARCHAR},
      categorydescription = #{record.categoryDescription,jdbcType=VARCHAR},
      categorytypeid = #{record.categoryTypeId,jdbcType=BIGINT},
      modifieddate = #{record.modifiedDate},
	  modifieduser = #{record.modifiedUser},
	  activeflag = #{record.activeFlag} 
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.common.Category" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    update public.category
    <set >
      <if test="categoryName != null" >
        categoryname = #{categoryName,jdbcType=VARCHAR},
      </if>
      <if test="categoryCode != null" >
        categorycode = #{categoryCode,jdbcType=VARCHAR},
      </if>
      <if test="categoryDescription != null" >
        categorydescription = #{categoryDescription,jdbcType=VARCHAR},
      </if>
      <if test="categoryTypeId != null" >
        categorytypeid = #{categoryTypeId,jdbcType=BIGINT},
      </if>
      modifieddate = #{modifiedDate},
	 modifieduser = #{modifiedUser},
	 activeflag = #{activeFlag},
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.common.Category" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 04 16:44:50 CDT 2012.
    -->
    update public.category
    set categoryname = #{categoryName,jdbcType=VARCHAR},
      categorycode = #{categoryCode,jdbcType=VARCHAR},
      categorydescription = #{categoryDescription,jdbcType=VARCHAR},
      categorytypeid = #{categoryTypeId,jdbcType=BIGINT},
      modifieddate = #{modifiedDate},
	  modifieduser = #{modifiedUser},
      activeflag = #{activeFlag} 
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="getCategoryId" parameterType="map" resultType="java.lang.Long" >
    SELECT c.id
		FROM   category c,
		       categorytype ct
		WHERE  c.categorytypeid = ct.id
		AND    c.categorycode   = #{categoryCode}
		AND    ct.typecode      = #{categoryTypeCode}
  </select>
   <update id="updateByCategoryCode">
	update category
	set activeflag = #{status},
	modifieddate = #{modifiedDate},
	modifiedUser = #{modifiedUser}
	where categorycode = #{categoryCode}
  </update>
  <select id="getStatusITI" parameterType="map" resultType="java.lang.Boolean" >
    SELECT activeFlag
		FROM   category
		WHERE categorycode = #{categoryCode}
  </select>
  
  <select id="getAllComplexityBands" resultType="java.lang.String">
    select c.id||'-'||c.categorycode 
    from category c inner join categorytype ct on c.categorytypeid = ct.id 
	where ct.typecode='COMPLEXITY_BAND'							
  </select>
  
  <select id="getReportNames" resultMap="BaseResultMap">
  	select * from category where categorytypeid = (select id from categorytype where typecode = 'REPORT_TYPES_UI') and activeflag is true
  </select>
   
   
  <select id="getReportAccessData" resultType="edu.ku.cete.web.ReportAccessDTO">	  	
				
	select t1.id,t1.reportName,t1.permission, t1.stateid, t1.reporttypeid, t1.authorityId, t1.subjectid, t1.subject , t1.organizationname, 
	string_AGG(DISTINCT t1.rolesAccess,',' ORDER BY t1.rolesAccess desc ) AS rolesAccess,
	string_AGG(DISTINCT t1.rolesHavePerm,',' ORDER BY t1.rolesHavePerm desc ) AS rolesHavePerm 
	from ( SELECT rap.id as id, cat.categoryname AS reportName, au.displayname AS permission , org.organizationname, rap.stateid, rap. reporttypeid,  
	  	au.id AS authorityId , rap.subjectid , ca.name AS subject, 
	  	array_to_string(ARRAY_AGG(DISTINCT g.groupcode),',') AS rolesAccess,
	  	array_to_string(ARRAY_AGG(DISTINCT gps.groupcode),',') AS rolesHavePerm
	  	FROM reportassessmentprogram rap 
	  	LEFT JOIN authorities au ON au.id = rap.authorityid and au.activeflag = true 
	  	LEFT JOIN category cat ON rap.reporttypeid = cat.id 
	  	LEFT JOIN contentarea ca ON ca.id = rap.subjectid 
	  	LEFT JOIN reportassessmentprogramgroup RG ON RG.reportassessmentprogramid=rap.id and rg.activeflag is TRUE 
	  	LEFT JOIN groups g ON g.id=rg.groupid and g.id in 
	  		(select gau.groupid from groupauthorities gau where gau.authorityId=au.id and gau.activeflag is true  
	  		and gau.assessmentprogramid=#{assessmentPrgId} 
			and gau.organizationid in (rap.stateid))		
	 	LEFT JOIN groups gps ON gps.id in 
	   		(select gau.groupid from groupauthorities gau where gau.authorityId=au.id and gau.activeflag is true 
	   		and gau.assessmentprogramid=#{assessmentPrgId}  and gau.organizationid in (rap.stateid))
		LEFT JOIN organization org on rap.stateid = org.id		
		WHERE rap.stateid in		
		<foreach collection="stateId" item="stateIds" open="(" close=")" separator=",">
					#{stateIds}
		</foreach>
						
		AND rap.assessmentprogramid = #{assessmentPrgId}
		AND rap.activeflag is TRUE
		
		<if test="toRemoveStudentArchiveReport != null and toRemoveStudentArchiveReport.size > 0" >
			AND cat.categorycode not in		
			<foreach collection="toRemoveStudentArchiveReport" item="categoryCode" open="(" close=")" separator=",">
				#{categoryCode}
			</foreach>		
		</if>
		
		<if test="reportCode != null and reportCode.size > 0">
			AND cat.categorycode in
			<foreach collection="reportCode" item="categoryCode" open="(" close=")" separator=",">
					#{categoryCode}
			</foreach>
		</if>
		
		<if test="testSessionRecordCriteriaMap.reportName != null">
			AND (cat.categoryname) ilike #{testSessionRecordCriteriaMap.reportName}
		</if>
		<if test="testSessionRecordCriteriaMap.permission != null">
			AND (au.displayname) ilike #{testSessionRecordCriteriaMap.permission}
		</if>
		<if test="testSessionRecordCriteriaMap.subject != null">
			AND (ca.name) ilike #{testSessionRecordCriteriaMap.subject}
		</if>
		<if test="testSessionRecordCriteriaMap.rolesAccess != null">
			AND (g.groupname) ilike #{testSessionRecordCriteriaMap.rolesAccess}
		</if>
		GROUP BY
		rap.id,cat.categoryname, org.organizationname, rap.stateid, rap.reporttypeid, au.id, rap.subjectid, ca.name,au.id,g.organizationtypeid
		ORDER BY g.organizationtypeid
	)t1
	group by t1.id,t1.reportName,t1.permission, t1.stateid, t1.reporttypeid, t1.authorityId, 
	 t1.subjectid, t1.subject, t1.organizationname 
		
	<if test="sidx != null">
		ORDER BY 
		<choose>
			<when test="sidx == 'reportName'">reportName</when>
			<when test="sidx == 'rolesAccess'">rolesAccess</when>
			<when test="sidx == 'subject'">subject</when>
			<when test="sidx == 'permission'">permission</when>
			<when test="sidx == 'reportName,subject'">reportName,subject</when>
			<otherwise>id</otherwise>
		</choose>
		<if test="sord!=null and sord=='desc'">
			desc
		</if>
		<if test="sord=='asc' or sord==null">
			asc
		</if>
	</if>
		
  </select>

   <select id="getCategoryIdByName" resultType="java.lang.Long">
  	select id from category where categoryname = #{interimAllowedPurpose}
  </select>
  
  <select id="getTestSessionStatusMap" resultType="hashmap">
  select ct.id,ct.categoryname from category ct 
inner join categorytype cct on cct.id=ct.categorytypeid 
where ct.activeflag is true and cct.activeflag is true and cct.typecode='STUDENT_TEST_STATUS'
</select>
<select id="getScoringStatusMap" resultType="hashmap">
  select ct.id,ct.categoryname from category ct 
inner join categorytype cct on cct.id=ct.categorytypeid 
where ct.activeflag is true and cct.activeflag is true and cct.typecode='SCORING_STATUS'
</select>

<select id="getCategoryIdByCode" resultType="java.lang.Long" >
    SELECT c.id
		FROM   category c,
		       categorytype ct
		WHERE  c.categorytypeid = ct.id
		AND    ct.typecode      = #{categoryTypeCode}
		
		
		<if test="categoryCodes!=null and categoryCodes.size > 0">
		AND    c.categorycode  in  
				<foreach collection="categoryCodes" item="categoryCode" open="(" close=")" separator=",">
					#{categoryCode}
				</foreach>

		</if>
		
</select>

<select id="getCategoriesByCategoryTypeCodeAndCategoryCodes" parameterType="map" resultMap="BaseResultMap">
  SELECT <include refid="Base_Column_List"/>
  FROM categorytype
  JOIN category ON categorytype.id = category.categorytypeid
  WHERE categorytype.typecode = #{categoryTypeCode,jdbcType=VARCHAR}
  <if test="categoryCodes != null and categoryCodes.size > 0">
    AND category.categorycode IN
      <foreach collection="categoryCodes" item="categoryCode" open="(" close=")" separator=",">
        #{categoryCode}
      </foreach>
  </if>
</select>

<select id="getExtractAccessData" resultType="edu.ku.cete.web.ReportAccessDTO">
	  	
	select t1.id,t1.reportName,t1.permission, t1.stateid, t1.reporttypeid, t1.authorityId, t1.organizationname, 
	string_AGG(DISTINCT t1.rolesAccess,',' ORDER BY t1.rolesAccess desc ) AS rolesAccess,
	string_AGG(DISTINCT t1.rolesHavePerm,',' ORDER BY t1.rolesHavePerm desc ) AS rolesHavePerm 
	from ( SELECT rap.id as id, rap.extractname AS reportName, au.displayname AS permission , org.organizationname, rap.stateid, 
			rap. extracttypeid AS reporttypeid, au.id AS authorityId , 
	  		array_to_string(ARRAY_AGG(DISTINCT g.groupcode),',') AS rolesAccess,
	  		array_to_string(ARRAY_AGG(DISTINCT gps.groupcode),',') AS rolesHavePerm
	  		FROM extractassessmentprogram rap 
	  		LEFT JOIN authorities au ON au.id = rap.authorityid and au.activeflag = true 
		  	LEFT JOIN extractassessmentprogramgroup RG ON RG.extractassessmentprogramid=rap.id and rg.activeflag is TRUE 
		  	LEFT JOIN groups g ON g.id=rg.groupid and g.id in 
	  			(select gau.groupid from groupauthorities gau where gau.authorityId=au.id and gau.activeflag is true  
	  			and gau.assessmentprogramid=#{assessmentPrgId} 
				and gau.organizationid in (rap.stateid))				
	 		LEFT JOIN groups gps ON gps.id in 
	  			(select gau.groupid from groupauthorities gau where gau.authorityId=au.id and gau.activeflag is true 
	  			and gau.assessmentprogramid=#{assessmentPrgId}  and gau.organizationid in(rap.stateid) )		
			LEFT JOIN organization org on rap.stateid = org.id		
			WHERE rap.stateid in		
			<foreach collection="stateId" item="stateIds" open="(" close=")" separator=",">
					#{stateIds}
			</foreach>		
			AND rap.assessmentprogramid = #{assessmentPrgId}
			AND rap.activeflag is TRUE
			<if test="testSessionRecordCriteriaMap.reportName != null">
				AND (cat.categoryname) ilike #{testSessionRecordCriteriaMap.reportName}
			</if>
			<if test="testSessionRecordCriteriaMap.permission != null">
				AND (au.displayname) ilike #{testSessionRecordCriteriaMap.permission}
			</if>
			<if test="testSessionRecordCriteriaMap.subject != null">
				AND (ca.name) ilike #{testSessionRecordCriteriaMap.subject}
			</if>
			<if test="testSessionRecordCriteriaMap.rolesAccess != null">
				AND (g.groupname) ilike #{testSessionRecordCriteriaMap.rolesAccess}
			</if>
			GROUP BY
			rap.id, rap.extractname, org.organizationname, rap.stateid, rap.extracttypeid, au.id, au.id,g.organizationtypeid
			ORDER BY g.organizationtypeid
		)t1
		group by t1.id,t1.reportName,t1.permission,t1.stateid, t1.reporttypeid, t1.authorityId,  
	   	t1.organizationname
		
		<if test="sidx != null">
		ORDER BY 
		<choose>
			<when test="sidx == 'reportName'">reportName</when>
			<when test="sidx == 'rolesAccess'">rolesAccess</when>
			<when test="sidx == 'permission'">permission</when>
			<when test="sidx == 'reportName,subject'">reportName</when>
			<otherwise>id</otherwise>
		</choose>
		<if test="sord!=null and sord=='desc'">
			desc
		</if>
		<if test="sord=='asc' or sord==null">
			asc
		</if>
	</if>
  </select>

 
   <select id="getDlmExtractAccessId" resultType="java.lang.Long">  
   	
	select ep.extracttypeid from extractassessmentprogram ep 
	LEFT JOIN extractassessmentprogramgroup epg on ep.id = epg.extractassessmentprogramid and epg.activeflag is true
	where epg.groupid = #{currentGroupId} 
	and ep.stateid = #{currentStateId} 
	and ep.assessmentprogramid = #{currentAssessmentPgmId} 	 
	
  </select>
  


   <select id="getParentStateIdByChildId" resultType="java.lang.Long"> 
		WITH RECURSIVE organization_relation(organizationid, parentorganizationid) AS (
		SELECT organizationid, parentorganizationid FROM organizationrelation WHERE organizationid = #{organizationId}
		UNION
		SELECT
		organizationrelation.organizationid, organizationrelation.parentorganizationid
		FROM organizationrelation, organization_relation AS parentorganization_relation
		WHERE organizationrelation.organizationid = parentorganization_relation.parentorganizationid)
		
		SELECT id as parentStateId
		FROM organization WHERE activeflag = true and id IN (SELECT parentorganizationid FROM organization_relation) 
		and organizationtypeid = (SELECT id FROM organizationtype WHERE typecode = 'ST');
  </select> 
  
  <select id = "getReportAccessPermissionForReports" resultType = "java.lang.String">
  	select au.authority as authorityCode from reportassessmentprogram rap 
	LEFT JOIN reportassessmentprogramgroup rapg on rap.id = rapg.reportassessmentprogramid and rapg.activeflag is true 
	LEFT JOIN category cat on rap.reporttypeid = cat.id
	LEFT JOIN authorities au on au.id = rap.authorityid
	where rapg.groupid = #{currentGroupId,jdbcType=BIGINT}
		and rap.stateid = #{currentStateId,jdbcType=BIGINT}
		and rap.assessmentprogramid = #{currentAssessmentPgmId,jdbcType=BIGINT}
		and rap.reporttypeid = (select id from category where categorycode = #{categoryCode,jdbcType=VARCHAR})
 	  
  </select>

</mapper>