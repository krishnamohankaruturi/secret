<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.RawToScaleScoresMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.report.RawToScaleScores">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 21 02:47:21 CDT 2016.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="schoolyear" jdbcType="BIGINT" property="schoolYear" />
    <result column="assessmentprogramid" jdbcType="BIGINT" property="assessmentProgramId" />
    <result column="subjectid" jdbcType="BIGINT" property="subjectId" />
    <result column="gradeid" jdbcType="BIGINT" property="gradeId" />
    <result column="testid1" jdbcType="BIGINT" property="testId1" />
    <result column="testid2" jdbcType="BIGINT" property="testId2" />
    <result column="rawscore" jdbcType="NUMERIC" property="rawScore" />
    <result column="scalescore" jdbcType="BIGINT" property="scaleScore" />
    <result column="standarderror" jdbcType="NUMERIC" property="standardError" />
    <result column="batchuploadid" jdbcType="BIGINT" property="batchUploadId" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="testid3" jdbcType="BIGINT" property="testId3" />
    <result column="testid4" jdbcType="BIGINT" property="testId4" />
    <result column="performance_testid" jdbcType="BIGINT" property="performanceTestId" />
    <result column="performance_subjectid" jdbcType="BIGINT" property="performanceSubjectId" />
    <result column="performance_item_weight" jdbcType="NUMERIC" property="performanceItemWeight" />
    <result column="performance_rawscore_include_flag" jdbcType="BIT" property="performanceRawscoreIncludeFlag" />
    <result column="testingprogramid" jdbcType="BIGINT" property="testingProgramId" />
    <result column="reportcycle" jdbcType="VARCHAR" property="reportCycle" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 21 02:47:21 CDT 2016.
    -->
    id, schoolyear, assessmentprogramid, subjectid, gradeid, testid1, testid2, rawscore, 
    scalescore, standarderror, batchuploadid, createddate, testid3, testid4, performance_testid, 
    performance_subjectid, performance_item_weight, performance_rawscore_include_flag, testingprogramid, reportcycle
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 21 02:47:21 CDT 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from rawtoscalescores
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.report.RawToScaleScores">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 21 02:47:21 CDT 2016.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('rawtoscalescores_id_seq')
    </selectKey>
    insert into rawtoscalescores (id, schoolyear, assessmentprogramid, 
      subjectid, gradeid, testid1, 
      testid2, rawscore, scalescore, 
      standarderror, batchuploadid, createddate, 
      testid3, testid4, performance_testid, 
      performance_subjectid, performance_item_weight, 
      performance_rawscore_include_flag, domain)
    values (#{id,jdbcType=BIGINT}, #{schoolYear,jdbcType=BIGINT}, #{assessmentProgramId,jdbcType=BIGINT}, 
      #{subjectId,jdbcType=BIGINT}, #{gradeId,jdbcType=BIGINT}, #{testId1,jdbcType=BIGINT}, 
      #{testId2,jdbcType=BIGINT}, #{rawScore,jdbcType=NUMERIC}, #{scaleScore,jdbcType=BIGINT}, 
      #{standardError,jdbcType=NUMERIC}, #{batchUploadId,jdbcType=BIGINT}, #{createdDate,jdbcType=TIMESTAMP}, 
      #{testId3,jdbcType=BIGINT}, #{testId4,jdbcType=BIGINT}, #{performanceTestId,jdbcType=BIGINT}, 
      #{performanceSubjectId,jdbcType=BIGINT}, #{performanceItemWeight,jdbcType=NUMERIC}, 
      #{performanceRawscoreIncludeFlag,jdbcType=BIT}, #{domain,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.report.RawToScaleScores">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 21 02:47:21 CDT 2016.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('rawtoscalescores_id_seq')
    </selectKey>
    insert into rawtoscalescores
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="schoolYear != null">
        schoolyear,
      </if>
      <if test="assessmentProgramId != null">
        assessmentprogramid,
      </if>
      <if test="subjectId != null">
        subjectid,
      </if>
      <if test="gradeId != null">
        gradeid,
      </if>
      <if test="testId1 != null">
        testid1,
      </if>
      <if test="testId2 != null">
        testid2,
      </if>
      <if test="rawScore != null">
        rawscore,
      </if>
      <if test="scaleScore != null">
        scalescore,
      </if>
      <if test="standardError != null">
        standarderror,
      </if>
      <if test="batchUploadId != null">
        batchuploadid,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="testId3 != null">
        testid3,
      </if>
      <if test="testId4 != null">
        testid4,
      </if>
      <if test="performanceTestId != null">
        performance_testid,
      </if>
      <if test="performanceSubjectId != null">
        performance_subjectid,
      </if>
      <if test="performanceItemWeight != null">
        performance_item_weight,
      </if>
      <if test="performanceRawscoreIncludeFlag != null">
        performance_rawscore_include_flag,
      </if>
      <if test="domain != null">
        domain,
      </if>
      <if test="testingProgramId != null">
        testingprogramid,
      </if>
      <if test="reportCycle != null">
        reportcycle,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="schoolYear != null">
        #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null">
        #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="subjectId != null">
        #{subjectId,jdbcType=BIGINT},
      </if>
      <if test="gradeId != null">
        #{gradeId,jdbcType=BIGINT},
      </if>
      <if test="testId1 != null">
        #{testId1,jdbcType=BIGINT},
      </if>
      <if test="testId2 != null">
        #{testId2,jdbcType=BIGINT},
      </if>
      <if test="rawScore != null">
        #{rawScore,jdbcType=NUMERIC},
      </if>
      <if test="scaleScore != null">
        #{scaleScore,jdbcType=BIGINT},
      </if>
      <if test="standardError != null">
        #{standardError,jdbcType=NUMERIC},
      </if>
      <if test="batchUploadId != null">
        #{batchUploadId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="testId3 != null">
        #{testId3,jdbcType=BIGINT},
      </if>
      <if test="testId4 != null">
        #{testId4,jdbcType=BIGINT},
      </if>
      <if test="performanceTestId != null">
        #{performanceTestId,jdbcType=BIGINT},
      </if>
      <if test="performanceSubjectId != null">
        #{performanceSubjectId,jdbcType=BIGINT},
      </if>
      <if test="performanceItemWeight != null">
        #{performanceItemWeight,jdbcType=NUMERIC},
      </if>
      <if test="performanceRawscoreIncludeFlag != null">
        #{performanceRawscoreIncludeFlag,jdbcType=BIT},
      </if>
      <if test="domain != null">
        #{domain,jdbcType=VARCHAR},
      </if>
      <if test="testingProgramId != null">
         #{testingProgramId,jdbcType=BIGINT},
      </if>
      <if test="reportCycle != null">
        #{reportCycle,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.report.RawToScaleScores">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 21 02:47:21 CDT 2016.
    -->
    update rawtoscalescores
    <set>
      <if test="schoolYear != null">
        schoolyear = #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null">
        assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="subjectId != null">
        subjectid = #{subjectId,jdbcType=BIGINT},
      </if>
      <if test="gradeId != null">
        gradeid = #{gradeId,jdbcType=BIGINT},
      </if>
      <if test="testId1 != null">
        testid1 = #{testId1,jdbcType=BIGINT},
      </if>
      <if test="testId2 != null">
        testid2 = #{testId2,jdbcType=BIGINT},
      </if>
      <if test="rawScore != null">
        rawscore = #{rawScore,jdbcType=NUMERIC},
      </if>
      <if test="scaleScore != null">
        scalescore = #{scaleScore,jdbcType=BIGINT},
      </if>
      <if test="standardError != null">
        standarderror = #{standardError,jdbcType=NUMERIC},
      </if>
      <if test="batchUploadId != null">
        batchuploadid = #{batchUploadId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="testId3 != null">
        testid3 = #{testId3,jdbcType=BIGINT},
      </if>
      <if test="testId4 != null">
        testid4 = #{testId4,jdbcType=BIGINT},
      </if>
      <if test="performanceTestId != null">
        performance_testid = #{performanceTestId,jdbcType=BIGINT},
      </if>
      <if test="performanceSubjectId != null">
        performance_subjectid = #{performanceSubjectId,jdbcType=BIGINT},
      </if>
      <if test="performanceItemWeight != null">
        performance_item_weight = #{performanceItemWeight,jdbcType=NUMERIC},
      </if>
      <if test="performanceRawscoreIncludeFlag != null">
        performance_rawscore_include_flag = #{performanceRawscoreIncludeFlag,jdbcType=BIT},
      </if>
      <if test="domain != null">
        domain = #{domain,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.report.RawToScaleScores">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Mar 21 02:47:21 CDT 2016.
    -->
    update rawtoscalescores
    set schoolyear = #{schoolYear,jdbcType=BIGINT},
      assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      subjectid = #{subjectId,jdbcType=BIGINT},
      gradeid = #{gradeId,jdbcType=BIGINT},
      testid1 = #{testId1,jdbcType=BIGINT},
      testid2 = #{testId2,jdbcType=BIGINT},
      rawscore = #{rawScore,jdbcType=NUMERIC},
      scalescore = #{scaleScore,jdbcType=BIGINT},
      standarderror = #{standardError,jdbcType=NUMERIC},
      batchuploadid = #{batchUploadId,jdbcType=BIGINT},
      createddate = #{createdDate,jdbcType=TIMESTAMP},
      testid3 = #{testId3,jdbcType=BIGINT},
      testid4 = #{testId4,jdbcType=BIGINT},
      performance_testid = #{performanceTestId,jdbcType=BIGINT},
      performance_subjectid = #{performanceSubjectId,jdbcType=BIGINT},
      performance_item_weight = #{performanceItemWeight,jdbcType=NUMERIC},
      performance_rawscore_include_flag = #{performanceRawscoreIncludeFlag,jdbcType=BIT},
      domain = #{domain,jdbcType=VARCHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <delete id="deleteAll">
    delete from rawtoscalescores 
    <if test="schoolYear != null">
     where schoolyear = #{schoolYear,jdbcType=BIGINT}
     </if>
  </delete>
  
  <delete id="deleteRawToScaleScores">
    delete from rawtoscalescores
    where assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} 
    and subjectid = #{subjectId,jdbcType=BIGINT} 
    and schoolyear = #{schoolYear,jdbcType=BIGINT}
    <if test="testingProgramId != null">
    	and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
    </if>
    <if test="reportCycle != null">
    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
    </if>
  </delete>
  
  <select id="checkDuplicateTestIdsWithRawScore" resultType="java.lang.Integer">
   	select count(rs.*)
   	 from rawtoscalescores rs
   	 join testingprogram tp on tp.assessmentprogramid = rs.assessmentprogramid and tp.id = rs.testingprogramid and tp.activeflag is true where rs.testid1 = #{testId1,jdbcType=BIGINT} 
   	 <if test="testId2 == null">
        and rs.testid2 is null
     </if>
     <if test="testId2 != null">
        and rs.testid2 = #{testId2,jdbcType=BIGINT}
     </if>
     <if test="testId3 == null">
        and rs.testid3 is null
     </if>
     <if test="testId3 != null">
        and rs.testid3 = #{testId3,jdbcType=BIGINT}
     </if>
     <if test="testId4 == null">
        and rs.testid4 is null
     </if>
     <if test="testId4 != null">
        and rs.testid4 = #{testId4,jdbcType=BIGINT}
     </if>
     <if test="performanceTestId == null">
        and rs.performance_testid is null
     </if>
     <if test="performanceTestId != null">
        and rs.performance_testid = #{performanceTestId,jdbcType=BIGINT}
     </if>
     <if test="schoolYear!=null">
	  	and rs.schoolyear = #{schoolYear,jdbcType=BIGINT}
	 </if>
	 <if test="subjectId != null">
	    and rs.subjectid = #{subjectId,jdbcType=BIGINT}
	 </if>
	 <if test="gradeId != null">
	    and rs.gradeid = #{gradeId,jdbcType=BIGINT}
	 </if>
	 <if test="domain != null">
	    and rs.domain = #{domain,jdbcType=VARCHAR}
	 </if>
	 and rs.rawscore = #{rawScore,jdbcType=NUMERIC} 
	 and rs.scalescore != #{scaleScore,jdbcType=BIGINT}
	 and rs.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} and rs.subjectid = #{subjectId,jdbcType=BIGINT}
	 <if test="testingProgramName != null">
		and	tp.programname= #{testingProgramName,jdbcType=VARCHAR}
	 </if>
	 <if test="reportCycle != null">
		and rs.reportcycle = #{reportCycle,jdbcType=BIGINT}
	 </if>
  </select>
  
  <select id="getFirstIncludePerformanceFlagForAssessmentProgramSubjectGrade" resultMap="BaseResultMap">
   	select *
   	 from rawtoscalescores rs
   	 join testingprogram tp on tp.assessmentprogramid = rs.assessmentprogramid and tp.id = rs.testingprogramid and tp.activeflag is true
   	 where rs.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} 
   		<if test="subjectId != null">
   			and rs.subjectid = #{subjectId,jdbcType=BIGINT}
   		</if>
   		<if test="gradeId != null">
   			and rs.gradeid = #{gradeId,jdbcType=BIGINT}
   		</if>
   		<if test="schoolYear != null">
	   		and rs.schoolyear = #{schoolYear,jdbcType=BIGINT}
	    </if>
	    <if test="testingProgramName != null">
			and	tp.programname= #{testingProgramName,jdbcType=VARCHAR}
	    </if>
	    <if test="reportCycle != null">
	   		and rs.reportcycle = #{reportCycle,jdbcType=BIGINT}
	    </if>
	   limit 1
  </select>
  
   <select id="selectDistinctTestIds" resultType="java.lang.Long">
    with gradeids as (select id from gradecourse where abbreviatedname = (select abbreviatedname from gradecourse where id = #{gradeId,jdbcType=BIGINT}))
   	select DISTINCT TESTID1 from rawtoscalescores 
   		where TESTID1 is not null 
   		and assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
   		and subjectid = #{subjectId,jdbcType=BIGINT}
   		and gradeid = any(array(select id from gradeids))
   		<if test="schoolYear!=null">
	   		and schoolyear = #{schoolYear,jdbcType=BIGINT}
	    </if>
	    <if test="testingProgramId != null">
	   		and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	    </if>
	    <if test="reportCycle != null">
	    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
	    </if>
	UNION
	select DISTINCT TESTID2 from rawtoscalescores 
		where TESTID2 is not null
		and assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
   		and subjectid = #{subjectId,jdbcType=BIGINT}
   		and gradeid = any(array(select id from gradeids))
   		<if test="schoolYear!=null">
	   		and schoolyear = #{schoolYear,jdbcType=BIGINT}
	    </if>
	    <if test="testingProgramId != null">
	   		and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	    </if>
	    <if test="reportCycle != null">
	    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
	    </if>
   	UNION
	select DISTINCT TESTID3 from rawtoscalescores 
		where TESTID3 is not null
		and assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
   		and subjectid = #{subjectId,jdbcType=BIGINT}
   		and gradeid = any(array(select id from gradeids))
   		<if test="schoolYear!=null">
	   		and schoolyear = #{schoolYear,jdbcType=BIGINT}
	    </if>
	    <if test="testingProgramId != null">
	   		and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	    </if>
	    <if test="reportCycle != null">
	    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
	    </if>
   	UNION
	select DISTINCT TESTID4 from rawtoscalescores 
		where TESTID4 is not null
		and assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
   		and subjectid = #{subjectId,jdbcType=BIGINT}
   		and gradeid = any(array(select id from gradeids))
   		<if test="schoolYear!=null">
	   		and schoolyear = #{schoolYear,jdbcType=BIGINT}
	    </if>
	    <if test="testingProgramId != null">
	   		and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	    </if>
	    <if test="reportCycle != null">
	    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
	    </if>
   	UNION
	select DISTINCT performance_testid from rawtoscalescores 
		where performance_testid is not null
		and assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
   		and subjectid = #{subjectId,jdbcType=BIGINT}
   		and gradeid = any(array(select id from gradeids))
   		<if test="schoolYear!=null">
	   		and schoolyear = #{schoolYear,jdbcType=BIGINT}
	    </if>
	    <if test="testingProgramId != null">
	   		and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	    </if>
	    <if test="reportCycle != null">
	    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
	    </if>
  </select>
  
  <select id="selectByTestId1TestId2RawScore" resultMap="BaseResultMap">
   select * from rawtoscalescores
   where testid1 = ANY(Array
   <foreach close="]" collection="testIds" item="testId" open="[" separator=",">
			#{testId}
	</foreach>
	)
   <if test="testIds.size &gt; 1">
         and testid2 = ANY(Array
         <foreach close="]" collection="testIds" item="testId" open="[" separator=",">
			#{testId}
		</foreach>
		)
   </if>
   <if test="testIds.size == 1">
         and testid2 is null
   </if>
   and rawscore = #{rawScore,jdbcType=NUMERIC} 
   and assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} and subjectid = #{subjectId,jdbcType=BIGINT}
   <if test="schoolYear!=null">
   	and schoolyear = #{schoolYear,jdbcType=BIGINT}
   </if>
    limit 1  
  </select>
  
  
  <select id="selectByTestIdsAPSubjIdGradeId" resultMap="BaseResultMap">
   	select  <include refid="Base_Column_List" /> from rawtoscalescores
	   where assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} 
	   and subjectid = #{subjectId,jdbcType=BIGINT} 
	   and gradeid=#{gradeId,jdbcType=BIGINT} 
	   and schoolyear = #{schoolYear,jdbcType=BIGINT}
	   <if test="testId1 != null">
        and testid1 = ANY(Array
	   <foreach close="]" collection="testIds" item="testId" open="[" separator=",">
				#{testId}
		</foreach>
		)
	   </if>
	   <if test="testId2 != null">
	        and testid2 = ANY(Array
	         <foreach close="]" collection="testIds" item="testId" open="[" separator=",">
				#{testId}
			</foreach>
			)
	   </if>
	   <if test="testId3 != null">
	      and testid3 = ANY(Array
	         <foreach close="]" collection="testIds" item="testId" open="[" separator=",">
				#{testId}
			</foreach>
			)
	   </if>
	   <if test="testId4 != null">
	      and testid4 = ANY(Array
	         <foreach close="]" collection="testIds" item="testId" open="[" separator=",">
				#{testId}
			</foreach>
			)
	   </if>
	   <if test="performanceTestId != null">
	       and performance_testid = #{performanceTestId,jdbcType=BIGINT} 
	   </if> 
	   <if test="rawScore != null">
	   	  	and rawscore = #{rawScore,jdbcType=NUMERIC} 
	   </if>
	   <if test="testId2 == null">
	   		and testid2 is null
	   </if>
	   
	   <if test="testId3 == null">
	   		and testid3 is null
	   </if>
	   
	   <if test="testId4 == null">
	   		and testid4 is null
	   </if>
	   <if test="performanceTestId == null">
	   		and performance_testid is null
	   </if>
	   <if test="testingProgramId != null">
	   		and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	   </if>
	   <if test="reportCycle != null">
	    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
	   </if>   	
	   limit 1  
  </select>
  
</mapper>