<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.SubscoreFrameworkMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.report.SubscoreFramework">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 19 09:40:35 CDT 2015.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="schoolyear" jdbcType="BIGINT" property="schoolYear" />
    <result column="assessmentprogramid" jdbcType="BIGINT" property="assessmentProgramId" />
    <result column="subjectid" jdbcType="BIGINT" property="subjectId" />
    <result column="gradeid" jdbcType="BIGINT" property="gradeId" />
    <result column="subscoredefinitionname" jdbcType="VARCHAR" property="subScoreDefinitionName" />
    <result column="framework" jdbcType="VARCHAR" property="framework" />
    <result column="frameworklevel1" jdbcType="VARCHAR" property="frameworkLevel1" />
    <result column="frameworklevel2" jdbcType="VARCHAR" property="frameworkLevel2" />
    <result column="frameworklevel3" jdbcType="VARCHAR" property="frameworkLevel3" />
    <result column="batchuploadid" jdbcType="BIGINT" property="batchUploadId" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 19 09:40:35 CDT 2015.
    -->
    id, schoolyear, assessmentprogramid, subjectid, gradeid, subscoredefinitionname, 
    framework, frameworklevel1, frameworklevel2, frameworklevel3, batchuploadid, createddate
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 19 09:40:35 CDT 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from subscoreframework
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.report.SubscoreFramework">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 19 09:40:35 CDT 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('subscoreframework_id_seq')
    </selectKey>
    insert into subscoreframework (id, schoolyear, assessmentprogramid, 
      subjectid, gradeid, subscoredefinitionname, 
      framework, frameworklevel1, frameworklevel2, 
      frameworklevel3, batchuploadid, createddate
      )
    values (#{id,jdbcType=BIGINT}, #{schoolYear,jdbcType=BIGINT}, #{assessmentProgramId,jdbcType=BIGINT}, 
      #{subjectId,jdbcType=BIGINT}, #{gradeId,jdbcType=BIGINT}, #{subScoreDefinitionName,jdbcType=VARCHAR}, 
      #{framework,jdbcType=VARCHAR}, #{frameworkLevel1,jdbcType=VARCHAR}, #{frameworkLevel2,jdbcType=VARCHAR}, 
      #{frameworkLevel3,jdbcType=VARCHAR}, #{batchUploadId,jdbcType=BIGINT}, #{createdDate,jdbcType=TIMESTAMP}
      )
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.report.SubscoreFramework">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 19 09:40:35 CDT 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('subscoreframework_id_seq')
    </selectKey>
    insert into subscoreframework
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="schoolYear != null">
        schoolyear,
      </if>
      <if test="assessmentProgramId != null">
        assessmentprogramid,
      </if>
      <if test="subjectId != null">
        subjectid,
      </if>
      <if test="gradeId != null">
        gradeid,
      </if>
      <if test="subScoreDefinitionName != null">
        subscoredefinitionname,
      </if>
      <if test="framework != null">
        framework,
      </if>
      <if test="frameworkLevel1 != null">
        frameworklevel1,
      </if>
      <if test="frameworkLevel2 != null">
        frameworklevel2,
      </if>
      <if test="frameworkLevel3 != null">
        frameworklevel3,
      </if>
      <if test="batchUploadId != null">
        batchuploadid,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="schoolYear != null">
        #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null">
        #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="subjectId != null">
        #{subjectId,jdbcType=BIGINT},
      </if>
      <if test="gradeId != null">
        #{gradeId,jdbcType=BIGINT},
      </if>
      <if test="subScoreDefinitionName != null">
        #{subScoreDefinitionName,jdbcType=VARCHAR},
      </if>
      <if test="framework != null">
        #{framework,jdbcType=VARCHAR},
      </if>
      <if test="frameworkLevel1 != null">
        #{frameworkLevel1,jdbcType=VARCHAR},
      </if>
      <if test="frameworkLevel2 != null">
        #{frameworkLevel2,jdbcType=VARCHAR},
      </if>
      <if test="frameworkLevel3 != null">
        #{frameworkLevel3,jdbcType=VARCHAR},
      </if>
      <if test="batchUploadId != null">
        #{batchUploadId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.report.SubscoreFramework">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 19 09:40:35 CDT 2015.
    -->
    update subscoreframework
    <set>
      <if test="schoolYear != null">
        schoolyear = #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null">
        assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="subjectId != null">
        subjectid = #{subjectId,jdbcType=BIGINT},
      </if>
      <if test="gradeId != null">
        gradeid = #{gradeId,jdbcType=BIGINT},
      </if>
      <if test="subScoreDefinitionName != null">
        subscoredefinitionname = #{subScoreDefinitionName,jdbcType=VARCHAR},
      </if>
      <if test="framework != null">
        framework = #{framework,jdbcType=VARCHAR},
      </if>
      <if test="frameworkLevel1 != null">
        frameworklevel1 = #{frameworkLevel1,jdbcType=VARCHAR},
      </if>
      <if test="frameworkLevel2 != null">
        frameworklevel2 = #{frameworkLevel2,jdbcType=VARCHAR},
      </if>
      <if test="frameworkLevel3 != null">
        frameworklevel3 = #{frameworkLevel3,jdbcType=VARCHAR},
      </if>
      <if test="batchUploadId != null">
        batchuploadid = #{batchUploadId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.report.SubscoreFramework">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 19 09:40:35 CDT 2015.
    -->
    update subscoreframework
    set schoolyear = #{schoolYear,jdbcType=BIGINT},
      assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      subjectid = #{subjectId,jdbcType=BIGINT},
      gradeid = #{gradeId,jdbcType=BIGINT},
      subscoredefinitionname = #{subScoreDefinitionName,jdbcType=VARCHAR},
      framework = #{framework,jdbcType=VARCHAR},
      frameworklevel1 = #{frameworkLevel1,jdbcType=VARCHAR},
      frameworklevel2 = #{frameworkLevel2,jdbcType=VARCHAR},
      frameworklevel3 = #{frameworkLevel3,jdbcType=VARCHAR},
      batchuploadid = #{batchUploadId,jdbcType=BIGINT},
      createddate = #{createdDate,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>
   <delete id="deleteAll">
    delete from subscoreframework
    <if test="schoolYear != null">
    	where schoolyear = #{schoolYear,jdbcType=BIGINT}
     </if>
  </delete>
  
  <delete id="deleteSubscoreFrameworks">
    delete from subscoreframework
    where assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} and subjectid = #{subjectId,jdbcType=BIGINT}
     <if test="schoolYear != null">
    	and schoolyear = #{schoolYear,jdbcType=BIGINT}
     </if>
  </delete>
  
  <select id="selectSubscoreframeworkByAssessmentGradeSubjectLevel1Level2" resultMap="BaseResultMap">
    select * from subscoreframework
	where assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} and 
	subjectid = #{subjectId,jdbcType=BIGINT} and
	gradeid = #{gradeId,jdbcType=BIGINT} and 
	upper(subScoreDefinitionName) =  upper(#{subScoreDefinitionName,jdbcType=VARCHAR}) and 
	upper(framework) =  upper(#{frameworkCode,jdbcType=VARCHAR}) and 
	upper(frameworklevel1) = upper(#{frameworkCodeLevel1,jdbcType=VARCHAR}) and
	upper(frameworklevel2) = upper(#{frameworkCodeLevel2,jdbcType=VARCHAR})
	<if test="frameworkCodeLevel3 != null">
		and upper(frameworklevel3) = upper(#{frameworkCodeLevel3,jdbcType=VARCHAR})
	</if>	
	<if test="schoolYear != null">
    	and schoolyear = #{schoolYear,jdbcType=BIGINT}
     </if>
  </select>
  
  <select id="mapSubscoreDefinitionFromTaskVariantIdUsingContentCode" resultType="java.lang.String">
    select distinct subscores.subscoredefinitionname
	from (select parentcfd.contentcode as grandparentcode, parentcfd.contentcode, fwl.level, cfd.contentcode as itemcode
	from taskvariantcontentframeworkdetail tvcfd 
	join contentframeworkdetail cfd ON tvcfd.contentframeworkdetailid = cfd.id
	join contentframework cfw on cfw.id = cfd.contentframeworkid
	join frameworklevel fwl on fwl.id = cfd.frameworklevelid
	join contentframeworkdetail parentcfd ON parentcfd.id = cfd.parentcontentframeworkdetailid 
	where tvcfd.taskvariantid = #{taskVariantId,jdbcType=BIGINT}
	union
	select grandparentcfd.contentcode as grandparentcode, parentcfd.contentcode, fwl.level,parentcfd.contentcode as itemcode
	from taskvariantcontentframeworkdetail tvcfd 
	join contentframeworkdetail cfd ON tvcfd.contentframeworkdetailid = cfd.id
	join contentframeworkdetail parentcfd ON cfd.parentcontentframeworkdetailid = parentcfd.id
	join contentframework cfw on cfw.id = parentcfd.contentframeworkid
	join contentframeworkdetail grandparentcfd ON grandparentcfd.id = parentcfd.parentcontentframeworkdetailid
	join frameworklevel fwl on fwl.id = parentcfd.frameworklevelid 
	where tvcfd.taskvariantid = #{taskVariantId,jdbcType=BIGINT}) contents 
	inner join subscoreframework subscores
		ON CASE    WHEN contents.level = 1 THEN (contents.contentcode = subscores.frameworklevel1 AND subscores.frameworklevel2='All')
                   WHEN contents.level = 2 THEN ((((contents.contentcode = subscores.frameworklevel1 AND subscores.frameworklevel2='All') OR contents.itemcode = subscores.frameworklevel2))
                          OR  (contents.grandparentcode = subscores.frameworklevel1 AND subscores.frameworklevel2='All'))
                   WHEN contents.level = 3 THEN ((((contents.contentcode = subscores.frameworklevel2 AND subscores.frameworklevel3='All') OR contents.itemcode = subscores.frameworklevel3))
                          OR  (contents.grandparentcode = subscores.frameworklevel1 AND subscores.frameworklevel3='All'))

                  END
	WHERE subscores.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} and subscores.subjectid = #{subjectId,jdbcType=BIGINT} and
	subscores.gradeid = #{gradeId,jdbcType=BIGINT}
	<if test="schoolYear != null">
    	and subscores.schoolyear = #{schoolYear,jdbcType=BIGINT}
     </if>
  </select> 
  
  <select id="getMissingSubscoreDefinitions" resultType="java.lang.String">
  		SELECT distinct subscores.subscoredefinitionname from subscoreframework subscores
  		WHERE  subscores.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} AND subscores.subjectid = #{subjectId,jdbcType=BIGINT} AND
		subscores.gradeid = #{gradeId,jdbcType=BIGINT}
		<if test="schoolYear != null">
	    	AND subscores.schoolyear = #{schoolYear,jdbcType=BIGINT}
	    </if>	    
  </select>
</mapper>