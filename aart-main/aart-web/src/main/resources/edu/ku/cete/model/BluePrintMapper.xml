<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.BluePrintMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.BluePrint">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 25 10:28:09 CDT 2015.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="contentareaid" jdbcType="BIGINT" property="contentAreaId" />
    <result column="gradecourseid" jdbcType="BIGINT" property="gradeCourseId" />
    <result column="gradebandid" jdbcType="BIGINT" property="gradeBandId" />
    <result column="criteria" jdbcType="BIGINT" property="criteria" />
    <result column="groupnumber" jdbcType="BIGINT" property="groupNumber" />
    <result column="numberrequired" jdbcType="BIGINT" property="numberRequired" />
    <result column="createduser" jdbcType="INTEGER" property="createdUser" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="modifieduser" jdbcType="INTEGER" property="modifiedUser" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
    <result column="writingtestlet" jdbcType="BIT" property="writingTestlet" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 25 10:28:09 CDT 2015.
    -->
    id, contentareaid, gradecourseid, gradebandid, criteria, groupnumber, numberrequired, 
    createduser, createddate, modifieduser, modifieddate, activeflag, writingtestlet
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 25 10:28:09 CDT 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from blueprint
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.BluePrint">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 25 10:28:09 CDT 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('blueprint_id_seq')
    </selectKey>
    insert into blueprint (id, contentareaid, gradecourseid, 
      gradebandid, criteria, groupnumber, 
      numberrequired, createduser, createddate, 
      modifieduser, modifieddate, activeflag, 
      writingtestlet)
    values (#{id,jdbcType=BIGINT}, #{contentAreaId,jdbcType=BIGINT}, #{gradeCourseId,jdbcType=BIGINT}, 
      #{gradeBandId,jdbcType=BIGINT}, #{criteria,jdbcType=BIGINT}, #{groupNumber,jdbcType=BIGINT}, 
      #{numberRequired,jdbcType=BIGINT}, #{createdUser,jdbcType=INTEGER}, #{createdDate,jdbcType=TIMESTAMP}, 
      #{modifiedUser,jdbcType=INTEGER}, #{modifiedDate,jdbcType=TIMESTAMP}, #{activeFlag,jdbcType=BIT}, 
      #{writingTestlet,jdbcType=BIT})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.BluePrint">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 25 10:28:09 CDT 2015.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('blueprint_id_seq')
    </selectKey>
    insert into blueprint
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="contentAreaId != null">
        contentareaid,
      </if>
      <if test="gradeCourseId != null">
        gradecourseid,
      </if>
      <if test="gradeBandId != null">
        gradebandid,
      </if>
      <if test="criteria != null">
        criteria,
      </if>
      <if test="groupNumber != null">
        groupnumber,
      </if>
      <if test="numberRequired != null">
        numberrequired,
      </if>
      <if test="createdUser != null">
        createduser,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="modifiedUser != null">
        modifieduser,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
      <if test="activeFlag != null">
        activeflag,
      </if>
      <if test="writingTestlet != null">
        writingtestlet,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="contentAreaId != null">
        #{contentAreaId,jdbcType=BIGINT},
      </if>
      <if test="gradeCourseId != null">
        #{gradeCourseId,jdbcType=BIGINT},
      </if>
      <if test="gradeBandId != null">
        #{gradeBandId,jdbcType=BIGINT},
      </if>
      <if test="criteria != null">
        #{criteria,jdbcType=BIGINT},
      </if>
      <if test="groupNumber != null">
        #{groupNumber,jdbcType=BIGINT},
      </if>
      <if test="numberRequired != null">
        #{numberRequired,jdbcType=BIGINT},
      </if>
      <if test="createdUser != null">
        #{createdUser,jdbcType=INTEGER},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedUser != null">
        #{modifiedUser,jdbcType=INTEGER},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="activeFlag != null">
        #{activeFlag,jdbcType=BIT},
      </if>
      <if test="writingTestlet != null">
        #{writingTestlet,jdbcType=BIT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.BluePrint">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 25 10:28:09 CDT 2015.
    -->
    update blueprint
    <set>
      <if test="contentAreaId != null">
        contentareaid = #{contentAreaId,jdbcType=BIGINT},
      </if>
      <if test="gradeCourseId != null">
        gradecourseid = #{gradeCourseId,jdbcType=BIGINT},
      </if>
      <if test="gradeBandId != null">
        gradebandid = #{gradeBandId,jdbcType=BIGINT},
      </if>
      <if test="criteria != null">
        criteria = #{criteria,jdbcType=BIGINT},
      </if>
      <if test="groupNumber != null">
        groupnumber = #{groupNumber,jdbcType=BIGINT},
      </if>
      <if test="numberRequired != null">
        numberrequired = #{numberRequired,jdbcType=BIGINT},
      </if>
      <if test="createdUser != null">
        createduser = #{createdUser,jdbcType=INTEGER},
      </if>
      <if test="createdDate != null">
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedUser != null">
        modifieduser = #{modifiedUser,jdbcType=INTEGER},
      </if>
      <if test="modifiedDate != null">
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="activeFlag != null">
        activeflag = #{activeFlag,jdbcType=BIT},
      </if>
      <if test="writingTestlet != null">
        writingtestlet = #{writingTestlet,jdbcType=BIT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.BluePrint">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 25 10:28:09 CDT 2015.
    -->
    update blueprint
    set contentareaid = #{contentAreaId,jdbcType=BIGINT},
      gradecourseid = #{gradeCourseId,jdbcType=BIGINT},
      gradebandid = #{gradeBandId,jdbcType=BIGINT},
      criteria = #{criteria,jdbcType=BIGINT},
      groupnumber = #{groupNumber,jdbcType=BIGINT},
      numberrequired = #{numberRequired,jdbcType=BIGINT},
      createduser = #{createdUser,jdbcType=INTEGER},
      createddate = #{createdDate,jdbcType=TIMESTAMP},
      modifieduser = #{modifiedUser,jdbcType=INTEGER},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      activeflag = #{activeFlag,jdbcType=BIT},
      writingtestlet = #{writingTestlet,jdbcType=BIT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <resultMap id="BluePrintDetailsMap" type="edu.ku.cete.domain.BluePrint">
  	<result column="id" jdbcType="BIGINT" property="id" />
    <result column="contentareaid" jdbcType="BIGINT" property="contentAreaId" />
    <result column="gradecourseid" jdbcType="BIGINT" property="gradeCourseId" />
    <result column="gradebandid" jdbcType="BIGINT" property="gradeBandId" />
    <result column="criteria" jdbcType="BIGINT" property="criteria" />
    <result column="groupnumber" jdbcType="BIGINT" property="groupNumber" />
    <result column="numberrequired" jdbcType="BIGINT" property="numberRequired" />
    <result column="createduser" jdbcType="INTEGER" property="createdUser" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="modifieduser" jdbcType="INTEGER" property="modifiedUser" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="writingtestlet" jdbcType="BIT" property="writingTestlet" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
	<collection column="id" javaType="ArrayList" ofType="edu.ku.cete.domain.BluePrintEssentialElements" property="bluePrintEssentialElements">
	    <result column="blueprintid" jdbcType="BIGINT" property="bluePrintId" />
	    <result column="essentialelementid" jdbcType="BIGINT" property="essentialElementId" />
	    <result column="essentialElement" jdbcType="VARCHAR" property="essentialElement" />
	    <result column="ordernumber" jdbcType="BIGINT" property="orderNumber" />
	</collection>
  </resultMap>
  
  <select id="selectByContentAreaAndGrade" resultMap="BluePrintDetailsMap">
	select 
    <include refid="Base_Column_List" />
    , bpee.essentialelementid, bpee.essentialelement, bpee.ordernumber
    from blueprint bp
    inner join blueprintessentialelements bpee on bpee.blueprintid=bp.id
    where bp.contentareaid = #{contentAreaId,jdbcType=BIGINT} and bp.activeflag=true
    and bp.gradecourseid in (select id from gradecourse where abbreviatedname=#{gradeCode,jdbcType=VARCHAR})
  </select>
  
  <resultMap id="writingTestsBpCriteriaTestsMap" type="edu.ku.cete.domain.test.ContentFrameworkDetail" >
		<result column="essentialelementid" property="id"/>
		<result column="essentialelement" property="name"/>
		<result property="id" column="id"/>
  	 	<result property="criteriaNumber" column="criteria"/>
		<collection property="groupsNumbers" ofType="java.lang.Long" javaType="list">
  	 		<result column="groupnumber"/>
  	 	</collection>	
	</resultMap>
  
  <select id="selectWritingByLinkageLevel" resultMap="writingTestsBpCriteriaTestsMap">
	select distinct bp.criteria, bp.groupnumber, bpee.essentialelementid, bpee.essentialelement
    from blueprint bp
    inner join blueprintessentialelements bpee on bpee.blueprintid=bp.id
    inner join proportionmetrics pm on pm.essentialelementid=bpee.essentialelementid and pm.activeflag=true
    where bp.contentareaid = #{contentAreaId,jdbcType=BIGINT} and bp.activeflag=true and bp.writingtestlet=true 
    and bp.contentareaid=pm.contentareaid
    <if test="linkageLevelCodes !=null">
		and pm.linkagelevelabbr in
		<foreach collection="linkageLevelCodes" item="linkageLevelCode" open="(" close=")" separator=",">
			 #{linkageLevelCode}
		</foreach>
	</if>
    and bp.criteria=#{criteriaNum,jdbcType=BIGINT}
    and bp.gradecourseid in (select id from gradecourse where abbreviatedname=#{gradeCode,jdbcType=VARCHAR})
  </select>
  
  <resultMap id="itiBluePrintCriteriaMap" type="edu.ku.cete.dlm.iti.BPCriteriaAndGroups">
 	 	<result column="criteria" property="criteriaNum"/>
 	 	<result column="writingtestlet" property="writingCriteria"/>
 	 	<result column="gradecourseid" property="gradeCourseId"/>
 	 	<result column="gradebandid" property="gradeBandId"/>
 	 	<result column="contentareaid" property="contentAreaId"/>
 	 	<result column="maxcriteria" property="maxCriteriaNum"/>
 	 	<association property="listOfEEs" javaType="edu.ku.cete.domain.test.ContentFrameworkDetail">
 	 		<result column="essentialelementid"  property="id"/>
 	 		<result column="essentialelement" property="name"/>
 	 		<result column="criteria" property="criteriaNumber"/>
 	 		<collection property="groupsNumbers" ofType="java.lang.Long" javaType="list">
 	 			<result column="groupnumber"/>
 	 		</collection>
 	 	</association>
 	 	 <association property="grouspInfos" javaType="edu.ku.cete.dlm.iti.BPGroupsInfo">
 	 	 	<result column="criteria" property="criteriaId"/>
 	 	 	<result column="groupnumber" property="groupNumber"/>
 	 	 	<result column="numberrequired" property="numberOfEEsRequired"/>
 	 	 </association>
  </resultMap>
  
  <select id="getBluePrintCriteriasByGradeAndSub" resultMap="itiBluePrintCriteriaMap">
  	  with max_criteria AS(select max(criteria) as maxcriteria from blueprint where contentareaid = #{contentAreaId} 
  	  	and gradecourseid in (select id from gradecourse where abbreviatedname=#{gradeCode}))
  	  select bp.criteria as criteria, bp.groupnumber as groupnumber, bp.numberrequired as numberrequired,
  	  bp.contentareaid as contentareaid, bp.gradebandid as gradebandid, bp.gradecourseid as gradecourseid,
  	  CASE WHEN (SELECT count(*) FROM blueprint WHERE id = bp.id AND bp.writingtestlet) > 0 THEN true ELSE false END as writingtestlet,  	  
  	  (select maxcriteria from max_criteria) as maxcriteria, bpee.essentialelementid, bpee.essentialelement
  	  from blueprint bp
  	  join blueprintessentialelements bpee on bp.id = bpee.blueprintid
  	  where contentareaid = #{contentAreaId}
  	  and gradecourseid in (select id from gradecourse where abbreviatedname=#{gradeCode})
  	  and activeflag is true order by bp.criteria, bp.groupnumber
  </select>
  
  <resultMap id="bluePrintCriteriaDescriptionMap" type="edu.ku.cete.domain.BluePrintCriteriaDescription">
  		<result column="id" property="id"/>
  		<result column="contentareaabbrname" property="contentAreaAbbrName"/>
  		<result column="contentareaid" property="contentAreaId"/>
  		<result column="gradecourseabbrname" property="gradeCourseAbbrName"/>
  		<result column="gradecourseid" property="gradeCourseId"/>
  		<result column="criteria" property="criteria"/>
  		<result column="criteriatext" property="criteriaText"/> 		
  </resultMap>
    
  <select id="getBluePrintCriteriaDescByGradeAndSub" resultMap="bluePrintCriteriaDescriptionMap">
  	select * from blueprintcriteriadescription
  		where contentareaid = #{contentAreaId} 
  		and gradecourseabbrname = #{gradeCourseAbbrName}
  		order by criteria     
  </select>
  
  <select id="getBluePrintCriteriasByGradeAndSubAndCriteria" resultMap="itiBluePrintCriteriaMap">
  	  select criteria, groupnumber, numberrequired
  	  from blueprint  	   
  	  where contentareaid = #{contentAreaId}
  	  and gradecourseid in (select id from gradecourse where abbreviatedname = #{gradeCourseAbbrName})
  	  and criteria = #{criteria}
  	  and activeflag is true
  </select>  
  
</mapper>