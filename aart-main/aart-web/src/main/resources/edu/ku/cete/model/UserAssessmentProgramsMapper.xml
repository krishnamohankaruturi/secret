<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!-- Added for US16239 (add assessment program to user) 
 -->
<mapper namespace="edu.ku.cete.model.UserAssessmentProgramsMapper" >
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.UserAssessmentPrograms" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jul 03 12:41:12 IST 2015.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="aartuserid" property="aartUserId" jdbcType="BIGINT" />
    <result column="assessmentprogramid" property="assessmentProgramId" jdbcType="BIGINT" />
    <result column="activeflag" property="activeFlag" jdbcType="BIT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jul 03 12:41:12 IST 2015.
    -->
    id, aartuserid, assessmentprogramid, activeflag, isdefault
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jul 03 12:41:12 IST 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from userassessmentprogram
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.UserAssessmentPrograms" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jul 03 12:41:12 IST 2015.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('userassessmentprogram_id_seq')
    </selectKey>
    insert into userassessmentprogram (id, aartuserid, assessmentprogramid, 
      activeflag, createduser,createddate, modifieduser, modifieddate, isdefault, userorganizationsgroupsid)
    values (#{id,jdbcType=BIGINT}, #{aartUserId,jdbcType=BIGINT}, #{assessmentProgramId,jdbcType=BIGINT}, 
      #{activeFlag,jdbcType=BIT}, #{createdUser,jdbcType=BIGINT},  #{createdDate,jdbcType=TIMESTAMP}, 
      #{modifiedUser, jdbcType=BIGINT},  #{modifiedDate,jdbcType=TIMESTAMP}, #{isDefault,jdbcType=BIT},  #{userOrganizationGroupId,jdbcType=BIGINT})
  </insert>
  <!-- Added during US16351-Add multiple assessment programs based on user Id -->
   <insert id="insertMultiple" parameterType="java.util.Map" >
    insert into userassessmentprogram (aartuserid, assessmentprogramid, isdefault,userorganizationsgroupsid) values (
        <foreach collection="assessmentProgramsIds" item="assessmentProgramsId" open="" close="" separator="),(">
            #{userId},#{assessmentProgramsId}
            <if test="assessmentProgramsId == defaultAssessmentProgramId" >
		        ,true
	      	</if>
	      	<if test="assessmentProgramsId != defaultAssessmentProgramId" >
		        ,false
	      	</if>
	      	,#{userOrganizationGroupId}
        </foreach>
        );
   </insert>
   
   <delete id="deleteAssessmentPrograms" parameterType="Long">
  	delete from userassessmentprogram where aartuserid = #{userId}
   </delete>
   
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.UserAssessmentPrograms" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jul 03 12:41:12 IST 2015.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('userassessmentprogram_id_seq')
    </selectKey>
    insert into userassessmentprogram
    <trim prefix="(" suffix=")" suffixOverrides="," >
      id,
      <if test="aartUserId != null" >
        aartuserid,
      </if>
      <if test="assessmentProgramId != null" >
        assessmentprogramid,
      </if>
      <if test="userOrganizationGroupId != null" >
        userorganizationsgroupsid,
      </if>
      <if test="activeFlag != null" >
        activeflag,
      </if>
      <if test="isDefault != null" >
        isdefault,
      </if>
      <if test="createdDate != null" >
        createddate,
      </if>
      <if test="modifiedDate != null" >
        modifieddate,
      </if>
      <if test="createdUser != null" >
        createduser,
      </if>
      <if test="modifiedUser != null" >
        modifieduser,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      #{id,jdbcType=BIGINT},
      <if test="aartUserId != null" >
        #{aartUserId,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null" >
        #{assessmentProgramId,jdbcType=BIGINT},
      </if>
       <if test="userOrganizationGroupId != null" >
        #{userOrganizationGroupId,jdbcType=BIGINT},
      </if>
      <if test="activeFlag != null" >
        #{activeFlag,jdbcType=BIT},
      </if>
       <if test="isDefault != null" >
        #{isDefault,jdbcType=BIT},
      </if>
      <if test="createdDate != null" >
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null" >
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createdUser != null" >
        #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedUser != null" >
        #{modifiedUser,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.UserAssessmentPrograms" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jul 03 12:41:12 IST 2015.
    -->
    update userassessmentprogram
    <set >
      <if test="aartUserId != null" >
        aartuserid = #{aartUserId,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null" >
        assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="activeFlag != null" >
        activeflag = #{activeFlag,jdbcType=BIT},
      </if>
      <if test="isDefault != null" >
        isdefault = #{isDefault,jdbcType=BIT},
      </if>
      <if test="modifiedDate != null" >
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedUser != null" >
        modifieduser = #{modifiedUser,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.UserAssessmentPrograms" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jul 03 12:41:12 IST 2015.
    -->
    update userassessmentprogram
    set aartuserid = #{aartUserId,jdbcType=BIGINT},
      assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      activeflag = #{activeFlag,jdbcType=BIT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="selectByUserId" resultType="edu.ku.cete.domain.UserAssessmentPrograms"  parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from userassessmentprogram
    where aartuserid = #{userId,jdbcType=BIGINT}
  </select>

   <select id="isUserInAssessmentProgram" resultType="Boolean" parameterType="map">
    select
      case when exists (
        select 1
        from userassessmentprogram
        where aartuserid = #{userId} and assessmentprogramid = #{assessmentProgramId} and userorganizationsgroupsid=#{userOrgGroupId} and activeflag = true
      )
      then true
      else false end
  </select>
  
  <update id="updateUserAssessmentProgram" parameterType="edu.ku.cete.domain.UserAssessmentPrograms">
  	update userassessmentprogram set activeflag = true,
  		isdefault = #{isDefault,jdbcType=BIT},  		
		modifieduser = #{modifiedUser, jdbcType=BIGINT},
		modifieddate = #{modifiedDate,jdbcType=TIMESTAMP}
		where aartuserid = #{aartUserId,jdbcType=BIGINT} 
			and  assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} 
			and userorganizationsgroupsid = #{userOrganizationGroupId,jdbcType=BIGINT} 
			and activeflag is false
  </update>
  
  <select id="selectByUserIdAssessmentProrgramId" resultType="edu.ku.cete.domain.UserAssessmentPrograms"  parameterType="java.lang.Long">
  	 select 
 	uap.id, uap.aartuserid, uap.assessmentprogramid, uap.activeflag, uap.isdefault,
 	uap.userorganizationsgroupsid as userOrganizationGroupId
 	from userassessmentprogram uap
    inner join userorganizationsgroups uog on uap.userorganizationsgroupsid = uog.id
  	inner join usersorganizations uo on uo.id = uog.userorganizationid
    where uap.aartuserid = #{userId,jdbcType=BIGINT} and uap.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
    and uo.organizationid = #{organizationId,jdbcType=BIGINT} and uog.groupid = #{groupId,jdbcType=BIGINT} and uap.activeflag is true
  </select>

  <update id="updateDefaultByPrimaryKeySelective" parameterType="edu.ku.cete.domain.UserAssessmentPrograms" >
    update userassessmentprogram
    <set >
      <if test="isDefault != null" >
        isdefault = #{isDefault,jdbcType=BIT},
      </if>
      <if test="modifiedDate != null" >
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedUser != null" >
        modifieduser = #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="activeFlag != null" >
      activeflag = #{activeFlag,jdbcType=BIT},
      </if>
    </set>
    where id = #{id} and aartuserid = #{aartUserId, jdbcType=BIGINT} 
    <!-- and activeflag is true -->;
    
    update userassessmentprogram
    <set >
      <if test="isDefault != null" >
        isdefault = false,
      </if>
      <if test="modifiedDate != null" >
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedUser != null" >
        modifieduser = #{modifiedUser,jdbcType=BIGINT},
      </if>
    </set>
    where id != #{id} and aartuserid = #{aartUserId, jdbcType=BIGINT} 
    and activeflag is true
  </update>
  
  <select id="getUserDefaultAssessmentProgram" parameterType="java.lang.Long" resultType="edu.ku.cete.domain.UserAssessmentPrograms">
  	select uap.id as id, uap.aartuserid as aartUserId, uap.assessmentprogramid as assessmentProgramId, uap.activeflag as activeFlag,
  	uap.isdefault as isDefault, uog.groupid as groupId, uo.organizationid as organizationId
  	from userassessmentprogram uap
  	inner join userorganizationsgroups uog on uap.userorganizationsgroupsid = uog.id and uap.activeflag is true and uog.activeflag is true
  	inner join usersorganizations uo on uo.id = uog.userorganizationid and uo.activeflag is true
  	where uap.aartuserid = #{userId, jdbcType=BIGINT} and uap.isdefault is true and uap.activeflag is true
  </select>

  <select id="getUserRoles" resultType="edu.ku.cete.domain.UserAssessmentPrograms">
	SELECT * FROM (
	SELECT ua.id as id ,
		case when org.organizationtypeid = (select id from organizationtype where typecode = #{organizationStateCode}) then org.organizationname 
		when org.organizationtypeid = (select id from organizationtype where typecode = #{organizationDistrictCode}) then (select statename from organizationtreedetail where districtid=org.id limit 1)
		else (select statename from organizationtreedetail where schoolid=org.id) end as statename,
		case when org.organizationtypeid = (select id from organizationtype where typecode = #{organizationDistrictCode}) then org.organizationname 
		when org.organizationtypeid = (select id from organizationtype where typecode = #{organizationSchoolCode}) then (select districtname from organizationtreedetail where schoolid=org.id )
		else '' end as districtname ,
		case when org.organizationtypeid = (select id from organizationtype where typecode = #{organizationSchoolCode}) then org.organizationname 
		else '' end as schoolname ,
		ua.aartuserid as aartUserId,
		uog.groupid as groupId, uo.organizationid as organizationId,
		ua.assessmentprogramid as assessmentProgramId,
		ua.isdefault as isDefault, ua.activeflag as activeFlag, g.groupname as groupName,
		ap.abbreviatedname as abbreviatedName
	FROM userassessmentprogram ua
		inner join userorganizationsgroups uog on ua.userorganizationsgroupsid = uog.id and ua.activeflag is true and uog.activeflag is true
		inner join usersorganizations uo on uo.id = uog.userorganizationid and uo.activeflag is true
		inner join organization org on org.id=uo.organizationid
		inner join groups g on uog.groupid = g.id and g.activeflag is true
		inner join assessmentprogram ap on ap.id = ua.assessmentprogramid and ap.activeflag is true
	WHERE ua.aartuserid =#{userId, jdbcType=BIGINT}  and ua.activeflag is true) tab
	ORDER BY tab.statename,tab.abbreviatedName,tab.districtname,tab.schoolname,tab.groupName
  </select>
  
  <update id="deactivateAssessmentPrograms" parameterType="UserAssessmentPrograms"  >
  	update userassessmentprogram set activeflag = false,
	modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
	modifieduser = #{modifiedUser,jdbcType=BIGINT}
	where id = #{id, jdbcType=BIGINT} and activeflag is true
  </update>
  
  <!-- no active flag check is required here, getting all user assessmentprograms -->
  <select id="getAllUserAssessmentProgramIds" parameterType="java.lang.Long"  resultType="java.lang.Long">
  	select id from userassessmentprogram where aartuserid = #{userId, jdbcType=BIGINT} and userorganizationsgroupsid is not null
  </select>
  
	<insert id="addUserAssessmentProgram" parameterType="UserAssessmentPrograms" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
	INSERT INTO userassessmentprogram(userorganizationsgroupsid, aartuserid, assessmentprogramid, activeflag, createduser,createddate,
	 modifieduser, modifieddate, isdefault)
    ( 
    Select uog.id as userorganizationsgroupsid,#{aartUserId} as aartUserId,#{assessmentProgramId},true, #{createdUser} as createduser,#{createdDate},
    	#{modifiedUser} as modifieduser,#{modifiedDate}, false
     from userorganizationsgroups uog, usersorganizations uo  where uo.aartuserId = #{aartUserId} and uo.organizationId = #{organizationId} 
     and uog.groupid=#{groupId} and uog.activeflag = true and uog.userorganizationid = uo.id
    );
  </insert>
  
  <update id="updateDefaultUserAssessmentProgram" parameterType="UserAssessmentPrograms">
  		update userassessmentprogram set isdefault = true where id = #{id, jdbcType=BIGINT} and activeflag is true;
  		
  		update userassessmentprogram set isdefault = false where id != #{id, jdbcType=BIGINT} and activeflag is true
  		and aartuserid = #{aartUserId, jdbcType=BIGINT};
  		
  		update userorganizationsgroups set isdefault = false where id in 
		(select distinct userorganizationsgroupsid from userassessmentprogram where 
		id != #{id, jdbcType=BIGINT}
		and aartuserid= #{aartUserId, jdbcType=BIGINT} and userorganizationsgroupsid is not null); 
		
  		update userorganizationsgroups set isdefault = true where id = 
		(select distinct userorganizationsgroupsid from userassessmentprogram where 
		id = #{id, jdbcType=BIGINT}
		and aartuserid= #{aartUserId, jdbcType=BIGINT} and userorganizationsgroupsid is not null);
		
		update usersorganizations set isdefault = false where id in 
		(select distinct uog.userorganizationid from userorganizationsgroups uog, userassessmentprogram uap where 
		uog.id = uap.userorganizationsgroupsid and uap.aartuserid  = #{aartUserId, jdbcType=BIGINT} and uap.isdefault != true
		and uap.userorganizationsgroupsid is not null );
		
		update usersorganizations set isdefault = true where id = 
		(select distinct uog.userorganizationid from userorganizationsgroups uog, userassessmentprogram uap where 
		uog.id = uap.userorganizationsgroupsid and uap.aartuserid  = #{aartUserId, jdbcType=BIGINT} and uap.isdefault = true and uog.isdefault = true
		and uap.userorganizationsgroupsid is not null);
  </update>
  
  <select id="getByUserGroupIdOrgId" resultType="edu.ku.cete.domain.UserAssessmentPrograms">
	select  ua.id as id , ua.aartuserid as aartUserId, uog.groupid as groupId, uo.organizationid as organizationId,
  	ua.assessmentprogramid as assessmentProgramId, ua.isdefault as isDefault, ua.activeflag as activeFlag, g.groupname as groupName,
  	ap.abbreviatedname as abbreviatedName, 
  	ap.id as "assessmentProgram.id", ap.programname as "assessmentProgram.programName", 
  	ap.abbreviatedname as "assessmentProgram.abbreviatedname", ap.activeflag as "assessmentProgram.isDefault"
  	from userassessmentprogram ua
  	inner join userorganizationsgroups uog on ua.userorganizationsgroupsid = uog.id and ua.activeflag is true and uog.activeflag is true
  	inner join usersorganizations uo on uo.id = uog.userorganizationid and uo.activeflag is true
  	inner join groups g on uog.groupid = g.id and g.activeflag is true
  	inner join assessmentprogram ap on ap.id = ua.assessmentprogramid and ap.activeflag is true
  	where ua.aartuserid = #{userId, jdbcType=BIGINT} and uog.groupid = #{groupId, jdbcType=BIGINT} and uo.organizationid = #{organizationId, jdbcType=BIGINT} 
  	and ua.activeflag is true; 
  </select>
  <select id="getByUserGroupIdOrgIds" resultType="edu.ku.cete.domain.UserAssessmentPrograms">
	select  ua.id as id , ua.aartuserid as aartUserId, uog.groupid as groupId, uo.organizationid as organizationId,
  	ua.assessmentprogramid as assessmentProgramId, ua.isdefault as isDefault, ua.activeflag as activeFlag, g.groupname as groupName,
  	ap.abbreviatedname as abbreviatedName, 
  	ap.id as "assessmentProgram.id", ap.programname as "assessmentProgram.programName", 
  	ap.abbreviatedname as "assessmentProgram.abbreviatedname", ap.activeflag as "assessmentProgram.isDefault"
  	from userassessmentprogram ua
  	inner join userorganizationsgroups uog on ua.userorganizationsgroupsid = uog.id and uog.activeflag is true
  	inner join usersorganizations uo on uo.id = uog.userorganizationid and uo.activeflag is true
  	inner join groups g on uog.groupid = g.id and g.activeflag is true
  	inner join assessmentprogram ap on ap.id = ua.assessmentprogramid and ap.activeflag is true
  	where ua.aartuserid = #{userId, jdbcType=BIGINT} and uog.groupid = #{groupId, jdbcType=BIGINT} and uo.organizationid = #{organizationId, jdbcType=BIGINT} 
  </select>
  
</mapper>