<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.ku.cete.model.TestingCycleMapper" >
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.report.TestingCycle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 06 14:22:50 CDT 2017.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="schoolyear" property="schoolYear" jdbcType="BIGINT" />
    <result column="assessmentprogramid" property="assessmentProgramId" jdbcType="BIGINT" />
    <result column="testingprogramid" property="testingProgramId" jdbcType="BIGINT" />
    <result column="testingcyclename" property="testingCycleName" jdbcType="VARCHAR" />
    <result column="sortorder" property="sortOrder" jdbcType="INTEGER" />
    <result column="activeflag" property="activeFlag" jdbcType="BIT" />
    <result column="createduser" property="createdUser" jdbcType="BIGINT" />
    <result column="modifieduser" property="modifiedUser" jdbcType="BIGINT" />
    <result column="createddate" property="createdDate" jdbcType="TIMESTAMP" />
    <result column="modifieddate" property="modifiedDate" jdbcType="TIMESTAMP" />
    <result column="operationaltestwindowid" property="operationalTestWindowId" jdbcType="BIGINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 06 14:22:50 CDT 2017.
    -->
    id, schoolyear, assessmentprogramid, testingprogramid, testingcyclename, sortorder, 
    activeflag, createduser, modifieduser, createddate, modifieddate, operationaltestwindowid
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 06 14:22:50 CDT 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from testingcycle
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.report.TestingCycle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 06 14:22:50 CDT 2017.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('testingcycle_id_seq')
    </selectKey>
    insert into testingcycle (id, schoolyear, assessmentprogramid, 
      testingprogramid, testingcyclename, sortorder, 
      activeflag, createduser, modifieduser, 
      createddate, modifieddate, operationaltestwindowid
      )
    values (#{id,jdbcType=BIGINT}, #{schoolYear,jdbcType=BIGINT}, #{assessmentProgramId,jdbcType=BIGINT}, 
      #{testingProgramId,jdbcType=BIGINT}, #{testingCycleName,jdbcType=VARCHAR}, #{sortOrder,jdbcType=INTEGER}, 
      #{activeFlag,jdbcType=BIT}, #{createdUser,jdbcType=BIGINT}, #{modifiedUser,jdbcType=BIGINT}, 
      #{createdDate,jdbcType=TIMESTAMP}, #{modifiedDate,jdbcType=TIMESTAMP}, #{operationalTestWindowId,jdbcType=BIGINT}
      )
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.report.TestingCycle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 06 14:22:50 CDT 2017.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('testingcycle_id_seq')
    </selectKey>
    insert into testingcycle
    <trim prefix="(" suffix=")" suffixOverrides="," >
      id,
      <if test="schoolYear != null" >
        schoolyear,
      </if>
      <if test="assessmentProgramId != null" >
        assessmentprogramid,
      </if>
      <if test="testingProgramId != null" >
        testingprogramid,
      </if>
      <if test="testingCycleName != null" >
        testingcyclename,
      </if>
      <if test="sortOrder != null" >
        sortorder,
      </if>
      <if test="activeFlag != null" >
        activeflag,
      </if>
      <if test="createdUser != null" >
        createduser,
      </if>
      <if test="modifiedUser != null" >
        modifieduser,
      </if>
      <if test="createdDate != null" >
        createddate,
      </if>
      <if test="modifiedDate != null" >
        modifieddate,
      </if>
      <if test="operationalTestWindowId != null" >
        operationaltestwindowid,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      #{id,jdbcType=BIGINT},
      <if test="schoolYear != null" >
        #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null" >
        #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="testingProgramId != null" >
        #{testingProgramId,jdbcType=BIGINT},
      </if>
      <if test="testingCycleName != null" >
        #{testingCycleName,jdbcType=VARCHAR},
      </if>
      <if test="sortOrder != null" >
        #{sortOrder,jdbcType=INTEGER},
      </if>
      <if test="activeFlag != null" >
        #{activeFlag,jdbcType=BIT},
      </if>
      <if test="createdUser != null" >
        #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedUser != null" >
        #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null" >
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null" >
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="operationalTestWindowId != null" >
        #{operationalTestWindowId,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.report.TestingCycle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 06 14:22:50 CDT 2017.
    -->
    update testingcycle
    <set >
      <if test="schoolYear != null" >
        schoolyear = #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null" >
        assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="testingProgramId != null" >
        testingprogramid = #{testingProgramId,jdbcType=BIGINT},
      </if>
      <if test="testingCycleName != null" >
        testingcyclename = #{testingCycleName,jdbcType=VARCHAR},
      </if>
      <if test="sortOrder != null" >
        sortorder = #{sortOrder,jdbcType=INTEGER},
      </if>
      <if test="activeFlag != null" >
        activeflag = #{activeFlag,jdbcType=BIT},
      </if>
      <if test="createdUser != null" >
        createduser = #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedUser != null" >
        modifieduser = #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null" >
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null" >
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="operationalTestWindowId != null" >
        operationaltestwindowid = #{operationalTestWindowId,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.report.TestingCycle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Sep 06 14:22:50 CDT 2017.
    -->
    update testingcycle
    set schoolyear = #{schoolYear,jdbcType=BIGINT},
      assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      testingprogramid = #{testingProgramId,jdbcType=BIGINT},
      testingcyclename = #{testingCycleName,jdbcType=VARCHAR},
      sortorder = #{sortOrder,jdbcType=INTEGER},
      activeflag = #{activeFlag,jdbcType=BIT},
      createduser = #{createdUser,jdbcType=BIGINT},
      modifieduser = #{modifiedUser,jdbcType=BIGINT},
      createddate = #{createdDate,jdbcType=TIMESTAMP},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      operationaltestwindowid = #{operationalTestWindowId,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="getCurrentTestCycleDetails" resultMap="BaseResultMap">
  		select <include refid="Base_Column_List"/> from testingcycle
  			where assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
  			<if test="testingProgramId != null">
  				and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
  			</if>
  			<if test="schoolYear != null">
  				and schoolyear = #{schoolYear,jdbcType=BIGINT}
  			</if>
  			<if test="testingCycle != null">
  				and testingcyclename = #{testingCycle,jdbcType=VARCHAR}
  			</if>
  			and activeflag is true
  </select>
  
  <select id="getTestingCyclesByProgramIdSchoolYear" resultMap="BaseResultMap" >
     select   tc.id, tc.schoolyear, tc.assessmentprogramid, tc.testingprogramid, tc.testingcyclename, tc.sortorder, 
    tc.activeflag, tc.createduser, tc.modifieduser, tc.createddate, tc.modifieddate, tc.operationaltestwindowid
    from testingcycle tc
    where tc.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
    and tc.schoolyear = #{schoolYear,jdbcType=BIGINT}
    and tc.testingprogramid = #{testingProgramId,jdbcType=BIGINT}
    and tc.activeflag is true
    order by tc.sortorder, tc.testingcyclename
  </select>
  
  <select id="getTestingCyclesByProgramCodeSchoolYear" resultMap="BaseResultMap" >
     select   tc.id, tc.schoolyear, tc.assessmentprogramid, tc.testingprogramid, tc.testingcyclename, tc.sortorder, 
    tc.activeflag, tc.createduser, tc.modifieduser, tc.createddate, tc.modifieddate, tc.operationaltestwindowid
    from testingcycle tc
    where tc.assessmentprogramid = (select id from assessmentprogram  where abbreviatedname = #{assessmentProgramCode,jdbcType=VARCHAR} and activeflag is true)
    and tc.schoolyear = #{schoolYear,jdbcType=BIGINT}
    and tc.testingprogramid = (select id from testingprogram  where programabbr = #{testingProgramCode,jdbcType=VARCHAR} and activeflag is true  
    and assessmentprogramid=(select id from assessmentprogram  where abbreviatedname = #{assessmentProgramCode,jdbcType=VARCHAR} and activeflag is true) )
    and tc.activeflag is true
    order by tc.sortorder
  </select>
  
  <select id="getTestingCyclesByStateIdSchoolYearAssessmentProgram" resultMap="BaseResultMap" >
    SELECT tcy.id, tcy.testingcyclename, tcy.assessmentprogramid, tcy.operationaltestwindowid FROM  testingcycle tcy
	INNER JOIN operationaltestwindowstate ots ON ots.operationaltestwindowid = tcy.operationaltestwindowid AND ots.activeflag=true
	WHERE ots.stateid= #{stateID,jdbcType=BIGINT}	 
	AND ots.activeflag=TRUE
	AND tcy.assessmentprogramid= #{assessmentprogramID,jdbcType=BIGINT}
	AND tcy.schoolyear = #{schoolYear,jdbcType=BIGINT}
	AND tcy.activeflag=true
	ORDER BY tcy.sortorder	
  </select>
  
  
  
  <select id="getTestingCyclesByStateNameSchoolYearAssessmentProgramCode" resultMap="BaseResultMap" >
    SELECT tcy.id, tcy.testingcyclename, tcy.assessmentprogramid, tcy.operationaltestwindowid FROM  testingcycle tcy
	INNER JOIN operationaltestwindowstate ots ON ots.operationaltestwindowid = tcy.operationaltestwindowid AND ots.activeflag=true
	INNER JOIN organization org ON
	 org.id =  ots.stateid AND org.organizationname like #{stateName,jdbcType=VARCHAR} and org.activeflag=true
	INNER JOIN assessmentprogram ap ON
	 ap.id = tcy.assessmentprogramid AND ap.abbreviatedname like #{assessmentprogramCode,jdbcType=VARCHAR} and ap.activeflag is true
	WHERE ots.activeflag=TRUE
	AND tcy.schoolyear = #{schoolYear,jdbcType=BIGINT}
	ORDER BY tcy.sortorder	
  </select>
  
  <select id="getTestingCycleByAssessmentProgramIDSchoolYearOTWID" resultMap="BaseResultMap" >
    SELECT tcy.id, tcy.testingcyclename, tcy.assessmentprogramid, tcy.operationaltestwindowid FROM  testingcycle tcy
	WHERE tcy.operationaltestwindowid = #{otwID,jdbcType=BIGINT}
	AND tcy.assessmentprogramid= #{assessmentprogramID,jdbcType=BIGINT}
	AND tcy.schoolyear = #{schoolYear,jdbcType=BIGINT}
	AND tcy.activeflag = true
	ORDER BY tcy.schoolyear desc, tcy.sortorder	desc limit 1
  </select>
  
</mapper>