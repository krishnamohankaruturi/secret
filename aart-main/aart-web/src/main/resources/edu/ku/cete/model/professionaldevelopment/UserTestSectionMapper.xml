<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.professionaldevelopment.UserTestSectionMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.professionaldevelopment.UserTestSection">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 27 13:50:04 CDT 2014.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="usertestid" jdbcType="BIGINT" property="userTestId" />
    <result column="testsectionid" jdbcType="BIGINT" property="testSectionId" />
    <result column="statusid" jdbcType="BIGINT" property="statusId" />
    <result column="lastnavqnum" jdbcType="INTEGER" property="lastNavQNum" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="activeflag" jdbcType="BIT" property="activeFlag" />
    <result column="startdatetime" jdbcType="TIMESTAMP" property="startDateTime" />
    <result column="enddatetime" jdbcType="TIMESTAMP" property="endDateTime" />
    <result column="scores" jdbcType="VARCHAR" property="scores" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 27 13:50:04 CDT 2014.
    -->
    id, usertestid, testsectionid, statusid, lastnavqnum, createddate, modifieddate, 
    activeflag, startdatetime, enddatetime, scores
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 27 13:50:04 CDT 2014.
    -->
    select 
    <include refid="Base_Column_List" />
    from usertestsection
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.professionaldevelopment.UserTestSection">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 27 13:50:04 CDT 2014.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('usertestsection_id_seq')
    </selectKey>
    insert into usertestsection (id, usertestid, testsectionid, 
      statusid, lastnavqnum, createddate, 
      modifieddate, activeflag, startdatetime, 
      enddatetime, scores)
    values (#{id,jdbcType=BIGINT}, #{userTestId,jdbcType=BIGINT}, #{testSectionId,jdbcType=BIGINT}, 
      #{statusId,jdbcType=BIGINT}, #{lastNavQNum,jdbcType=INTEGER}, #{createdDate,jdbcType=TIMESTAMP}, 
      #{modifiedDate,jdbcType=TIMESTAMP}, #{activeFlag,jdbcType=BIT}, #{startDateTime,jdbcType=TIMESTAMP}, 
      #{endDateTime,jdbcType=TIMESTAMP}, #{scores,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.professionaldevelopment.UserTestSection">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 27 13:50:04 CDT 2014.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('usertestsection_id_seq')
    </selectKey>
    insert into usertestsection
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="userTestId != null">
        usertestid,
      </if>
      <if test="testSectionId != null">
        testsectionid,
      </if>
      <if test="statusId != null">
        statusid,
      </if>
      <if test="lastNavQNum != null">
        lastnavqnum,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
      <if test="activeFlag != null">
        activeflag,
      </if>
      <if test="startDateTime != null">
        startdatetime,
      </if>
      <if test="endDateTime != null">
        enddatetime,
      </if>
      <if test="scores != null">
        scores,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="userTestId != null">
        #{userTestId,jdbcType=BIGINT},
      </if>
      <if test="testSectionId != null">
        #{testSectionId,jdbcType=BIGINT},
      </if>
      <if test="statusId != null">
        #{statusId,jdbcType=BIGINT},
      </if>
      <if test="lastNavQNum != null">
        #{lastNavQNum,jdbcType=INTEGER},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="activeFlag != null">
        #{activeFlag,jdbcType=BIT},
      </if>
      <if test="startDateTime != null">
        #{startDateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endDateTime != null">
        #{endDateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="scores != null">
        #{scores,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.professionaldevelopment.UserTestSection">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 27 13:50:04 CDT 2014.
    -->
    update usertestsection
    <set>
      <if test="userTestId != null">
        usertestid = #{userTestId,jdbcType=BIGINT},
      </if>
      <if test="testSectionId != null">
        testsectionid = #{testSectionId,jdbcType=BIGINT},
      </if>
      <if test="statusId != null">
        statusid = #{statusId,jdbcType=BIGINT},
      </if>
      <if test="lastNavQNum != null">
        lastnavqnum = #{lastNavQNum,jdbcType=INTEGER},
      </if>
      <if test="createdDate != null">
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null">
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="activeFlag != null">
        activeflag = #{activeFlag,jdbcType=BIT},
      </if>
      <if test="startDateTime != null">
        startdatetime = #{startDateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endDateTime != null">
        enddatetime = #{endDateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="scores != null">
        scores = #{scores,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.professionaldevelopment.UserTestSection">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 27 13:50:04 CDT 2014.
    -->
    update usertestsection
    set usertestid = #{userTestId,jdbcType=BIGINT},
      testsectionid = #{testSectionId,jdbcType=BIGINT},
      statusid = #{statusId,jdbcType=BIGINT},
      lastnavqnum = #{lastNavQNum,jdbcType=INTEGER},
      createddate = #{createdDate,jdbcType=TIMESTAMP},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      activeflag = #{activeFlag,jdbcType=BIT},
      startdatetime = #{startDateTime,jdbcType=TIMESTAMP},
      enddatetime = #{endDateTime,jdbcType=TIMESTAMP},
      scores = #{scores,jdbcType=VARCHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <resultMap extends="BaseResultMap" id="DetailedResultMap" type="edu.ku.cete.domain.professionaldevelopment.UserTestSection">
    <result column="statuscode" jdbcType="VARCHAR" property="statusCode" />
    <result column="studentid" jdbcType="BIGINT" property="studentId" />    
	<collection column="userTestSectionId" javaType="ArrayList" 
     ofType="edu.ku.cete.domain.professionaldevelopment.UserTestSectionTask" property="tasks">
        <result column="id" jdbcType="BIGINT" property="userTestSectionId" />
     	<result column="tasksortorder" jdbcType="INTEGER" property="sortOrder" />
     	<result column="taskid" jdbcType="BIGINT" property="taskId" />     	
	     <collection column="taskId" javaType="ArrayList" 
	     	ofType="edu.ku.cete.domain.professionaldevelopment.UserTestSectionTaskFoil" property="foils">
		        <result column="id" jdbcType="BIGINT" property="userTestSectionId" />
		     	<result column="foilsortorder" jdbcType="INTEGER" property="sortOrder" />
		     	<result column="taskid" jdbcType="BIGINT" property="taskId" />
		     	<result column="foilid" jdbcType="BIGINT" property="foilId" />
	    </collection>
    </collection>    
  </resultMap>
  
  
  <select id="getNotCompletedSectionsByUserTestId" parameterType="java.lang.Long" resultMap="DetailedResultMap">
    SELECT usertestsection.id, 
		usertestsection.testsectionid, 
		usertestsection.usertestid, 
		usertest.usermoduleid, 
		usertest.testid, 
		usertest.id, 
		usermodule.userid as studentid,
		usertestsection.statusid, 
		category.categorycode as statuscode, 
		usertestsection.lastnavqnum, 
		usertestsection.modifieddate,
		usertestsectiontask.taskid, 
		usertestsectiontask.sortorder as tasksortorder, 
		usertestsectiontaskfoil.foilid, 
		usertestsectiontaskfoil.sortorder as foilsortorder 
	FROM usertestsection 
		JOIN category ON category.id = usertestsection.statusid 
		JOIN usertest ON usertest.id = usertestsection.usertestid 
		JOIN usermodule ON usermodule.id=usertest.usermoduleid
		LEFT OUTER JOIN usertestsectiontask on usertestsection.id = usertestsectiontask.usertestsectionid 
		LEFT OUTER JOIN usertestsectiontaskfoil on usertestsectiontask.taskid = usertestsectiontaskfoil.taskid 
			AND usertestsectiontask.usertestsectionid = usertestsectiontaskfoil.usertestsectionid 
	WHERE usertestsection.usertestid = #{userTestId,jdbcType=BIGINT}
		AND category.categorycode not ilike 'complete'
	ORDER BY usertest.testid, usertestsection.usertestid,usertestsection.testsectionid
  </select>  
  <update id="updateStatusByUserTestId" parameterType="map">	
	update usertestsection set statusid=#{testSectionStatusId, jdbcType=BIGINT}
    	where usertestid=#{userTestId, jdbcType=BIGINT};    
  </update>  

  <update id="removeUserTestResponsesByUserTestId" parameterType="java.lang.Long">	  
	delete from usertestresponse where usertestsectionid in (
		select id from usertestsection where usertestid=#{userTestId, jdbcType=BIGINT}); 
  </update> 		
</mapper>