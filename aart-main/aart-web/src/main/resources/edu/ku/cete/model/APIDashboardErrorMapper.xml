<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.ku.cete.model.APIDashboardErrorMapper">
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.api.APIDashboardError">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 22 14:42:05 CDT 2018.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="recordtype" jdbcType="VARCHAR" property="recordType" />
    <result column="requesttype" jdbcType="VARCHAR" property="requestType" />
    <result column="externalid" jdbcType="VARCHAR" property="externalID" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="stateid" jdbcType="BIGINT" property="stateID" />
    <result column="districtid" jdbcType="BIGINT" property="districtID" />
    <result column="schoolid" jdbcType="BIGINT" property="schoolID" />
    <result column="classroomid" jdbcType="BIGINT" property="classroomID" />
    <result column="message" jdbcType="VARCHAR" property="message" />
    <result column="createduser" jdbcType="BIGINT" property="createdUser" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="modifieduser" jdbcType="BIGINT" property="modifiedUser" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    </resultMap>
    
     <resultMap id="ApiErrorsMap" type="edu.ku.cete.domain.apierrors.ApiErrorsRecord">
    <result column="recordtype" jdbcType="VARCHAR" property="recordType" />
    <result column="requesttype" jdbcType="VARCHAR" property="requestType" />
    <result column="externalid" jdbcType="VARCHAR" property="externalID" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="stateid" jdbcType="BIGINT" property="stateID" />
    <result column="districtid" jdbcType="BIGINT" property="districtID" />
    <result column="schoolid" jdbcType="BIGINT" property="schoolID" />
    <result column="classroomid" jdbcType="BIGINT" property="classroomID" />
    <result column="message" jdbcType="VARCHAR" property="message" />
    <result column="createduser" jdbcType="BIGINT" property="createdUser" />
    <result column="createddate" jdbcType="TIMESTAMP" property="createdDate" />
    <result column="modifieduser" jdbcType="BIGINT" property="modifiedUser" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="distirctName" jdbcType="VARCHAR" property="districtName"/>
    <result column="schoolName" jdbcType="VARCHAR" property="schoolName"/>
    <result column="stateName" jdbcType="VARCHAR" property="stateName"/>
    
    </resultMap>
    
     <resultMap id="ApiAllErrorsMap" type="edu.ku.cete.domain.apierrors.ApiAllErrorRecords">
    <result column="recordtype" jdbcType="VARCHAR" property="recordType" />
    <result column="requesttype" jdbcType="VARCHAR" property="requestType" />
    <result column="externalid" jdbcType="VARCHAR" property="externalID" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="stateid" jdbcType="BIGINT" property="stateID" />
    <result column="districtid" jdbcType="BIGINT" property="districtID" />
    <result column="schoolid" jdbcType="BIGINT" property="schoolID" />
    <result column="classroomid" jdbcType="BIGINT" property="classroomID" />
    <result column="message" jdbcType="VARCHAR" property="message" />
    <result column="createduser" jdbcType="BIGINT" property="createdUser" />
    <result column="createddate" jdbcType="TIMESTAMP" property="requestDate" />
    <result column="modifieduser" jdbcType="BIGINT" property="modifiedUser" />
    <result column="modifieddate" jdbcType="TIMESTAMP" property="modifiedDate" />
    <result column="distirctName" jdbcType="VARCHAR" property="districtName"/>
    <result column="schoolName" jdbcType="VARCHAR" property="schoolName"/>
    <result column="stateName" jdbcType="VARCHAR" property="stateName"/>
    
    </resultMap>
    
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 22 14:42:05 CDT 2018.
    -->
    id, recordtype, requesttype, externalid, name, stateid, districtid, schoolid, classroomid, 
    message, createduser, createddate, modifieduser, modifieddate
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 22 14:42:05 CDT 2018.
    -->
    select 
    <include refid="Base_Column_List" />
    from apidashboarderror
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.api.APIDashboardError">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 22 14:42:05 CDT 2018.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('apidashboarderror_id_seq')
    </selectKey>
    insert into apidashboarderror (id, recordtype, requesttype, 
      externalid, name, stateid, 
      districtid, schoolid, classroomid, 
      message, createduser, createddate, 
      modifieduser, modifieddate)
    values (#{id,jdbcType=BIGINT}, #{recordType,jdbcType=VARCHAR}, #{requestType,jdbcType=VARCHAR}, 
      #{externalID,jdbcType=VARCHAR}, #{name,jdbcType=VARCHAR}, #{stateID,jdbcType=BIGINT}, 
      #{districtID,jdbcType=BIGINT}, #{schoolID,jdbcType=BIGINT}, #{classroomID,jdbcType=BIGINT}, 
      #{message,jdbcType=VARCHAR}, #{createdUser,jdbcType=BIGINT}, #{createdDate,jdbcType=TIMESTAMP}, 
      #{modifiedUser,jdbcType=BIGINT}, #{modifiedDate,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.api.APIDashboardError">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 22 14:42:05 CDT 2018.
    -->
    <selectKey keyProperty="id" order="BEFORE" resultType="java.lang.Long">
      SELECT nextval('apidashboarderror_id_seq')
    </selectKey>
    insert into apidashboarderror
    <trim prefix="(" suffix=")" suffixOverrides=",">
      id,
      <if test="recordType != null">
        recordtype,
      </if>
      <if test="requestType != null">
        requesttype,
      </if>
      <if test="externalID != null">
        externalid,
      </if>
      <if test="name != null">
        name,
      </if>
      <if test="stateID != null">
        stateid,
      </if>
      <if test="districtID != null">
        districtid,
      </if>
      <if test="schoolID != null">
        schoolid,
      </if>
      <if test="classroomID != null">
        classroomid,
      </if>
      <if test="message != null">
        message,
      </if>
      <if test="createdUser != null">
        createduser,
      </if>
      <if test="createdDate != null">
        createddate,
      </if>
      <if test="modifiedUser != null">
        modifieduser,
      </if>
      <if test="modifiedDate != null">
        modifieddate,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{id,jdbcType=BIGINT},
      <if test="recordType != null">
        #{recordType,jdbcType=VARCHAR},
      </if>
      <if test="requestType != null">
        #{requestType,jdbcType=VARCHAR},
      </if>
      <if test="externalID != null">
        #{externalID,jdbcType=VARCHAR},
      </if>
      <if test="name != null">
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="stateID != null">
        #{stateID,jdbcType=BIGINT},
      </if>
      <if test="districtID != null">
        #{districtID,jdbcType=BIGINT},
      </if>
      <if test="schoolID != null">
        #{schoolID,jdbcType=BIGINT},
      </if>
      <if test="classroomID != null">
        #{classroomID,jdbcType=BIGINT},
      </if>
      <if test="message != null">
        #{message,jdbcType=VARCHAR},
      </if>
      <if test="createdUser != null">
        #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedUser != null">
        #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedDate != null">
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.api.APIDashboardError">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 22 14:42:05 CDT 2018.
    -->
    update apidashboarderror
    <set>
      <if test="recordType != null">
        recordtype = #{recordType,jdbcType=VARCHAR},
      </if>
      <if test="requestType != null">
        requesttype = #{requestType,jdbcType=VARCHAR},
      </if>
      <if test="externalID != null">
        externalid = #{externalID,jdbcType=VARCHAR},
      </if>
      <if test="name != null">
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="stateID != null">
        stateid = #{stateID,jdbcType=BIGINT},
      </if>
      <if test="districtID != null">
        districtid = #{districtID,jdbcType=BIGINT},
      </if>
      <if test="schoolID != null">
        schoolid = #{schoolID,jdbcType=BIGINT},
      </if>
      <if test="classroomID != null">
        classroomid = #{classroomID,jdbcType=BIGINT},
      </if>
      <if test="message != null">
        message = #{message,jdbcType=VARCHAR},
      </if>
      <if test="createdUser != null">
        createduser = #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null">
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedUser != null">
        modifieduser = #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedDate != null">
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.api.APIDashboardError">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 22 14:42:05 CDT 2018.
    -->
    update apidashboarderror
    set recordtype = #{recordType,jdbcType=VARCHAR},
      requesttype = #{requestType,jdbcType=VARCHAR},
      externalid = #{externalID,jdbcType=VARCHAR},
      name = #{name,jdbcType=VARCHAR},
      stateid = #{stateID,jdbcType=BIGINT},
      districtid = #{districtID,jdbcType=BIGINT},
      schoolid = #{schoolID,jdbcType=BIGINT},
      classroomid = #{classroomID,jdbcType=BIGINT},
      message = #{message,jdbcType=VARCHAR},
      createduser = #{createdUser,jdbcType=BIGINT},
      createddate = #{createdDate,jdbcType=TIMESTAMP},
      modifieduser = #{modifiedUser,jdbcType=BIGINT},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>
 	
 	<!-- Queries for API Error Dashboard -->
 
  <sql id="findApiErrorsToView">
  	
  	SELECT  
  			api.id,
  			api.createddate, 
  			api.recordtype, 
  			api.message, 
  			api.requesttype, 
  			api.name, 
  			api.classroomid, 
  			distOrg.organizationname as districtname,
			schOrg.organizationname as schoolname, 
			stateOrg.organizationname as statename 
	FROM  apidashboarderror api
	<if test="districtId == null">
		LEFT 
	</if>
	JOIN organization distOrg ON api.districtid = distOrg.id AND distOrg.activeflag is true
	<if test="districtId != null">
		AND distOrg.id = #{districtId,jdbcType=BIGINT}
	</if>
	AND distOrg.organizationtypeid = (SELECT id FROM organizationtype WHERE typecode='DT' AND activeflag is true)
	<if test="schoolId == null">
		LEFT 
	</if>
	JOIN organization schOrg ON schOrg.id = api.schoolid  AND schOrg.organizationtypeid = (SELECT id FROM organizationtype WHERE typecode='SCH' AND activeflag is true)
	<if test="schoolId != null">
		AND schOrg.id = #{schoolId,jdbcType=BIGINT}
	</if>
	join organization stateOrg on stateOrg.id = api.stateid
	where stateOrg.activeflag is true
	and api.stateid is not null
	and stateOrg.id = #{stateId,jdbcType=BIGINT} and stateOrg.organizationtypeid = (select id from organizationtype where typecode='ST' and activeflag is true)	
	<if test="viewOrphanedRecordsFlag == 1">
	UNION
	SELECT  
		 api.id,
		 api.createddate,
		 api.recordtype, 
		 api.message, 
		 api.requesttype, 
		 api.name, 
		 api.classroomid, 
		 distOrg.organizationname as districtname,
		 schOrg.organizationname as schoolname, 
		null as statename 
	FROM  apidashboarderror api
	left join organization distOrg on api.districtid = distOrg.id and distOrg.organizationtypeid = (select id from organizationtype where typecode='DT' and activeflag is true)
	left join organization schOrg on schOrg.id = api.schoolid  and schOrg.organizationtypeid = (select id from organizationtype where typecode='SCH' and activeflag is true)
	where api.stateid is null
	</if>
  </sql>
  
  <sql id="findApiErrorsToViewWhere">
  
  	WHERE 1=1
  	<if test="id !=null">AND (api.id) like ('%' || #{id} || '%')</if>
  	<if test="requestDate !=null">AND (api.createddate) like ('%' || #{requestDate} || '%')</if>
  	<if test="recordType != null">AND upper(api.recordtype) like upper('%' || #{recordType} || '%')</if>
  	<if test="errorMessage != null">AND upper(api.message) like upper('%' || #{errorMessage} || '%')</if>
  	<if test="requestType != null">AND upper(api.requesttype) like upper('%' || #{requestType} || '%')</if>  
  	<if test="name != null">AND upper(api.name) like upper('%' || #{name} || '%')</if>	
  	<if test="classroomId != null">AND (api.classroomid::text) like ('%' || #{classroomId} || '%')</if>
  	<if test="districtName != null">AND upper(api.districtname) like upper('%' || #{districtName} || '%')</if>
  	<if test="schoolName != null">AND upper(api.schoolname) like upper('%' || #{schoolName} || '%')</if>
  	<if test="stateName != null">AND upper(api.statename) like upper('%' || #{stateName} || '%')</if>
  	
  </sql>
  
   <select id="getApiErrorsToView"  resultMap="ApiErrorsMap" parameterType="hashmap" useCache="false">  	
  	/*NO LOAD BALANCE*/
		SELECT * FROM  (<include refid="findApiErrorsToView"/>) AS api
		<include refid="findApiErrorsToViewWhere"/> 
		<if test="sortByColumn != null">
    	ORDER BY 
    		<choose>
    			<when test="sortByColumn == 'id'">api.id</when>
	      		<when test="sortByColumn == 'requestDate'">api.createddate</when>
	  			<when test="sortByColumn == 'recordType'" >api.recordtype</when>
	  			<when test ="sortByColumn == 'errorMessage'">api.message</when>
	      		<when test="sortByColumn == 'requestType'">api.requesttype</when>
	      		<when test="sortByColumn == 'name'">api.name</when>
	      		<when test="sortByColumn == 'classroomId'">api.classroomid</when>
	      		<when test="sortByColumn == 'districtName'">api.districtname</when>
	      		<when test="sortByColumn == 'schoolName'">api.schoolname</when>
	      		<when test="sortByColumn == 'stateName'">api.statename</when>
	      	</choose>
	      	<if test="sortType=='desc'">
    			desc
   	 		</if>
   	 		<if test="sortType=='asc' or sortType==null">
   	 			asc
   	 		</if>
		</if>
		
    	LIMIT #{limit}
    	OFFSET #{offset}
  </select>
  
   <select id="getCountOfApiErrorsToView" resultType="java.lang.Integer" parameterType="hashmap"  useCache="false">
		/*NO LOAD BALANCE*/
   		SELECT count(1) FROM  (<include refid="findApiErrorsToView"/>) AS api
			<include refid="findApiErrorsToViewWhere"/> 
  </select>
  
  <select id="getErrorRecordTypes" resultType="java.lang.String">
  
   SELECT DISTINCT api.recordtype FROM apidashboarderror AS api
  </select>
  
  
  <select id="getApiErrorsRequestTypes" resultType="java.lang.String">
  	
  	SELECT DISTINCT api.requesttype FROM  apidashboarderror AS api
 </select>
  
  <select id="getAllApiErrorMessages" resultMap="ApiAllErrorsMap" parameterType="hashmap" useCache="false">
  	SELECT * FROM  (<include refid="findApiErrorsToView"/>) AS api
		
  </select>
  
  <select id="getApiErrorMessages" resultMap="ApiErrorsMap" parameterType="hashmap" useCache="false">
  
  	SELECT * FROM  (<include refid="findApiErrorsToView"/>) AS api
  </select>
  
  
</mapper>