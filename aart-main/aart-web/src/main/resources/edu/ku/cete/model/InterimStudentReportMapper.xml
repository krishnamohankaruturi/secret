<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.ku.cete.model.InterimStudentReportMapper" >
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.report.InterimStudentReport" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Sep 05 12:07:58 CDT 2017.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="studentid" property="studentId" jdbcType="BIGINT" />
    <result column="legalfirstname" property="studentFirstName" jdbcType="VARCHAR" />
    <result column="legalmiddlename" property="studentMiddleName" jdbcType="VARCHAR" />
    <result column="legallastname" property="studentLastName" jdbcType="VARCHAR" />
    <result column="statestudentidentifier" property="stateStudentId" jdbcType="VARCHAR" />
    <result column="enrollmentid" property="enrollmentId" jdbcType="BIGINT" />
    <result column="studentreportreprocessid" property="studentReportReprocessId" jdbcType="BIGINT" />
    <result column="gradeid" property="gradeId" jdbcType="BIGINT" />
    <result column="abbreviatedname" property="gradeCode" jdbcType="VARCHAR" />
    <result column="contentareaid" property="contentAreaId" jdbcType="BIGINT" />
    <result column="name" property="subjectName" jdbcType="VARCHAR" />
    <result column="contentareacode" property="contentAreaCode" jdbcType="VARCHAR" />
    <result column="attendanceschoolid" property="attendanceSchoolId" jdbcType="BIGINT" />
    <result column="schoolname" property="schoolName" jdbcType="VARCHAR" />
    <result column="schooldisplayidentifier" property="schoolDisplayId" jdbcType="VARCHAR" />
    <result column="districtid" property="districtId" jdbcType="BIGINT" />
    <result column="districtname" property="districtName" jdbcType="VARCHAR" />
    <result column="districtdisplayidentifier" property="districtDisplayId" jdbcType="VARCHAR" />
    <result column="stateid" property="stateId" jdbcType="BIGINT" />
    <result column="schoolyear" property="schoolYear" jdbcType="BIGINT" />
    <result column="assessmentprogramid" property="assessmentProgramId" jdbcType="BIGINT" />
    <result column="testingprogramid" property="testingProgramId" jdbcType="BIGINT" />
    <result column="reportcycle" property="reportCycle" jdbcType="VARCHAR" />
    <result column="testid" property="testId" jdbcType="BIGINT" />
    <result column="externaltestid" property="externalTestId" jdbcType="BIGINT" />
    <result column="rawscore" property="rawScore" jdbcType="NUMERIC" />
    <result column="scalescore" property="scaleScore" jdbcType="BIGINT" />
    <result column="standarderror" property="standardError" jdbcType="NUMERIC" />
    <result column="status" property="status" jdbcType="BIT" />
    <result column="scorerangedisplayreasonid" property="scoreRangeDisplayReasonId" jdbcType="BIGINT" />
    <result column="reasonCode" property="reasonCode" jdbcType="VARCHAR" />
    <result column="exitstatus" property="exitStatus" jdbcType="BIT" />
    <result column="transferred" property="transferred" jdbcType="BIT" />
    <result column="totalincludeditemcount" property="totalIncludedItemCount" jdbcType="INTEGER" />
    <result column="respondeditemcount" property="respondedItemCount" jdbcType="INTEGER" />
    <result column="excludeditemcount" property="excludedItemCount" jdbcType="INTEGER" />
    <result column="filepath" property="filePath" jdbcType="VARCHAR" />
    <result column="generated" property="generated" jdbcType="BIT" />
    <result column="batchreportprocessid" property="batchReportProcessId" jdbcType="BIGINT" />
    <result column="operationaltestwindowid" property="operationalTestWindowId" jdbcType="BIGINT" />
    <result column="createddate" property="createdDate" jdbcType="TIMESTAMP" />
    <result column="modifieddate" property="modifiedDate" jdbcType="TIMESTAMP" />
    <result column="createduser" property="createdUser" jdbcType="BIGINT" />
    <result column="modifieduser" property="modifiedUser" jdbcType="BIGINT" />
  </resultMap>
  
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Sep 05 12:07:58 CDT 2017.
    -->
    id, studentid, enrollmentid, gradeid, contentareaid, attendanceschoolid, schoolname, 
    districtid, districtname, stateid, schoolyear, assessmentprogramid, testingprogramid, 
    reportcycle, testid, externaltestid, rawscore, scalescore, standarderror, status, 
    scorerangedisplayreasonid, exitstatus, transferred, totalincludeditemcount, respondeditemcount, 
    excludeditemcount, filepath, generated, batchreportprocessid, operationaltestwindowid, 
    createddate, modifieddate, createduser, modifieduser
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Sep 05 12:07:58 CDT 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from interimstudentreport
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.report.InterimStudentReport" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Sep 05 12:07:58 CDT 2017.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('interimstudentreport_id_seq')
    </selectKey>
    insert into interimstudentreport (id, studentid, enrollmentid, 
      gradeid, contentareaid, attendanceschoolid, 
      schoolname, districtid, districtname, 
      stateid, schoolyear, assessmentprogramid, 
      testingprogramid, reportcycle, testid, 
      externaltestid, rawscore, scalescore, 
      standarderror, status, scorerangedisplayreasonid, 
      exitstatus, transferred, totalincludeditemcount, 
      respondeditemcount, excludeditemcount, 
      filepath, generated, batchreportprocessid, 
      operationaltestwindowid, createddate, 
      modifieddate, createduser, modifieduser
      )
    values (#{id,jdbcType=BIGINT}, #{studentId,jdbcType=BIGINT}, #{enrollmentId,jdbcType=BIGINT}, 
      #{gradeId,jdbcType=BIGINT}, #{contentAreaId,jdbcType=BIGINT}, #{attendanceSchoolId,jdbcType=BIGINT}, 
      #{schoolName,jdbcType=VARCHAR}, #{districtId,jdbcType=BIGINT}, #{districtName,jdbcType=VARCHAR}, 
      #{stateId,jdbcType=BIGINT}, #{schoolYear,jdbcType=BIGINT}, #{assessmentProgramId,jdbcType=BIGINT}, 
      #{testingProgramId,jdbcType=BIGINT}, #{reportCycle,jdbcType=VARCHAR}, #{testId,jdbcType=BIGINT}, 
      #{externalTestId,jdbcType=BIGINT}, #{rawScore,jdbcType=NUMERIC}, #{scaleScore,jdbcType=BIGINT}, 
      #{standardError,jdbcType=NUMERIC}, #{status,jdbcType=BIT}, #{scoreRangeDisplayReasonId,jdbcType=BIGINT}, 
      #{exitStatus,jdbcType=BIT}, #{transferred,jdbcType=BIT}, #{totalIncludedItemCount,jdbcType=INTEGER}, 
      #{respondedItemCount,jdbcType=INTEGER}, #{excludedItemCount,jdbcType=INTEGER}, 
      #{filePath,jdbcType=VARCHAR}, #{generated,jdbcType=BIT}, #{batchReportProcessId,jdbcType=BIGINT}, 
      #{operationalTestWindowId,jdbcType=BIGINT}, #{createdDate,jdbcType=TIMESTAMP}, 
      #{modifiedDate,jdbcType=TIMESTAMP}, #{createdUser,jdbcType=BIGINT}, #{modifiedUser,jdbcType=BIGINT}
      )
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.report.InterimStudentReport" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Sep 05 12:07:58 CDT 2017.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('interimstudentreport_id_seq')
    </selectKey>
    insert into interimstudentreport
    <trim prefix="(" suffix=")" suffixOverrides="," >
      id,
      <if test="studentId != null" >
        studentid,
      </if>
      <if test="enrollmentId != null" >
        enrollmentid,
      </if>
      <if test="gradeId != null" >
        gradeid,
      </if>
      <if test="contentAreaId != null" >
        contentareaid,
      </if>
      <if test="attendanceSchoolId != null" >
        attendanceschoolid,
      </if>
      <if test="schoolName != null" >
        schoolname,
      </if>
      <if test="districtId != null" >
        districtid,
      </if>
      <if test="districtName != null" >
        districtname,
      </if>
      <if test="stateId != null" >
        stateid,
      </if>
      <if test="schoolYear != null" >
        schoolyear,
      </if>
      <if test="assessmentProgramId != null" >
        assessmentprogramid,
      </if>
      <if test="testingProgramId != null" >
        testingprogramid,
      </if>
      <if test="reportCycle != null" >
        reportcycle,
      </if>
      <if test="testId != null" >
        testid,
      </if>
      <if test="externalTestId != null" >
        externaltestid,
      </if>
      <if test="rawScore != null" >
        rawscore,
      </if>
      <if test="scaleScore != null" >
        scalescore,
      </if>
      <if test="standardError != null" >
        standarderror,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="scoreRangeDisplayReasonId != null" >
        scorerangedisplayreasonid,
      </if>
      <if test="exitStatus != null" >
        exitstatus,
      </if>
      <if test="transferred != null" >
        transferred,
      </if>
      <if test="totalIncludedItemCount != null" >
        totalincludeditemcount,
      </if>
      <if test="respondedItemCount != null" >
        respondeditemcount,
      </if>
      <if test="excludedItemCount != null" >
        excludeditemcount,
      </if>
      <if test="filePath != null" >
        filepath,
      </if>
      <if test="generated != null" >
        generated,
      </if>
      <if test="batchReportProcessId != null" >
        batchreportprocessid,
      </if>
      <if test="operationalTestWindowId != null" >
        operationaltestwindowid,
      </if>
      <if test="createdDate != null" >
        createddate,
      </if>
      <if test="modifiedDate != null" >
        modifieddate,
      </if>
      <if test="createdUser != null" >
        createduser,
      </if>
      <if test="modifiedUser != null" >
        modifieduser,
      </if>
      <if test="studentsTestStatus != null" >
        studentsteststatus,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      #{id,jdbcType=BIGINT},
      <if test="studentId != null" >
        #{studentId,jdbcType=BIGINT},
      </if>
      <if test="enrollmentId != null" >
        #{enrollmentId,jdbcType=BIGINT},
      </if>
      <if test="gradeId != null" >
        #{gradeId,jdbcType=BIGINT},
      </if>
      <if test="contentAreaId != null" >
        #{contentAreaId,jdbcType=BIGINT},
      </if>
      <if test="attendanceSchoolId != null" >
        #{attendanceSchoolId,jdbcType=BIGINT},
      </if>
      <if test="schoolName != null" >
        #{schoolName,jdbcType=VARCHAR},
      </if>
      <if test="districtId != null" >
        #{districtId,jdbcType=BIGINT},
      </if>
      <if test="districtName != null" >
        #{districtName,jdbcType=VARCHAR},
      </if>
      <if test="stateId != null" >
        #{stateId,jdbcType=BIGINT},
      </if>
      <if test="schoolYear != null" >
        #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null" >
        #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="testingProgramId != null" >
        #{testingProgramId,jdbcType=BIGINT},
      </if>
      <if test="reportCycle != null" >
        #{reportCycle,jdbcType=VARCHAR},
      </if>
      <if test="testId != null" >
        #{testId,jdbcType=BIGINT},
      </if>
      <if test="externalTestId != null" >
        #{externalTestId,jdbcType=BIGINT},
      </if>
      <if test="rawScore != null" >
        #{rawScore,jdbcType=NUMERIC},
      </if>
      <if test="scaleScore != null" >
        #{scaleScore,jdbcType=BIGINT},
      </if>
      <if test="standardError != null" >
        #{standardError,jdbcType=NUMERIC},
      </if>
      <if test="status != null" >
        #{status,jdbcType=BIT},
      </if>
      <if test="scoreRangeDisplayReasonId != null" >
        #{scoreRangeDisplayReasonId,jdbcType=BIGINT},
      </if>
      <if test="exitStatus != null" >
        #{exitStatus,jdbcType=BIT},
      </if>
      <if test="transferred != null" >
        #{transferred,jdbcType=BIT},
      </if>
      <if test="totalIncludedItemCount != null" >
        #{totalIncludedItemCount,jdbcType=INTEGER},
      </if>
      <if test="respondedItemCount != null" >
        #{respondedItemCount,jdbcType=INTEGER},
      </if>
      <if test="excludedItemCount != null" >
        #{excludedItemCount,jdbcType=INTEGER},
      </if>
      <if test="filePath != null" >
        #{filePath,jdbcType=VARCHAR},
      </if>
      <if test="generated != null" >
        #{generated,jdbcType=BIT},
      </if>
      <if test="batchReportProcessId != null" >
        #{batchReportProcessId,jdbcType=BIGINT},
      </if>
      <if test="operationalTestWindowId != null" >
        #{operationalTestWindowId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null" >
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null" >
        #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createdUser != null" >
        #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedUser != null" >
        #{modifiedUser,jdbcType=BIGINT},
      </if>
      <if test="studentsTestStatus != null" >
        #{studentsTestStatus,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.report.InterimStudentReport" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Sep 05 12:07:58 CDT 2017.
    -->
    update interimstudentreport
    <set >
      <if test="studentId != null" >
        studentid = #{studentId,jdbcType=BIGINT},
      </if>
      <if test="enrollmentId != null" >
        enrollmentid = #{enrollmentId,jdbcType=BIGINT},
      </if>
      <if test="gradeId != null" >
        gradeid = #{gradeId,jdbcType=BIGINT},
      </if>
      <if test="contentAreaId != null" >
        contentareaid = #{contentAreaId,jdbcType=BIGINT},
      </if>
      <if test="attendanceSchoolId != null" >
        attendanceschoolid = #{attendanceSchoolId,jdbcType=BIGINT},
      </if>
      <if test="schoolName != null" >
        schoolname = #{schoolName,jdbcType=VARCHAR},
      </if>
      <if test="districtId != null" >
        districtid = #{districtId,jdbcType=BIGINT},
      </if>
      <if test="districtName != null" >
        districtname = #{districtName,jdbcType=VARCHAR},
      </if>
      <if test="stateId != null" >
        stateid = #{stateId,jdbcType=BIGINT},
      </if>
      <if test="schoolYear != null" >
        schoolyear = #{schoolYear,jdbcType=BIGINT},
      </if>
      <if test="assessmentProgramId != null" >
        assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      </if>
      <if test="testingProgramId != null" >
        testingprogramid = #{testingProgramId,jdbcType=BIGINT},
      </if>
      <if test="reportCycle != null" >
        reportcycle = #{reportCycle,jdbcType=VARCHAR},
      </if>
      <if test="testId != null" >
        testid = #{testId,jdbcType=BIGINT},
      </if>
      <if test="externalTestId != null" >
        externaltestid = #{externalTestId,jdbcType=BIGINT},
      </if>
      <if test="rawScore != null" >
        rawscore = #{rawScore,jdbcType=NUMERIC},
      </if>
      <if test="scaleScore != null" >
        scalescore = #{scaleScore,jdbcType=BIGINT},
      </if>
      <if test="standardError != null" >
        standarderror = #{standardError,jdbcType=NUMERIC},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=BIT},
      </if>
      <if test="scoreRangeDisplayReasonId != null" >
        scorerangedisplayreasonid = #{scoreRangeDisplayReasonId,jdbcType=BIGINT},
      </if>
      <if test="exitStatus != null" >
        exitstatus = #{exitStatus,jdbcType=BIT},
      </if>
      <if test="transferred != null" >
        transferred = #{transferred,jdbcType=BIT},
      </if>
      <if test="totalIncludedItemCount != null" >
        totalincludeditemcount = #{totalIncludedItemCount,jdbcType=INTEGER},
      </if>
      <if test="respondedItemCount != null" >
        respondeditemcount = #{respondedItemCount,jdbcType=INTEGER},
      </if>
      <if test="excludedItemCount != null" >
        excludeditemcount = #{excludedItemCount,jdbcType=INTEGER},
      </if>
      <if test="filePath != null" >
        filepath = #{filePath,jdbcType=VARCHAR},
      </if>
      <if test="generated != null" >
        generated = #{generated,jdbcType=BIT},
      </if>
      <if test="batchReportProcessId != null" >
        batchreportprocessid = #{batchReportProcessId,jdbcType=BIGINT},
      </if>
      <if test="operationalTestWindowId != null" >
        operationaltestwindowid = #{operationalTestWindowId,jdbcType=BIGINT},
      </if>
      <if test="createdDate != null" >
        createddate = #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifiedDate != null" >
        modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createdUser != null" >
        createduser = #{createdUser,jdbcType=BIGINT},
      </if>
      <if test="modifiedUser != null" >
        modifieduser = #{modifiedUser,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.report.InterimStudentReport" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Sep 05 12:07:58 CDT 2017.
    -->
    update interimstudentreport
    set studentid = #{studentId,jdbcType=BIGINT},
      enrollmentid = #{enrollmentId,jdbcType=BIGINT},
      gradeid = #{gradeId,jdbcType=BIGINT},
      contentareaid = #{contentAreaId,jdbcType=BIGINT},
      attendanceschoolid = #{attendanceSchoolId,jdbcType=BIGINT},
      schoolname = #{schoolName,jdbcType=VARCHAR},
      districtid = #{districtId,jdbcType=BIGINT},
      districtname = #{districtName,jdbcType=VARCHAR},
      stateid = #{stateId,jdbcType=BIGINT},
      schoolyear = #{schoolYear,jdbcType=BIGINT},
      assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT},
      testingprogramid = #{testingProgramId,jdbcType=BIGINT},
      reportcycle = #{reportCycle,jdbcType=VARCHAR},
      testid = #{testId,jdbcType=BIGINT},
      externaltestid = #{externalTestId,jdbcType=BIGINT},
      rawscore = #{rawScore,jdbcType=NUMERIC},
      scalescore = #{scaleScore,jdbcType=BIGINT},
      standarderror = #{standardError,jdbcType=NUMERIC},
      status = #{status,jdbcType=BIT},
      scorerangedisplayreasonid = #{scoreRangeDisplayReasonId,jdbcType=BIGINT},
      exitstatus = #{exitStatus,jdbcType=BIT},
      transferred = #{transferred,jdbcType=BIT},
      totalincludeditemcount = #{totalIncludedItemCount,jdbcType=INTEGER},
      respondeditemcount = #{respondedItemCount,jdbcType=INTEGER},
      excludeditemcount = #{excludedItemCount,jdbcType=INTEGER},
      filepath = #{filePath,jdbcType=VARCHAR},
      generated = #{generated,jdbcType=BIT},
      batchreportprocessid = #{batchReportProcessId,jdbcType=BIGINT},
      operationaltestwindowid = #{operationalTestWindowId,jdbcType=BIGINT},
      createddate = #{createdDate,jdbcType=TIMESTAMP},
      modifieddate = #{modifiedDate,jdbcType=TIMESTAMP},
      createduser = #{createdUser,jdbcType=BIGINT},
      modifieduser = #{modifiedUser,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="selectAllInterimStudentReports" resultMap="BaseResultMap">
    select * from interimstudentreport
    where assessmentprogramid = #{assessmentProgramId}
 	<if test="gradeId != null">
         and gradeid = #{gradeId, jdbcType=BIGINT}
    </if>  
    <if test="contentAreaId != null">
         and contentareaid = #{contentAreaId, jdbcType=BIGINT}
    </if>  
     <if test="studentId != null">
         and studentid = #{studentId, jdbcType=BIGINT}
    </if>  
    <if test="schoolYear != null">
         and schoolyear = #{schoolYear, jdbcType=BIGINT}
    </if>
    <if test="reportCycle != null">
     	 and reportcycle = #{reportCycle,jdbcType=VARCHAR}
    </if>
  </select>
  
  <delete id="deleteInterimStudentReports">
    delete from interimstudentreport where assessmentprogramid =  #{assessmentProgramId,jdbcType=BIGINT}
     <if test="reportCycle != null">
     	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
     </if>
     <if test="contentAreaId != null">
        and contentareaid = #{contentAreaId,jdbcType=BIGINT}
      </if>
     <if test="gradeId != null">
         and gradeid = #{gradeId,jdbcType=BIGINT}
      </if>
        <if test="studentId != null">
      	and studentid = #{studentId,jdbcType=BIGINT}
      </if>
      <if test="schoolYear != null">
      	and schoolyear = #{schoolYear,jdbcType=BIGINT}
      </if>
   </delete>
   
   <select id="getContentAreaIdsFromInterimStudentReport" resultType="Long">
    select distinct contentareaid 
    from interimstudentreport 
    where schoolyear = #{schoolYear,jdbcType=BIGINT}
    and assessmentprogramid = #{assessmentProgramId}
    and reportcycle  = #{reportCycle}
    and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
    <!-- and generated is false --> 
    order by contentareaid
  </select>

 <select id="getGradeIdsFromInterimStudentReport" resultType="Long">
    select distinct gradeid 
    from interimstudentreport 
    where schoolyear = #{schoolYear,jdbcType=BIGINT}
    and assessmentprogramid = #{assessmentProgramId}
    and contentareaid = #{contentAreaId,jdbcType=BIGINT}
    and reportcycle  = #{reportCycle,jdbcType=BIGINT}
    and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
    <!-- and generated is false --> 
    order by gradeid
  </select>
  
   <select id="getInterimStudentIdsForReportGeneration" resultType="Long">
    select distinct isr.studentid
    from interimstudentreport isr
     <if test="processByStudentId == 'TRUE' and reprocessEntireDistrict=='FALSE'">		
		inner  join studentreportreprocess rp on rp.studentId=isr.studentid  
		and rp.isrcomplete is false
	    and rp.contentareaid = #{contentAreaId,jdbcType=BIGINT}
	    and rp.gradeid = #{gradeId,jdbcType=BIGINT}  
		and rp.generatespecificstudentreport is true 
		and rp.testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	</if> 
	<if test="processByStudentId == 'TRUE' and reprocessEntireDistrict=='TRUE'">
		inner  join studentreportreprocess rp on rp.districtid = isr.districtid  
		and isrcomplete is false  
		and rp.contentareaid = #{contentAreaId,jdbcType=BIGINT}
	    and rp.gradeid = #{gradeId,jdbcType=BIGINT}
		and rp.generatereportsindistrict is true
		and rp.testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	</if>
    where isr.schoolyear = #{schoolYear,jdbcType=BIGINT}
    and isr.assessmentprogramid = #{assessmentProgramId}
    and isr.contentareaid = #{contentAreaId,jdbcType=BIGINT}
    and isr.gradeid = #{gradeId,jdbcType=BIGINT}
    and isr.reportcycle  = #{reportCycle,jdbcType=BIGINT}
    and isr.testingprogramid = #{testingProgramId,jdbcType=BIGINT}
    and (isr.scorerangedisplayreasonid is null OR isr.scorerangedisplayreasonid not in (select id from category where categorycode = 'STUDENT_NOT_TESTED'))
     <if test="processByStudentId == null or (processByStudentId != null and processByStudentId == 'FALSE')">
         and generated is false
     </if>
    order by studentid
    LIMIT #{pageSize}
    OFFSET #{offset}
  </select>  
  
   <select id="getInterimStudentsForReportGeneration" resultMap="BaseResultMap">    
	select isr.*,s.legalfirstname, s.legallastname, s.legalmiddlename,s.statestudentidentifier,gc.abbreviatedname, 
	 ca.name,ca.abbreviatedname as contentareacode, 
	 otd.districtdisplayidentifier, 
	 otd.schooldisplayidentifier,
	 reason.categoryname as reasonCode
	 from interimstudentreport isr
	 inner join student s on s.id = isr.studentid and s.activeflag is true
	 inner join contentarea ca on ca.id = isr.contentareaid and ca.activeflag is true
	 inner join gradecourse gc on gc.id  = isr.gradeid and gc.activeflag is true
	 inner join organizationtreedetail otd on otd.schoolid = isr.attendanceschoolid
	 left join category reason on reason.id = isr.scorerangedisplayreasonid and reason.activeflag is true
	    where isr.schoolyear = #{schoolYear,jdbcType=BIGINT}
	    and  isr.assessmentprogramid = #{assessmentProgramId}
	    and isr.contentareaid = #{contentAreaId,jdbcType=BIGINT}
	    and isr.studentid = #{studentId,jdbcType=BIGINT}
	    and isr.gradeid = #{gradeId,jdbcType=BIGINT}
	    and isr.testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	    order by isr.id
  </select>
  
  <update id="updateInterimStudentReportFilePath" parameterType="edu.ku.cete.domain.report.InterimStudentReport" >
    update interimstudentreport 
    set  
    filepath = #{filePath,jdbcType=VARCHAR}, 
    generated = true,
    modifieduser = #{modifiedUser,jdbcType=BIGINT}, 
    modifieddate = now() 
    where id = #{id,jdbcType=BIGINT}
  </update>
  
   <select id="getInterimStudentReportPathByTestsession" resultType="String">
    <if test="isTeacher == true">  
		with rostered_students as (
			select distinct e.studentid
			from roster r
			join enrollmentsrosters er on r.id = er.rosterid and er.activeflag
			join enrollment e on er.enrollmentid = e.id and r.currentschoolyear =
			e.currentschoolyear and e.activeflag
			where r.teacherid = #{userId,jdbcType=BIGINT}		
			and r.currentschoolyear = #{currentSchoolYear,jdbcType=BIGINT}		
			and e.attendanceschoolid = #{organizationId,jdbcType=BIGINT}			
			)
   </if>
    select isr.filepath from testsession ts
    inner join studentstests st on st.testsessionid = ts.id  and st.activeflag is true
    inner join interimstudentreport isr on isr.studentid = st.studentid and isr.testid = st.testid and isr.filepath is not null and isr.generated is true 
    inner join student s on s.id = st.studentid and s.activeflag is true
    where ts.id = #{testSessionId,jdbcType=BIGINT}
    <if test="isTeacher == true"> 
      and st.studentid in (select studentid from rostered_students)
    </if> 
    order by s.legallastname
  </select>
  
    <select id="reportCountByTestsessionAndUser" resultType="Integer">
    <if test="isTeacher == true">  
		with rostered_students as (
			select distinct e.studentid
			from roster r
			join enrollmentsrosters er on r.id = er.rosterid and er.activeflag
			join enrollment e on er.enrollmentid = e.id and r.currentschoolyear =
			e.currentschoolyear and e.activeflag
			where r.teacherid = #{userId,jdbcType=BIGINT}		
			and r.currentschoolyear = #{currentSchoolYear,jdbcType=BIGINT}		
			and e.attendanceschoolid = #{organizationId,jdbcType=BIGINT}			
			)
   </if>
    select count(isr.filepath) from testsession ts
    inner join studentstests st on st.testsessionid = ts.id  and st.activeflag is true
    inner join interimstudentreport isr on isr.studentid = st.studentid and isr.testid = st.testid and isr.filepath is not null and isr.generated is true  
    inner join student s on s.id = st.studentid and s.activeflag is true
    where ts.id = #{testSessionId,jdbcType=BIGINT}
    <if test="isTeacher == true"> 
      and st.studentid in (select studentid from rostered_students)
    </if> 
  </select>
  
    <resultMap id="reportsOrgsMap" type="edu.ku.cete.domain.report.PredictiveReportOrganization">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="assessmentprogramid" jdbcType="BIGINT" property="assessmentProgramId" />
    <result column="testingprogramid" jdbcType="BIGINT" property="testingProgramId" />
    <result column="contentareaid" jdbcType="BIGINT" property="contentAreaId" />
    <result column="gradeid" jdbcType="BIGINT" property="gradeId" />
    <result column="organizationid" jdbcType="BIGINT" property="organizationId" />
    <result column="organizationtypeid" jdbcType="BIGINT" property="organizationTypeId" />
    <result column="reportcycle" jdbcType="VARCHAR" property="reportCycle" />
    <result column="schoolyear" jdbcType="INTEGER" property="schoolYear" />
    <result column="typecode" jdbcType="VARCHAR" property="orgTypeCode" />
    <result column="testid" jdbcType="BIGINT" property="testId" />
    <result column="externaltestid" jdbcType="BIGINT" property="externalTestId" />
  </resultMap>
  
  <select id="selectAllOrgsFromInterimStudentReport" resultMap="reportsOrgsMap">
	select distinct  organizationid, assessmentprogramid, testingprogramid, gradeid, contentareaid, schoolyear, reportcycle, testid, externaltestid, organizationtypeid, typecode from (
		select distinct attendanceschoolid as organizationid, assessmentprogramid, testingprogramid, gradeid, contentareaid, schoolyear, reportcycle,
	     testid, externaltestid,
	     (select organizationtypeid from organization where id = attendanceschoolid),
	     (select typecode  from organizationtype where id = (select organizationtypeid as organizationtypeid from organization where id = attendanceschoolid))
	     from interimstudentreport
	 	 where assessmentprogramid =  #{assessmentProgramId,jdbcType=BIGINT}
	 	 and schoolyear = #{schoolYear,jdbcType=BIGINT}
	 	 	<if test="testingProgramId != null">
	 	 		and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	 	 	</if>
		 	<if test="gradeId != null">
		  		and gradeid = #{gradeId,jdbcType=BIGINT}
		 	</if>
		   	<if test="contentAreaId != null">
		   		and contentareaid =  #{contentAreaId,jdbcType=BIGINT}
		    </if>
		    <if test="reportCycle != null">
		    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
		    </if>
	   	 <!-- union
	   	 select distinct stateid as organizationid, assessmentprogramid, testingprogramid, gradeid, contentareaid, schoolyear, reportcycle,
			testid, externaltestid,
			(select organizationtypeid from organization where id = stateid),
			(select typecode  from organizationtype where id = (select organizationtypeid as organizationtypeid from organization where id = stateid))
			from interimstudentreport
			where assessmentprogramid =  #{assessmentProgramId,jdbcType=BIGINT}
			and schoolyear = #{schoolYear,jdbcType=BIGINT}
			 <if test="testingProgramId != null">
	 	 		and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	 	 	 </if>
		 	 <if test="gradeId != null">
		  		and gradeid = #{gradeId,jdbcType=BIGINT}
		 	 </if>
		   	 <if test="contentAreaId != null">
		   		and contentareaid =  #{contentAreaId,jdbcType=BIGINT}
		     </if>
		     <if test="reportCycle != null">
		    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
		     </if> -->
		 union
			select distinct districtid as organizationid, assessmentprogramid, testingprogramid, gradeid, contentareaid, schoolyear, reportcycle,
			testid, externaltestid,
			(select organizationtypeid from organization where id = districtid),
			(select typecode  from organizationtype where id = (select organizationtypeid as organizationtypeid from organization where id = districtid))
			 from interimstudentreport
			where assessmentprogramid =  #{assessmentProgramId,jdbcType=BIGINT}
			and schoolyear = #{schoolYear,jdbcType=BIGINT}
			  <if test="testingProgramId != null">
	 	 			and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
	 	 	  </if>
		 	  <if test="gradeId != null">
		  			and gradeid = #{gradeId,jdbcType=BIGINT}
		 	  </if>
		   	  <if test="contentAreaId != null">
		   			and contentareaid =  #{contentAreaId,jdbcType=BIGINT}
		      </if>
		      <if test="reportCycle != null">
		    	and reportcycle = #{reportCycle,jdbcType=VARCHAR}
		      </if>
	   ) as org
	   order by organizationid, contentareaid, gradeid
	 <if test="pageSize != null and offset != null">
      LIMIT #{pageSize,jdbcType=INTEGER} OFFSET #{offset,jdbcType=INTEGER}
    </if>
  </select>
  
  <select id="getTestAttemptedStudentCount" resultType="Integer">
 	 select count(*) from interimstudentreport
 	 	where assessmentprogramid =  #{assessmentProgramId,jdbcType=BIGINT}
		and schoolyear = #{schoolYear,jdbcType=BIGINT}
		  <if test="testingProgramId != null">
 	 			and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
 	 	  </if>
	 	  <if test="gradeId != null">
	  			and gradeid = #{gradeId,jdbcType=BIGINT}
	 	  </if>
	   	  <if test="contentAreaId != null">
	   			and contentareaid =  #{contentAreaId,jdbcType=BIGINT}
	      </if>
	      <if test="reportCycle != null">
	    		and reportcycle = #{reportCycle,jdbcType=VARCHAR}
	      </if>
	      <if test="orgTypeCode == 'SCH'">
				and attendanceschoolid = #{organizationId,jdbcType=BIGINT}
		  </if>
		  <if test="orgTypeCode == 'DT'">
				and districtid = #{organizationId,jdbcType=BIGINT}
		  </if>
		  <if test="orgTypeCode == 'ST'">
				and stateid = #{organizationId,jdbcType=BIGINT}
		  </if>
		  <if test="externalTestId != null">
		  		and externaltestid = #{externalTestId,jdbcType=BIGINT}
		  </if>
		  <if test="testsStatusIds != null and testsStatusIds.size > 0">
			  	and studentsteststatus = ANY(ARRAY
				<foreach close="]" collection="testsStatusIds" item="testsStatusId"
					open="[" separator=",">
					#{testsStatusId}
				</foreach>::BIGINT[]
				)
		  </if>			  
  </select>
  
  <select id="getUnAnsweredStudentCount" resultType="Integer">
 	 select count(*) from interimstudentreport
 		where assessmentprogramid =  #{assessmentProgramId,jdbcType=BIGINT}
		and schoolyear = #{schoolYear,jdbcType=BIGINT}
		and respondeditemcount &lt; totalincludeditemcount
		and status is false
		and scorerangedisplayreasonid != (select id from category where categorytypeid=(select id from categorytype where typecode='NO_SCORE_RANGE_REASON') and categorycode='STUDENT_NOT_TESTED')
		 
		  <if test="testingProgramId != null">
 	 			and testingprogramid = #{testingProgramId,jdbcType=BIGINT}
 	 	  </if>
	 	  <if test="gradeId != null">
	  			and gradeid = #{gradeId,jdbcType=BIGINT}
	 	  </if>
	   	  <if test="contentAreaId != null">
	   			and contentareaid =  #{contentAreaId,jdbcType=BIGINT}
	      </if>
	      <if test="reportCycle != null">
	    		and reportcycle = #{reportCycle,jdbcType=VARCHAR}
	      </if>
	      <if test="orgTypeCode == 'SCH'">
				and attendanceschoolid = #{organizationId,jdbcType=BIGINT}
		  </if>
		  <if test="orgTypeCode == 'DT'">
				and districtid = #{organizationId,jdbcType=BIGINT}
		  </if>
		  <if test="orgTypeCode == 'ST'">
				and stateid = #{organizationId,jdbcType=BIGINT}
		  </if>
		  <if test="externalTestId != null">
		  		and externaltestid = #{externalTestId,jdbcType=BIGINT}
		  </if>
		 	  
  </select>    
  
  <select id="getPredictiveReportsByReActivatedTestSessionId" resultMap="BaseResultMap">
  		select isr.id, isr.studentid, isr.enrollmentid, isr.gradeid, isr.contentareaid, isr.attendanceschoolid, isr.schoolyear, isr.reportcycle, isr.testid, isr.operationaltestwindowid, isr.filepath from interimstudentreport isr 
  			join testsession ts on isr.operationaltestwindowid = ts.operationaltestwindowid
			where ts.id = #{testSessionId,jdbcType=BIGINT}
			<if test="studentIds != null and studentIds.size > 0">
				and isr.studentid = ANY(ARRAY
				<foreach close="]" collection="studentIds" item="stdId"
					open="[" separator=",">
					#{stdId}
				</foreach>::BIGINT[]
				)
			</if>
			and isr.testid in (select distinct testid from studentstests st where st.studentid = isr.studentid and st.testsessionid = #{testSessionId,jdbcType=BIGINT} and st.activeflag is true)
  </select>
  
  <delete id="deleteInterimStudentReportById">
    	delete from interimstudentreport where id =  #{Id,jdbcType=BIGINT}
  </delete>
  
 </mapper>