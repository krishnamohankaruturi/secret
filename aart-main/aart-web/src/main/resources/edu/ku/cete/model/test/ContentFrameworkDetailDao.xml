<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.ku.cete.model.test.ContentFrameworkDetailDao">
	<resultMap id="BaseResultMap"
		type="edu.ku.cete.domain.test.ContentFrameworkDetail">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="externalId" property="externalId" jdbcType="BIGINT" />
		<result column="sortOrder" property="sortOrder" jdbcType="BIGINT" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="contentCode" property="contentCode" jdbcType="VARCHAR" />
		<result column="description" property="description" jdbcType="VARCHAR" />
		<result column="comments" property="comments" jdbcType="VARCHAR" />
		<result column="frameworkLevelId" property="frameworkLevelId"
			jdbcType="BIGINT" />
		<result column="contentFrameworkId" property="contentFrameworkId"
			jdbcType="BIGINT" />
		<result column="parentContentFrameworkDetailId" property="parentContentFrameworkDetailId"
			jdbcType="BIGINT" />
		<result column="createDate" property="createDate" jdbcType="TIMESTAMP" />
		<result column="modifiedDate" property="modifiedDate" jdbcType="TIMESTAMP" />
		<result column="originationCode" property="originationCode"
			jdbcType="VARCHAR" />
	</resultMap>
	<sql id="Example_Where_Clause">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		<where>
			<foreach collection="oredCriteria" item="criteria" separator="or">
				<if test="criteria.valid">
					<trim prefix="(" suffix=")" prefixOverrides="and">
						<foreach collection="criteria.criteria" item="criterion">
							<choose>
								<when test="criterion.noValue">
									and ${criterion.condition}
								</when>
								<when test="criterion.singleValue">
									and ${criterion.condition} #{criterion.value}
								</when>
								<when test="criterion.betweenValue">
									and ${criterion.condition} #{criterion.value} and
									#{criterion.secondValue}
								</when>
								<when test="criterion.listValue">
									and ${criterion.condition}
									<foreach collection="criterion.value" item="listItem"
										open="(" close=")" separator=",">
										#{listItem}
									</foreach>
								</when>
							</choose>
						</foreach>
					</trim>
				</if>
			</foreach>
		</where>
	</sql>
	<sql id="Update_By_Example_Where_Clause">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		<where>
			<foreach collection="example.oredCriteria" item="criteria"
				separator="or">
				<if test="criteria.valid">
					<trim prefix="(" suffix=")" prefixOverrides="and">
						<foreach collection="criteria.criteria" item="criterion">
							<choose>
								<when test="criterion.noValue">
									and ${criterion.condition}
								</when>
								<when test="criterion.singleValue">
									and ${criterion.condition} #{criterion.value}
								</when>
								<when test="criterion.betweenValue">
									and ${criterion.condition} #{criterion.value} and
									#{criterion.secondValue}
								</when>
								<when test="criterion.listValue">
									and ${criterion.condition}
									<foreach collection="criterion.value" item="listItem"
										open="(" close=")" separator=",">
										#{listItem}
									</foreach>
								</when>
							</choose>
						</foreach>
					</trim>
				</if>
			</foreach>
		</where>
	</sql>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		id, externalId, sortOrder, name, contentCode, description, comments,
		frameworkLevelId,
		contentFrameworkId, parentContentFrameworkDetailId, createDate, modifiedDate,
		originationCode
	</sql>
	<select id="selectByExample" resultMap="BaseResultMap"
		parameterType="edu.ku.cete.domain.test.ContentFrameworkDetailExample">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		select
		<if test="distinct">
			distinct
		</if>
		<include refid="Base_Column_List" />
		from public.contentframeworkdetail
		<if test="_parameter != null">
			<include refid="Example_Where_Clause" />
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		select
		<include refid="Base_Column_List" />
		from public.contentframeworkdetail
		where id = #{id,jdbcType=BIGINT}
	</select>
	<select id="selectAll" resultMap="BaseResultMap">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		select
		<include refid="Base_Column_List" />
		from public.contentframeworkdetail
	</select>
	<select id="selectAllInterim" resultMap="BaseResultMap">
	select DISTINCT ON (cfd.contentCode) cfd.contentCode, cfd.id,
	cfd.externalId, cfd.sortOrder, cfd.name, cfd.description, cfd.comments,
	cfd.frameworkLevelId,
	cfd.contentFrameworkId, cfd.parentContentFrameworkDetailId, cfd.createDate, cfd.modifiedDate,
	cfd.originationCode
	from test t
	<if test="isInterim==true">
	JOIN interimtest it on it.testtestid=t.id and it.currentschoolyear = #{schoolYear}
	</if>
	INNER JOIN testcollectionstests tct on t.id = tct.testid
	INNER JOIN testspecstatementofpurpose tstop on t.testspecificationid=tstop.testspecificationid
	INNER JOIN category ct on ct.id=tstop.statementofpurposeid
	INNER JOIN assessmentstestcollections atc on atc.testcollectionid=tct.testcollectionid
	INNER JOIN assessment a on a.id=atc.assessmentid
	INNER JOIN testingprogram tp on tp.id=a.testingprogramid
	INNER JOIN assessmentprogram ap on tp.assessmentprogramid=ap.id
	INNER JOIN category c on c.id=t.status
	INNER JOIN categorytype cct on c.categorytypeid = cct.id and
	c.categorycode='DEPLOYED' and cct.typecode='TESTSTATUS'
	INNER JOIN contentarea ca on t.contentareaid = ca.id
	INNER JOIN gradecourse gc on t.gradecourseid = gc.id
	LEFT OUTER JOIN testsection ts on t.id=ts.testid
	LEFT OUTER JOIN testsectionstaskvariants tstv on ts.id=tstv.testsectionid
	INNER JOIN taskvariantcontentframeworkdetail tvcfd on tvcfd.taskvariantid=tstv.taskvariantid
	INNER JOIN contentframeworkdetail cfd on tvcfd.contentframeworkdetailid=cfd.id
	where
	cfd.activeflag is true and
	c.categorycode='DEPLOYED' and cct.typecode='TESTSTATUS'
	and tstop.activeflag is true and t.qccomplete is true and c.activeflag is
	true and ct.activeflag is true
	and tp.programname ilike 'interim' and ap.id = #{assessmentProgramId} and
	t.activeflag is true and 
	t.is_interim_test=#{isInterim} 
	<if test="contentAreaId!=null">
		and t.contentareaid=#{contentAreaId,jdbcType=BIGINT}
	</if>
	<if test="gradeCourseId!=null">
		and t.gradecourseid=#{gradeCourseId,jdbcType=BIGINT}
	</if>
	<if test="purposeId!=null">
	and ct.id=#{purposeId,jdbcType=BIGINT}
	</if>
	<if test="isInterim==true">
		<if test="organizationId != null">
			and it.organizationid in (
		select id from organization_children((SELECT op.id
		from organization_parent(#{organizationId}) op
		inner join organizationtype ot ON op.organizationtypeid=ot.id
		where ot.typecode='DT'
		union
		select o.id from organization o
		inner join organizationtype ot ON o.organizationtypeid=ot.id
		where ot.typecode='DT' and o.id=#{organizationId})) oc
		union select distinct districtid from organizationtreedetail where schoolid=#{organizationId}
        union select o.id from organization o
		inner join organizationtype ot ON o.organizationtypeid=ot.id
		where ot.typecode='DT' and o.id=#{organizationId}) oc
			union
			select o.id from organization o
			inner join organizationtype ot ON
			o.organizationtypeid=ot.id
			where ot.typecode='DT' and
			o.id=#{organizationId})
		</if>
	</if>
	ORDER BY cfd.contentCode asc
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		delete from public.contentframeworkdetail
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<delete id="deleteByExample"
		parameterType="edu.ku.cete.domain.test.ContentFrameworkDetailExample">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		delete from public.contentframeworkdetail
		<if test="_parameter != null">
			<include refid="Example_Where_Clause" />
		</if>
	</delete>
	<insert id="insert" parameterType="edu.ku.cete.domain.test.ContentFrameworkDetail"
		useGeneratedKeys="true" keyColumn="id" keyProperty="id">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		insert into public.contentframeworkdetail (externalId, sortOrder,
		name, contentCode, description,
		comments, frameworkLevelId, contentFrameworkId,
		parentContentFrameworkDetailId, createDate,
		modifiedDate, originationCode)
		values (#{externalId,jdbcType=BIGINT}, #{sortOrder,jdbcType=BIGINT},
		#{name,jdbcType=VARCHAR}, #{contentCode,jdbcType=VARCHAR},
		#{description,jdbcType=VARCHAR},
		#{comments,jdbcType=VARCHAR}, #{frameworkLevelId,jdbcType=BIGINT},
		#{contentFrameworkId,jdbcType=BIGINT},
		#{parentContentFrameworkDetailId,jdbcType=BIGINT},
		#{createDate,jdbcType=TIMESTAMP},
		#{modifiedDate,jdbcType=TIMESTAMP}, #{originationCode,jdbcType=VARCHAR})
	</insert>
	<insert id="insertSelective" parameterType="edu.ku.cete.domain.test.ContentFrameworkDetail"
		useGeneratedKeys="true" keyColumn="id" keyProperty="id">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		insert into public.contentframeworkdetail
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="externalId != null">
				externalId,
			</if>
			<if test="sortOrder != null">
				sortOrder,
			</if>
			<if test="name != null">
				name,
			</if>
			<if test="contentCode != null">
				contentCode,
			</if>
			<if test="description != null">
				description,
			</if>
			<if test="comments != null">
				comments,
			</if>
			<if test="frameworkLevelId != null">
				frameworkLevelId,
			</if>
			<if test="contentFrameworkId != null">
				contentFrameworkId,
			</if>
			<if test="parentContentFrameworkDetailId != null">
				parentContentFrameworkDetailId,
			</if>
			<if test="createDate != null">
				createDate,
			</if>
			<if test="modifiedDate != null">
				modifiedDate,
			</if>
			<if test="originationCode != null">
				originationCode,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="externalId != null">
				#{externalId,jdbcType=BIGINT},
			</if>
			<if test="sortOrder != null">
				#{sortOrder,jdbcType=BIGINT},
			</if>
			<if test="name != null">
				#{name,jdbcType=VARCHAR},
			</if>
			<if test="contentCode != null">
				#{contentCode,jdbcType=VARCHAR},
			</if>
			<if test="description != null">
				#{description,jdbcType=VARCHAR},
			</if>
			<if test="comments != null">
				#{comments,jdbcType=VARCHAR},
			</if>
			<if test="frameworkLevelId != null">
				#{frameworkLevelId,jdbcType=BIGINT},
			</if>
			<if test="contentFrameworkId != null">
				#{contentFrameworkId,jdbcType=BIGINT},
			</if>
			<if test="parentContentFrameworkDetailId != null">
				#{parentContentFrameworkDetailId,jdbcType=BIGINT},
			</if>
			<if test="createDate != null">
				#{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="modifiedDate != null">
				#{modifiedDate,jdbcType=TIMESTAMP},
			</if>
			<if test="originationCode != null">
				#{originationCode,jdbcType=VARCHAR},
			</if>
		</trim>
	</insert>
	<select id="countByExample"
		parameterType="edu.ku.cete.domain.test.ContentFrameworkDetailExample"
		resultType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		select count(*) from public.contentframeworkdetail
		<if test="_parameter != null">
			<include refid="Example_Where_Clause" />
		</if>
	</select>
	<update id="updateByExampleSelective" parameterType="map">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		update public.contentframeworkdetail
		<set>
			<if test="record.id != null">
				id = #{record.id,jdbcType=BIGINT},
			</if>
			<if test="record.externalId != null">
				externalId = #{record.externalId,jdbcType=BIGINT},
			</if>
			<if test="record.sortOrder != null">
				sortOrder = #{record.sortOrder,jdbcType=BIGINT},
			</if>
			<if test="record.name != null">
				name = #{record.name,jdbcType=VARCHAR},
			</if>
			<if test="record.contentCode != null">
				contentCode = #{record.contentCode,jdbcType=VARCHAR},
			</if>
			<if test="record.description != null">
				description = #{record.description,jdbcType=VARCHAR},
			</if>
			<if test="record.comments != null">
				comments = #{record.comments,jdbcType=VARCHAR},
			</if>
			<if test="record.frameworkLevelId != null">
				frameworkLevelId = #{record.frameworkLevelId,jdbcType=BIGINT},
			</if>
			<if test="record.contentFrameworkId != null">
				contentFrameworkId = #{record.contentFrameworkId,jdbcType=BIGINT},
			</if>
			<if test="record.parentContentFrameworkDetailId != null">
				parentContentFrameworkDetailId =
				#{record.parentContentFrameworkDetailId,jdbcType=BIGINT},
			</if>
			<if test="record.createDate != null">
				createDate = #{record.createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="record.modifiedDate != null">
				modifiedDate = #{record.modifiedDate,jdbcType=TIMESTAMP},
			</if>
			<if test="record.originationCode != null">
				originationCode = #{record.originationCode,jdbcType=VARCHAR},
			</if>
		</set>
		<if test="_parameter != null">
			<include refid="Update_By_Example_Where_Clause" />
		</if>
	</update>
	<update id="updateByExample" parameterType="map">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		update public.contentframeworkdetail
		set id = #{record.id,jdbcType=BIGINT},
		externalId = #{record.externalId,jdbcType=BIGINT},
		sortOrder = #{record.sortOrder,jdbcType=BIGINT},
		name = #{record.name,jdbcType=VARCHAR},
		contentCode = #{record.contentCode,jdbcType=VARCHAR},
		description = #{record.description,jdbcType=VARCHAR},
		comments = #{record.comments,jdbcType=VARCHAR},
		frameworkLevelId = #{record.frameworkLevelId,jdbcType=BIGINT},
		contentFrameworkId = #{record.contentFrameworkId,jdbcType=BIGINT},
		parentContentFrameworkDetailId =
		#{record.parentContentFrameworkDetailId,jdbcType=BIGINT},
		createDate = #{record.createDate,jdbcType=TIMESTAMP},
		modifiedDate = #{record.modifiedDate,jdbcType=TIMESTAMP},
		originationCode = #{record.originationCode,jdbcType=VARCHAR}
		<if test="_parameter != null">
			<include refid="Update_By_Example_Where_Clause" />
		</if>
	</update>
	<update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.test.ContentFrameworkDetail">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		update public.contentframeworkdetail
		<set>
			<if test="externalId != null">
				externalId = #{externalId,jdbcType=BIGINT},
			</if>
			<if test="sortOrder != null">
				sortOrder = #{sortOrder,jdbcType=BIGINT},
			</if>
			<if test="name != null">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="contentCode != null">
				contentCode = #{contentCode,jdbcType=VARCHAR},
			</if>
			<if test="description != null">
				description = #{description,jdbcType=VARCHAR},
			</if>
			<if test="comments != null">
				comments = #{comments,jdbcType=VARCHAR},
			</if>
			<if test="frameworkLevelId != null">
				frameworkLevelId = #{frameworkLevelId,jdbcType=BIGINT},
			</if>
			<if test="contentFrameworkId != null">
				contentFrameworkId = #{contentFrameworkId,jdbcType=BIGINT},
			</if>
			<if test="parentContentFrameworkDetailId != null">
				parentContentFrameworkDetailId =
				#{parentContentFrameworkDetailId,jdbcType=BIGINT},
			</if>
			<if test="createDate != null">
				createDate = #{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="modifiedDate != null">
				modifiedDate = #{modifiedDate,jdbcType=TIMESTAMP},
			</if>
			<if test="originationCode != null">
				originationCode = #{originationCode,jdbcType=VARCHAR},
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.test.ContentFrameworkDetail">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Oct 25 
			18:12:59 CDT 2012. -->
		update public.contentframeworkdetail
		set externalId = #{externalId,jdbcType=BIGINT},
		sortOrder = #{sortOrder,jdbcType=BIGINT},
		name = #{name,jdbcType=VARCHAR},
		contentCode = #{contentCode,jdbcType=VARCHAR},
		description = #{description,jdbcType=VARCHAR},
		comments = #{comments,jdbcType=VARCHAR},
		frameworkLevelId = #{frameworkLevelId,jdbcType=BIGINT},
		contentFrameworkId = #{contentFrameworkId,jdbcType=BIGINT},
		parentContentFrameworkDetailId =
		#{parentContentFrameworkDetailId,jdbcType=BIGINT},
		createDate = #{createDate,jdbcType=TIMESTAMP},
		modifiedDate = #{modifiedDate,jdbcType=TIMESTAMP},
		originationCode = #{originationCode,jdbcType=VARCHAR}
		where id = #{id,jdbcType=BIGINT}
	</update>
	<resultMap id="eeConcepAndClaimDetailMap"
		type="edu.ku.cete.domain.test.EEConceptualAndClaimDetailsDTO">
		<result column="eeCode" property="eeConetnetCode" jdbcType="VARCHAR" />
		<result column="eedescription" property="eeDescription"
			jdbcType="VARCHAR" />
		<result column="conceptualCode" property="conceptualCodeForLM"
			jdbcType="VARCHAR" />
		<result column="conceptualdescription" property="conceptualDescriptionForLM"
			jdbcType="VARCHAR" />
		<result column="claimCode" property="claimCodeForLM" jdbcType="VARCHAR" />
		<result column="claimDescription" property="claimDescriptionForLM"
			jdbcType="VARCHAR" />
	</resultMap>
	<select id="getClaimConceptualAreasForSelectedEE" resultMap="eeConcepAndClaimDetailMap">
		SELECT cfd.contentcode AS eeCode,
		cfd.description AS eedescription,
		concepcfd.contentcode AS conceptualCode,
		concepcfd.description AS conceptualdescription,
		claimcfd.contentcode AS claimCode,
		claimcfd.description AS claimDescription
		FROM contentframeworkdetail cfd
		INNER JOIN contentframeworkdetail concepcfd ON concepcfd.id =
		cfd.parentcontentframeworkdetailid
		INNER JOIN contentframeworkdetail claimcfd ON claimcfd.id =
		concepcfd.parentcontentframeworkdetailid
		WHERE cfd.id = #{contentCodeId}
	</select>
	
	<resultMap id="BlueprintCoverageReportCriteriaEEDTOMap" type="edu.ku.cete.web.BlueprintCriteriaAndEEDTO">
	  <id column="criteria" property="criteria" jdbcType="BIGINT" />
	  <result column="criteriatext" property="criteriaText" jdbcType="VARCHAR" />
	  <collection property="ees" column="criteria" javaType="ArrayList" ofType="edu.ku.cete.domain.test.EEConceptualAndClaimDetailsDTO">
	    <result column="eeCode" property="eeConetnetCode" jdbcType="VARCHAR" />
		<result column="eedescription" property="eeDescription" jdbcType="VARCHAR" />
		<result column="conceptualCode" property="conceptualCodeForLM" jdbcType="VARCHAR" />
		<result column="conceptualdescription" property="conceptualDescriptionForLM" jdbcType="VARCHAR" />
		<result column="claimCode" property="claimCodeForLM" jdbcType="VARCHAR" />
		<result column="claimDescription" property="claimDescriptionForLM" jdbcType="VARCHAR" />
	  </collection>
	</resultMap>
	
	<select id="selectCriteriaAndEEsInBlueprintBySubjectAndGrade" resultMap="BlueprintCoverageReportCriteriaEEDTOMap">
	  SELECT DISTINCT bp.criteria, bpcd.criteriatext, cfd.contentcode AS eeCode, cfd.description AS eedescription, concepcfd.contentcode AS conceptualCode,
	    concepcfd.description AS conceptualdescription, claimcfd.contentcode AS claimCode, claimcfd.description AS claimDescription
	  FROM contentframeworkdetail cfd
	  INNER JOIN blueprintessentialelements bpee ON cfd.id = bpee.essentialelementid
	  INNER JOIN blueprint bp ON bpee.blueprintid = bp.id
	  INNER JOIN blueprintcriteriadescription bpcd
	    ON bp.contentareaid = bpcd.contentareaid
	    AND bp.gradecourseid = bpcd.gradecourseid
	    AND bp.criteria = bpcd.criteria
	  INNER JOIN contentframeworkdetail concepcfd ON concepcfd.id = cfd.parentcontentframeworkdetailid
	  INNER JOIN contentframeworkdetail claimcfd ON claimcfd.id = concepcfd.parentcontentframeworkdetailid
	  WHERE bp.activeflag = TRUE
	  AND bp.contentareaid = #{contentAreaId,jdbcType=BIGINT}
	  AND bp.gradecourseid in (select id from gradecourse where abbreviatedname = #{gradeCourseAbbr,jdbcType=VARCHAR})
	  ORDER BY bp.criteria, claimcfd.contentcode, concepcfd.contentcode, cfd.contentcode
	</select>
	
	<select id="selectFrameWorkTypeForAssessmentProgram" resultType="java.lang.Long">
   select id from frameworktype where assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} and upper(typecode) = upper(#{frameworkCode,jdbcType=VARCHAR})
  </select>
  
   <select id="selectContentFrameworkCodeWithLevelAssessmentGradeContentarea" resultType="java.lang.Long">
	select cfw.id from 
	contentframeworkdetail cfd 
	join contentframework cfw on cfw.id = cfd.contentframeworkid
	join frameworklevel fwl on fwl.id = cfd.frameworklevelid 
	where 
	cfw.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT} and 
	cfw.contentareaid = #{contentAreaId,jdbcType=BIGINT} and 
	<if test="frameworkTypeIds != null" >
		cfw.frameworktypeid in  
		<foreach collection="frameworkTypeIds" item="frameworkTypeId" open="(" close=")" separator="," >
			#{frameworkTypeId,jdbcType=BIGINT}
		</foreach>
		and 
	</if>
	upper(fwl.title) = upper(#{levelTitle,jdbcType=VARCHAR}) and 
	upper(cfd.contentcode) = upper(#{contentCode,jdbcType=VARCHAR})
	limit 1
  </select>
  
  <resultMap id="IAPCF" type="edu.ku.cete.web.IAPContentFramework">
    <id column="criteria" property="criteria" jdbcType="INTEGER" />
    <id column="claimid" property="claimId" jdbcType="BIGINT" />
    <id column="conceptualareaid" property="conceptualAreaId" jdbcType="BIGINT" />
    <id column="eeid" property="eeId" jdbcType="BIGINT" />
    <result column="writingtestlet" property="isWritingTestlet" jdbcType="BIT" />
    <result column="criteriatext" property="criteriaText" jdbcType="VARCHAR" />
    <result column="claimcontentcode" property="claimContentCode" jdbcType="VARCHAR" />
    <result column="claimdescription" property="claimDescription" jdbcType="VARCHAR" />
    <result column="conceptualareacontentcode" property="conceptualAreaContentCode" jdbcType="VARCHAR" />
    <result column="conceptualareadescription" property="conceptualAreaDescription" jdbcType="VARCHAR" />
    <association property="ee" javaType="edu.ku.cete.domain.test.ContentFrameworkDetail">
      <result column="eeid" property="id" jdbcType="BIGINT" />
      <result column="eecontentcode" property="contentCode" jdbcType="VARCHAR" />
      <result column="eedescription" property="description" jdbcType="VARCHAR" />
    </association>
    <!--
    <collection column="claimid" property="children" javaType="ArrayList" ofType="edu.ku.cete.domain.test.ContentFrameworkDetail">
      <id column="conceptualareaid"
    </collection>
    -->
  </resultMap>
  
  <select id="getIAPContentFrameworkForWindow" parameterType="map" resultMap="IAPCF">
    WITH RECURSIVE contentareas as (
        select *
        from contentarea
        where abbreviatedname = #{contentAreaAbbreviatedName,jdbcType=VARCHAR}
    ),
    grades as (
        select *
        from gradecourse
        where abbreviatedname = #{gradeCourseAbbreviatedName,jdbcType=VARCHAR}
    ),
    gradebands as (
        select gb.*
        from gradecourse gc
        join gradebandgradecourse gbgc on gc.id = gbgc.gradecourseid
        join gradeband gb on gbgc.gradebandid = gb.id
        where gc.abbreviatedname = #{gradeCourseAbbreviatedName,jdbcType=VARCHAR}
    ),
    cftree_tmp (
        contentframeworkdetailid,
        contentcode,
        description,
        parentcontentframeworkdetailid,
        frameworkleveltitle,
        frameworklevel,
        contentareaid,
        contentareaname,
        gradeid,
        grade,
        sortorder
    ) as (
        select distinct cfd.id, cfd.contentcode, cfd.description, cfd.parentcontentframeworkdetailid, fl.title, fl.level, ca.id, ca.abbreviatedname, gc.id, gc.abbreviatedname, cfd.sortorder
        from operationaltestwindow otw
        join operationaltestwindowstestcollections otwtc on otw.id = otwtc.operationaltestwindowid
        join testcollectionstests tct on otwtc.testcollectionid = tct.testcollectionid
        join test t on tct.testid = t.id and t.status = 64 and t.qccomplete is true
        join testsection ts on t.id = ts.testid
        join testsectionstaskvariants tstv on ts.id = tstv.testsectionid
        join taskvariantcontentframeworkdetail tvcfd on tstv.taskvariantid = tvcfd.taskvariantid
        join contentframeworkdetail cfd on tvcfd.contentframeworkdetailid = cfd.id
        join contentframework cf on cfd.contentframeworkid = cf.id
        join contentareas ca on cf.contentareaid = ca.id
        left join grades gc on cf.gradecourseid = gc.id
        left join gradebands gb on cf.gradebandid = gb.id
        join frameworklevel fl on cfd.frameworklevelid = fl.id
        where otw.id = #{operationalTestWindowId,jdbcType=BIGINT}
        and (gc.id is not null or gb.id is not null)
        union
        select distinct cfd.id, cfd.contentcode, cfd.description, cfd.parentcontentframeworkdetailid, fl.title, fl.level, c.contentareaid, c.contentareaname, c.gradeid, c.grade, cfd.sortorder
        from contentframeworkdetail cfd
        join frameworklevel fl on cfd.frameworklevelid = fl.id
        join cftree_tmp c on cfd.id = c.parentcontentframeworkdetailid
    ),
    cftree (
        contentframeworkdetailid,
        contentcode,
        description,
        parentcontentframeworkdetailid,
        frameworkleveltitle,
        frameworklevel,
        contentareaid,
        contentareaname,
        gradeid,
        grade,
        sortorder,
        claim_contentframeworkdetailid,
        claim_contentcode,
        claim_description,
        conceptualarea_contentframeworkdetailid,
        conceptualarea_contentcode,
        conceptualarea_description
    ) as (
        select
            *,
            case when frameworklevel = 1 then contentframeworkdetailid else null::bigint end as claim_contentframeworkdetailid,
            case when frameworklevel = 1 then contentcode else null::text end as claim_contentcode,
            case when frameworklevel = 1 then description else null::text end as claim_description,
            null::bigint as conceptualarea_contentframeworkdetailid,
            null::text as conceptualarea_contentcode,
            null::text as conceptualarea_description
        from cftree_tmp
        where (parentcontentframeworkdetailid is null or parentcontentframeworkdetailid = 0)
        union
        select
            child.*,
            case
                when parent.claim_contentframeworkdetailid is null and child.frameworklevel = 1
                    then child.contentframeworkdetailid
                else parent.claim_contentframeworkdetailid
            end as claim_contentframeworkdetailid,
            case
                when parent.claim_contentcode is null and child.frameworklevel = 1
                    then child.contentcode
                else parent.claim_contentcode
            end as claim_contentcode,
            case
                when parent.claim_description is null and child.frameworklevel = 1
                    then child.description
                else parent.claim_description
            end as claim_description,
            case
                when parent.conceptualarea_contentframeworkdetailid is null and child.frameworklevel = 2
                    then child.contentframeworkdetailid
                else parent.conceptualarea_contentframeworkdetailid
            end as conceptualarea_contentframeworkdetailid,
            case
                when parent.conceptualarea_contentcode is null and child.frameworklevel = 2
                    then child.contentcode
                else parent.conceptualarea_contentcode
            end as conceptualarea_contentcode,
            case
                when parent.conceptualarea_description is null and child.frameworklevel = 2
                    then child.description
                else parent.conceptualarea_description
            end as conceptualarea_description
        from cftree parent
        join cftree_tmp child on parent.contentframeworkdetailid = child.parentcontentframeworkdetailid
    ),
    blueprintees as (
        select bp.*, bpee.*, bpcd.criteriatext
        from blueprint bp
        join blueprintessentialelements bpee on bp.id = bpee.blueprintid
        join contentareas ca on bp.contentareaid = ca.id
        join grades gc on bp.gradecourseid = gc.id <!-- this join is okay to be non-left, because EEs in the blueprint are not grade banded -->
        left join blueprintcriteriadescription bpcd
            on bp.contentareaid = bpcd.contentareaid
            and bp.gradecourseid = bpcd.gradecourseid
            and bp.criteria = bpcd.criteria
    )
    select distinct
        bpee.criteria,
        bpee.criteriatext,
        bpee.writingtestlet,
        cftree.claim_contentframeworkdetailid as claimid,
        cftree.claim_contentcode as claimcontentcode,
        cftree.claim_description as claimdescription,
        cftree.conceptualarea_contentframeworkdetailid as conceptualareaid,
        cftree.conceptualarea_contentcode as conceptualareacontentcode,
        cftree.conceptualarea_description as conceptualareadescription,
        cftree.contentframeworkdetailid as eeid,
        cftree.contentcode as eecontentcode,
        cftree.description as eedescription,
        cftree.sortorder
    from cftree
    left join blueprintees bpee on cftree.contentframeworkdetailid = bpee.essentialelementid
    where cftree.frameworkleveltitle ilike 'essential element'
    order by
      bpee.criteria nulls last,
      cftree.claim_contentframeworkdetailid, cftree.conceptualarea_contentframeworkdetailid, cftree.sortorder, cftree.contentcode
  </select>
</mapper>