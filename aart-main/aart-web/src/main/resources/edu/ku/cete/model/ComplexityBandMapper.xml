<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.ku.cete.model.ComplexityBandMapper" >
  <resultMap id="BaseResultMap" type="edu.ku.cete.domain.ComplexityBand" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 17 22:08:25 CST 2014.
    -->
    
    <!-- Changed the id column to a result column due to multiple rows having the same id
    this was causing rows to be excluded from the resultset.  MyBatis must enforce
    uniqueness in it's code when it is an id column.  This change now allows multiple
    Emergent and Conventional rows with the same id (728 and 729) to be returned. -->
    
    <result column="id" property="id" jdbcType="BIGINT" />
    <result column="bandname" property="bandName" jdbcType="VARCHAR" />
    <result column="bandcode" property="bandCode" jdbcType="VARCHAR" />
    <result column="minrange" property="minRange" jdbcType="DOUBLE" />
    <result column="maxrange" property="maxRange" jdbcType="DOUBLE" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 17 22:08:25 CST 2014.
    -->
    id, bandname, bandcode, minrange, maxrange
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 17 22:08:25 CST 2014.
    -->
    select 
    <include refid="Base_Column_List" />
    from complexityband
    where id = #{id,jdbcType=BIGINT}
  </select>
  <insert id="insert" parameterType="edu.ku.cete.domain.ComplexityBand" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 17 22:08:25 CST 2014.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('complexityband_id_seq')
    </selectKey>
    insert into complexityband (id, bandname, bandcode, 
      minrange, maxrange)
    values (#{id,jdbcType=BIGINT}, #{bandName,jdbcType=VARCHAR}, #{bandCode,jdbcType=VARCHAR}, 
      #{minRange,jdbcType=DOUBLE}, #{maxRange,jdbcType=DOUBLE})
  </insert>
  <insert id="insertSelective" parameterType="edu.ku.cete.domain.ComplexityBand" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 17 22:08:25 CST 2014.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="id" order="BEFORE" >
      SELECT nextval('complexityband_id_seq')
    </selectKey>
    insert into complexityband
    <trim prefix="(" suffix=")" suffixOverrides="," >
      id,
      <if test="bandName != null" >
        bandname,
      </if>
      <if test="bandCode != null" >
        bandcode,
      </if>
      <if test="minRange != null" >
        minrange,
      </if>
      <if test="maxRange != null" >
        maxrange,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      #{id,jdbcType=BIGINT},
      <if test="bandName != null" >
        #{bandName,jdbcType=VARCHAR},
      </if>
      <if test="bandCode != null" >
        #{bandCode,jdbcType=VARCHAR},
      </if>
      <if test="minRange != null" >
        #{minRange,jdbcType=DOUBLE},
      </if>
      <if test="maxRange != null" >
        #{maxRange,jdbcType=DOUBLE},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="edu.ku.cete.domain.ComplexityBand" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 17 22:08:25 CST 2014.
    -->
    update complexityband
    <set >
      <if test="bandName != null" >
        bandname = #{bandName,jdbcType=VARCHAR},
      </if>
      <if test="bandCode != null" >
        bandcode = #{bandCode,jdbcType=VARCHAR},
      </if>
      <if test="minRange != null" >
        minrange = #{minRange,jdbcType=DOUBLE},
      </if>
      <if test="maxRange != null" >
        maxrange = #{maxRange,jdbcType=DOUBLE},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="edu.ku.cete.domain.ComplexityBand" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 17 22:08:25 CST 2014.
    -->
    update complexityband
    set bandname = #{bandName,jdbcType=VARCHAR},
      bandcode = #{bandCode,jdbcType=VARCHAR},
      minrange = #{minRange,jdbcType=DOUBLE},
      maxrange = #{maxRange,jdbcType=DOUBLE}
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <resultMap id="ExtendedResultMap"  extends="BaseResultMap" type="edu.ku.cete.domain.ComplexityBand">
    <result column="contentareaid" property="contentAreaId" jdbcType="BIGINT" />
    <result column="contentAreaCode" property="contentAreaCode" jdbcType="VARCHAR" />
    <result column="assessmentprogramid" property="assessmentProgramId" jdbcType="BIGINT"/>
    <result column="gradebandid" property="gradeBandId" jdbcType="BIGINT"/>
    <association property="linkageLevel" javaType="edu.ku.cete.domain.common.Category">
        <id property="id" column="categoryid" jdbcType="BIGINT"/>
        <result property="categoryName" column="categoryname" jdbcType="VARCHAR"/>  
        <result property="categoryCode" column="categorycode" jdbcType="VARCHAR"/>            
    </association>
  </resultMap>
  
  <select id="selectNullContentAreaWithLinkageLevelInfo" resultMap="ExtendedResultMap">
    select 
     cb.id, cb.bandname, cb.bandcode, cb.minrange, cb.maxrange, cb.contentareaid,
    c.id as categoryid,c.categoryname,c.categorycode
    from complexityband cb 
		inner join essentialelementlinkagetranslationvalues eel
			on cb.bandcode = CAST( eel.translationvalue AS text )
		inner join category c on eel.categoryid=c.id 
		where cb.contentareaid is null
	order by cb.bandcode
  </select>
  
   <select id="selectAllWithLinkageLevelInfo" resultMap="ExtendedResultMap">
    select 
     cb.id, cb.bandname, cb.bandcode, cb.minrange, cb.maxrange, cb.contentareaid,  ca.abbreviatedname as contentareacode,
    c.id as categoryid,c.categoryname,c.categorycode,cb.assessmentprogramid
    from complexityband cb 
		inner join essentialelementlinkagetranslationvalues eel
			on cb.bandcode = CAST( eel.translationvalue AS text )
		inner join category c on eel.categoryid=c.id
		left join contentarea ca on ca.id = cb.contentareaid
		where cb.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
	order by cb.bandcode
  </select>
  
  <select id="getAllBandsWithLinkageLevelInfoByAssessmentProgramIdContentAreaId" resultMap="ExtendedResultMap">
    SELECT cat.id, 
    	cb.bandname, 
    	cb.bandcode, 
    	cb.minrange, 
    	cb.maxrange, 
    	cb.contentareaid,  
    	ca.abbreviatedname as contentareacode,
    	c.id as categoryid,
    	c.categoryname,
    	c.categorycode,
    	cb.assessmentprogramid
    FROM complexityband cb 
		JOIN essentialelementlinkagetranslationvalues eel ON cb.bandcode = CAST( eel.translationvalue AS text )
		JOIN category c ON eel.categoryid = c.id
		JOIN contentarea ca ON ca.id = cb.contentareaid
		JOIN category cat ON cat.categorycode = cb.bandname
		WHERE cb.assessmentprogramid = #{assessmentProgramId,jdbcType=BIGINT}
		<if test="contentAreaId != null">
			AND cb.contentareaid = #{contentAreaId,jdbcType=BIGINT}
		</if>		
		AND ca.activeflag is true
		AND cat.activeflag is true
		AND c.activeflag is true
	order by cb.bandcode
  </select>
  
  <resultMap id="ExtendedResultMapWithoutLinkageLevel" extends="BaseResultMap" type="edu.ku.cete.domain.ComplexityBand">
    <result column="contentareaid" property="contentAreaId" jdbcType="BIGINT" />
    <result column="contentAreaCode" property="contentAreaCode" jdbcType="VARCHAR" />
    <result column="assessmentprogramid" property="assessmentProgramId" jdbcType="BIGINT"/>
    <result column="gradebandid" property="gradeBandId" jdbcType="BIGINT"/>  
  </resultMap>
  
  <select id="getAll" resultMap="ExtendedResultMapWithoutLinkageLevel">
  	select cb.id,
  	    cb.bandname, 
    	cb.bandcode, 
    	cb.minrange, 
    	cb.maxrange, 
    	cb.contentareaid,  
    	ca.abbreviatedname as contentareacode,
    	cb.assessmentprogramid,
    	cb.gradebandid
  	from complexityband cb
  	left join contentarea ca on cb.contentareaid=ca.id
  </select>
    
  <resultMap id="compBandHistoryResultMap"  type="edu.ku.cete.domain.student.ComplexityBandJson">
  	<id column="studentid" property="studentId" jdbcType="BIGINT" />
    <result column="studentname" property="studentName" jdbcType="VARCHAR" />
    <result column="finalmathband" property="finalMathBand" jdbcType="VARCHAR" />
   	<result column="finalsciband" property="finalSciBand" jdbcType="VARCHAR" />
    <result column="finalelaband" property="finalElaBand" jdbcType="VARCHAR" />
    <result column="commband" property="commBand" jdbcType="VARCHAR" />
    <result column="writingband" property="writingBand" jdbcType="VARCHAR" />
    <result column="surveycreateddate" property="surveyCreatedDate" jdbcType="TIMESTAMP"/>
    <result column="surveycreateduserid" property="surveyCreatedUserId" jdbcType="BIGINT"/> 
    <result column="surveymodifieddate" property="surveyModifiedDate" jdbcType="TIMESTAMP"/>  
    <result column="surveymodifieduserid" property="surveyModifiedUserId" jdbcType="BIGINT"/>        
    <result column="currentschoolyear" property="currentSchoolYear" jdbcType="BIGINT"/>            
            
  </resultMap>
  <select id="getCompBandsForJson" resultMap="compBandHistoryResultMap">
	select distinct stu.id as studentId,(stu.legalfirstname || ',' || stu.legallastname) as studentName,
	  (select categorydescription from category where id = stu.finalmathbandid) as finalMathBand,
	  (select categorydescription from category where id = stu.finalscibandid) as finalSciBand, 
	  (select categorydescription from category where id = stu.finalelabandid) as finalElaBand,
	  (select categorydescription from category where id = stu.commbandid) as commBand,
	  (select categorydescription from category where id = stu.writingbandid) as writingBand,
	  sur.createddate as surveyCreatedDate, sur.createduser as surveyCreatedUserId, sur.modifieddate as surveyModifiedDate,
	  sur.modifieduser as surveyModifiedUserId,en.currentschoolyear as currentSchoolYear
	  from student stu 
	  join survey sur on stu.id = sur.studentid and stu.activeflag is true
	  join enrollment en on en.studentid = stu.id and en.activeflag is true
	  where sur.id = #{surveyId} and en.currentschoolyear = #{currentSchoolYear}
  </select>
  
</mapper>